# 登录逻辑更新说明（前端 H5）

## 后端登录/会话变更（近期）
- 登录成功时，会话必须成功落库，否则接口返回 401（防止“假成功”）。
- API 认证中间件会刷新会话与用户的活跃时间，防止活跃会话被定时任务误删。
- 用户表写入不再用 REPLACE，不会清空已有姓名/班级字段。
- 统计中的新增用户数已按 `created_at` 计算，不再固定为 0。

### 日志规范（后端）
- `INFO`：关键路径成功信息（登录成功、拉取数据成功、缓存命中/未命中、活跃会话刷新）。示例：`登录成功 { studentId }`、`GET /api/grades - 120ms`。
- `WARN`：可疑/需关注但非致命（参数校验失败、会话不存在、成绩解析为空、速率限制触发）。示例：`会话不存在 { token }`、`成绩解析结果为空 { dataListRows, tableCount }`。
- `ERROR`：异常或不可恢复错误（上游接口异常、解析崩溃）。示例：`获取成绩失败 { error }`。
- 避免在 `INFO/WARN` 中输出明文密码/验证码；学号/Token 使用脱敏函数。

### 前端提示策略
- 登录/成绩为空等非致命情况，前端提示用户行为：例如“教务系统未返回成绩，可能未完成评教或当前无成绩数据，请完成评教后重试”。
- 会话过期统一提示“登录已过期，请重新登录”，并保留已记住的账号密码，避免重复输入。
- 上游限制/业务规则（未评教无法查成绩）优先展示明确文案，不模糊成“系统异常”。

## 功能概览
- 默认勾选“记住学号和密码”，登录成功后会在多处持久化凭据。
- 支持静默自动登录：没有 token 时从本地凭据自动重登，成功后直接进入数据页。
- 401 统一处理：业务请求返回 401 时自动重登，成功则重试原请求，失败只弹一次过期提示并回登录卡片。
- 退出登录默认保留已记住的账号/密码，方便再次登录；也支持清除全部凭据。

## 凭据存储策略
- localStorage：主键 `huas_saved_cred` + 备份键 `_bak1`、`_bak2`。
- IndexedDB：`huasCredDB` / `creds` / `primary` 存一份。
- 仅在非静默登录成功时写入，取消勾选或主动清理时会同时删除所有存储。
- 读取顺序：localStorage（按键顺序）→ IndexedDB；找到即可填充表单/用于静默登录。

## 自动登录流程
1) 页面加载：如果存在 `huas_token`，直接加载数据；否则读取本地凭据并尝试静默登录。
2) 静默登录成功：隐藏登录卡片，进入数据页并加载用户/一卡通/课表。
3) 静默登录失败或需验证码：停留在登录卡片，已记住的账号密码仍被填充。

## 退出与清理
- `handleLogout(true)`：只清 token，保留本地凭据，回到登录页会自动回填。
- `handleLogout(false)`：清 token 并清理 localStorage/IndexedDB 所有凭据。

## 风险提示
- 学号/密码以明文多份存储在浏览器（localStorage + IndexedDB），存在泄露风险（XSS、借用设备等）。仅在可信环境使用。

## 建议测试
1) 首次登录（默认勾选记住）后刷新页面，应自动进入数据页。
2) 删除 `huas_token` 后刷新，应静默自动登录；如后端要求验证码则停留登录页。
3) 删除 `huas_saved_cred` 主键后刷新，仍应填充（使用备份）；删除所有 localStorage 备份但保留 IndexedDB 后仍可填充。
4) 取消勾选“记住…”后登录，确认 localStorage/IndexedDB 无凭据；刷新应停留登录页。
5) 业务请求返回 401（手动清 token 并调用刷新课表等），应自动重登并重试，失败时只弹一次“登录已过期”。*** End Patch\""}##
