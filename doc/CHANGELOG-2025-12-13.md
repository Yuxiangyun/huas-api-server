# 2025-12-13 改动整理

## 登录与会话
- 按需验证码：默认隐藏验证码输入，后端判定 `NEED_CAPTCHA` 时才显示并刷新验证码；`AuthApi` 仅在用户输入时提交 `captcha`，并附带 `failN=0` 避免默认触发验证码。
- 会话失效自动重登：接口 401 时自动用本地缓存的学号/密码拉取新会话并静默登录，成功后重试原请求；失败只弹一次过期提示并返回登录卡片。
- 退出行为：仅清除 token，保留已记住的账号/密码，返回登录卡片会自动填充输入框并刷新验证码。
- 验证码判定：仅在 CAS 明确提示“验证码不能为空/错误/失效”等时要求验证码；即便用户已提交验证码也不会陷入循环。

## 前端体验
- 登录流程封装 `performLogin`，支持静默模式（自动重登）与正常模式。
- `handleFetchError` 统一处理 401 并驱动自动重登。
- 日志：前端使用 `[UI]` 前缀输出关键节点（登录响应、需要验证码、自动重登、接口错误等），便于调试；可将 `log` 置为空函数以关闭。
- 记住学号/密码的勾选逻辑生效，退出后自动回填。

## 涉及文件
- `index.html`：登录/自动重登/日志/验证码展示逻辑。
- `src/core/api/AuthApi.ts`：按需提交验证码、`failN=0`、验证码判定。
- `src/core/security.ts`：验证码参数改为可选。
- `src/services/StudentService.ts`、`src/core/HuasClient.ts`、`src/routes/auth.routes.ts`：透传 `needCaptcha`，NEED_CAPTCHA 时返回 action 提示。

## 建议测试
1. 首次登录（勾选“记住学号和密码”）无需验证码。
2. 故意输错密码触发 NEED_CAPTCHA，改为正确密码+验证码应登录成功。
3. 登录后手动让会话失效（控制台调用 `/auth/logout`），再点击刷新课表/一卡通/用户信息，自动重登应成功且无多次弹窗；失败则只提示一次过期并回填账号密码。
4. 退出后返回登录卡片应自动填充已记住的账号/密码并刷新验证码。
