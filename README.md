# é«˜æ ¡æ•™åŠ¡ç³»ç»Ÿ API æœåŠ¡

> åŸºäº Bun + Hono çš„é«˜æ€§èƒ½æ•™åŠ¡ç³»ç»Ÿä¸­é—´ä»¶

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªä¸ºå°ç¨‹åºæä¾›çš„æ•™åŠ¡ç³»ç»Ÿåç«¯æœåŠ¡ï¼Œé€šè¿‡ä»£ç†å­¦æ ¡æ•™åŠ¡ç³»ç»Ÿï¼ˆCAS + æ­£æ–¹/å¼ºæ™ºï¼‰ï¼Œè§£å†³äº†åŸç³»ç»Ÿå­˜åœ¨çš„ Session æœ‰æ•ˆæœŸçŸ­ã€å¹¶å‘é™åˆ¶ã€ç½‘ç»œä¸ç¨³å®šç­‰é—®é¢˜ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ” **æŒä¹…åŒ–ç™»å½•** - Token ä¸å­¦æ ¡ Session è§£ç»‘ï¼Œæ”¯æŒé•¿æœŸç™»å½•
- ğŸš€ **ç¼“å­˜ä¼˜å…ˆ** - é‡‡ç”¨ SWR ç­–ç•¥ï¼Œå¤§å¹…æå‡å“åº”é€Ÿåº¦
- ğŸ“± **å¤šç«¯æ”¯æŒ** - åŒä¸€ç”¨æˆ·å¯åœ¨å¤šè®¾å¤‡ç™»å½•ï¼Œæ•°æ®äº’é€š
- ğŸ§  **æ™ºèƒ½åˆ·æ–°** - å·®å¼‚åŒ–ç¼“å­˜ç­–ç•¥ï¼Œç¬¦åˆå®é™…ä½¿ç”¨åœºæ™¯
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤** - é€Ÿç‡é™åˆ¶ã€SQL æ³¨å…¥é˜²å¾¡ã€XSS é˜²æŠ¤
- ğŸ“Š **æ•°æ®ç»Ÿè®¡** - å®Œå–„çš„ç”¨æˆ·ç»Ÿè®¡å’Œæ•°æ®åˆ†æåŠŸèƒ½

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: [Bun](https://bun.sh/) - æé€Ÿ JavaScript è¿è¡Œæ—¶
- **Web æ¡†æ¶**: [Hono](https://hono.dev/) - è½»é‡çº§é«˜æ€§èƒ½æ¡†æ¶
- **è¯­è¨€**: TypeScript 5.x+
- **æ•°æ®åº“**: SQLite (WAL æ¨¡å¼)
- **HTML è§£æ**: Cheerio
- **Cookie ç®¡ç†**: tough-cookie

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Bun >= 1.0
- Node.js >= 18 (å¯é€‰ï¼Œç”¨äºå…¼å®¹)

### å®‰è£…ä¾èµ–

```bash
bun install
```

### å¼€å‘æ¨¡å¼

```bash
bun run dev
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨

### ç”Ÿäº§æ¨¡å¼

```bash
bun run start
```

## ğŸš€ è„šæœ¬å‘½ä»¤

### å¼€å‘ä¸è¿è¡Œ

```bash
bun run dev          # å¼€å‘æ¨¡å¼ï¼ˆå¸¦çƒ­é‡è½½ï¼‰
bun run start        # ç”Ÿäº§æ¨¡å¼
bun run build        # æ„å»ºé¡¹ç›®
bun run lint         # ç±»å‹æ£€æŸ¥
```

### æµ‹è¯•

```bash
bun run test                # è¿è¡Œæ‰€æœ‰æµ‹è¯•
bun run test:unit           # å•å…ƒæµ‹è¯•
bun run test:integration    # é›†æˆæµ‹è¯•
bun run test:e2e            # ç«¯åˆ°ç«¯æµ‹è¯•
bun run test:security       # å®‰å…¨æµ‹è¯•
bun run test:performance    # æ€§èƒ½æµ‹è¯•
bun run test:coverage       # æµ‹è¯•è¦†ç›–ç‡
bun run test:full           # å®Œæ•´æµç¨‹æµ‹è¯•
```

### æ•°æ®åº“ç®¡ç†

```bash
bun run db:backup    # å¤‡ä»½æ•°æ®åº“
bun run db:clean     # æ¸…ç†è¿‡æœŸæ•°æ®
bun run db:stats     # æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡
bun run db:vacuum    # ä¼˜åŒ–æ•°æ®åº“
```

## ğŸ“š æ–‡æ¡£

- [API æ–‡æ¡£](./doc/API.md) - å®Œæ•´çš„æ¥å£æ–‡æ¡£
- [æ¶æ„è®¾è®¡](./doc/ARCHITECTURE.md) - ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡ç†å¿µ
- [è·¯ç”±æ–‡æ¡£](./doc/ROUTES.md) - è·¯ç”±ç³»ç»Ÿè¯¦è§£
- [æµ‹è¯•æ–‡æ¡£](./TEST.md) - æµ‹è¯•è§„èŒƒå’Œè¦†ç›–

## ğŸŒ API æ¦‚è§ˆ

### è®¤è¯æ¨¡å—

```
GET  /auth/captcha       # è·å–éªŒè¯ç 
POST /auth/login         # ç”¨æˆ·ç™»å½•
POST /auth/logout        # é€€å‡ºç™»å½•
```

### ä¸šåŠ¡æ¨¡å—

```
GET /api/schedule        # è·å–è¯¾è¡¨ï¼ˆæ”¯æŒç¼“å­˜ï¼‰
GET /api/ecard           # è·å–ä¸€å¡é€šï¼ˆå®æ—¶ï¼‰
GET /api/user            # è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ”¯æŒç¼“å­˜ï¼‰
```

### ç³»ç»Ÿæ¨¡å—

```
GET /system/health                  # å¥åº·æ£€æŸ¥
GET /system/stats                   # ç³»ç»Ÿç»Ÿè®¡
GET /system/stats/users             # ç”¨æˆ·ç»Ÿè®¡
GET /system/stats/sessions          # ä¼šè¯ç»Ÿè®¡
GET /system/stats/cache             # ç¼“å­˜ç»Ÿè®¡
GET /system/stats/active-users      # æ´»è·ƒç”¨æˆ·æ’è¡Œ
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
huas-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒå±‚
â”‚   â”‚   â”œâ”€â”€ api/          # å¤–éƒ¨ API å°è£…
â”‚   â”‚   â”œâ”€â”€ handlers/     # å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ middleware/   # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ network/      # ç½‘ç»œå±‚
â”‚   â”‚   â””â”€â”€ utils/        # å·¥å…·ç±»
â”‚   â”œâ”€â”€ db/               # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ SessionRepo.ts    # ä¼šè¯ä»“åº“
â”‚   â”‚   â”œâ”€â”€ CacheRepo.ts      # ç¼“å­˜ä»“åº“
â”‚   â”‚   â”œâ”€â”€ UserRepo.ts       # ç”¨æˆ·ä»“åº“
â”‚   â”‚   â””â”€â”€ StatsRepo.ts      # ç»Ÿè®¡ä»“åº“
â”‚   â”œâ”€â”€ parsers/          # è§£æå™¨å±‚
â”‚   â”œâ”€â”€ routes/           # è·¯ç”±å±‚
â”‚   â”œâ”€â”€ services/         # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ test/             # æµ‹è¯•
â”‚   â””â”€â”€ server.ts         # æœåŠ¡å…¥å£
â”œâ”€â”€ scripts/              # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ db.sh            # æ•°æ®åº“ç®¡ç†
â”‚   â”œâ”€â”€ deploy.sh        # éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ test.sh          # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ doc/                 # æ–‡æ¡£
â””â”€â”€ deploy/              # éƒ¨ç½²é…ç½®
```

## ğŸ”§ é…ç½®

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `.env.example`ï¼‰ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production
CORS_ORIGINS=https://yourdomain.com

# æ•°æ®åº“é…ç½®
DB_PATH=/var/lib/huas-api/huas.sqlite

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_FILE_PATH=/var/log/huas-api/app.log
LOG_ENABLE_CONSOLE=false
LOG_ENABLE_FILE=true

# é€Ÿç‡é™åˆ¶
LOGIN_RATE_LIMIT=10
CAPTCHA_RATE_LIMIT=20
API_RATE_LIMIT=60
```

## ğŸš¢ éƒ¨ç½²

### ä½¿ç”¨ systemdï¼ˆæ¨èï¼‰

1. é¦–æ¬¡å®‰è£…

```bash
sudo ./scripts/deploy.sh install
```

2. éƒ¨ç½²ä»£ç 

```bash
sudo ./scripts/deploy.sh deploy
```

3. å¯åŠ¨æœåŠ¡

```bash
sudo ./scripts/deploy.sh start
```

4. æŸ¥çœ‹çŠ¶æ€

```bash
sudo ./scripts/deploy.sh status
sudo ./scripts/deploy.sh logs
```

### æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. å®‰è£…ä¾èµ–
bun install --production

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env

# 3. å¯åŠ¨æœåŠ¡
bun run start
```

## ğŸ“Š æ•°æ®åº“

### æ•°æ®åº“è®¾è®¡

- **users** - ç”¨æˆ·ä¸»è¡¨ï¼ˆå­¦å·ã€å§“åã€ç­çº§ï¼‰
- **sessions** - ä¼šè¯è¡¨ï¼ˆTokenã€Cookiesã€çŠ¶æ€ï¼‰
- **data_cache** - ç¼“å­˜è¡¨ï¼ˆè¯¾è¡¨ã€ä¸€å¡é€šã€ç”¨æˆ·ä¿¡æ¯ï¼‰

### ç´¢å¼•ä¼˜åŒ–

- `idx_sessions_sid` - åŠ é€Ÿå¤šè®¾å¤‡æŸ¥è¯¢
- `idx_sessions_updated` - åŠ é€Ÿä¼šè¯æ¸…ç†
- `idx_cache_updated` - åŠ é€Ÿç¼“å­˜æ¸…ç†

### ç»´æŠ¤å‘½ä»¤

```bash
# å¤‡ä»½æ•°æ®åº“
./scripts/db.sh backup

# æ¸…ç†è¿‡æœŸæ•°æ®
./scripts/db.sh clean

# æŸ¥çœ‹ç»Ÿè®¡
./scripts/db.sh stats

# ä¼˜åŒ–æ•°æ®åº“
./scripts/db.sh vacuum
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ… **Token éªŒè¯** - UUID v4 æ ¼å¼æ ¡éªŒ
- âœ… **é€Ÿç‡é™åˆ¶** - IP çº§åˆ«å’Œç”¨æˆ·çº§åˆ«é™åˆ¶
- âœ… **SQL æ³¨å…¥é˜²å¾¡** - ä½¿ç”¨ Prepared Statements
- âœ… **XSS é˜²æŠ¤** - è¾“å…¥éªŒè¯å’Œè¾“å‡ºè½¬ä¹‰
- âœ… **æ•æ„Ÿä¿¡æ¯è„±æ•** - æ—¥å¿—ä¸­éšè—æ•æ„Ÿæ•°æ®
- âœ… **CORS é…ç½®** - ç”Ÿäº§ç¯å¢ƒç™½åå•é™åˆ¶

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ç¼“å­˜å‘½ä¸­å“åº”æ—¶é—´ | < 10ms |
| ç½‘ç»œè¯·æ±‚å“åº”æ—¶é—´ | 200-500ms |
| å¹¶å‘æ”¯æŒ | 100+ QPS |
| æ•°æ®åº“å¤§å° | ~50MB (1000 ç”¨æˆ·) |

## ğŸ§ª æµ‹è¯•

é¡¹ç›®åŒ…å«å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š

- âœ… å•å…ƒæµ‹è¯• - æ ¸å¿ƒé€»è¾‘å’Œå·¥å…·å‡½æ•°
- âœ… é›†æˆæµ‹è¯• - æ•°æ®åº“æ“ä½œå’ŒæœåŠ¡å±‚
- âœ… ç«¯åˆ°ç«¯æµ‹è¯• - å®Œæ•´ä¸šåŠ¡æµç¨‹
- âœ… å®‰å…¨æµ‹è¯• - SQL æ³¨å…¥ã€XSS é˜²æŠ¤
- âœ… æ€§èƒ½æµ‹è¯• - ç¼“å­˜æ€§èƒ½å’Œå¹¶å‘

æµ‹è¯•è¦†ç›–ç‡ > 80%

## ğŸ› ï¸ æ•…éšœæ’é™¤

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status huas-api

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u huas-api -n 50

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000
```

### æ•°æ®åº“é”å®š

```bash
# æ£€æŸ¥ WAL æ¨¡å¼
sqlite3 huas.sqlite "PRAGMA journal_mode;"

# åº”è¿”å› "wal"
```

### æ—¥å¿—æ–‡ä»¶è¿‡å¤§

```bash
# æ‰‹åŠ¨è½®è½¬æ—¥å¿—
sudo logrotate -f /etc/logrotate.d/huas-api
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ï¼è¯·éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“ å¼€å‘è§„èŒƒ

- æ‰€æœ‰ä»£ç å¿…é¡»æ·»åŠ æ¸…æ™°çš„ä¸­æ–‡æ³¨é‡Š
- éµå¾ª TypeScript ä¸¥æ ¼æ¨¡å¼
- æ¯æ¬¡ä»£ç å˜æ›´å¿…é¡»é…å¥—æµ‹è¯•
- æäº¤ä¿¡æ¯ä½¿ç”¨ä¸­æ–‡ï¼Œæ ¼å¼æ¸…æ™°

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨

## ğŸ”— ç›¸å…³é“¾æ¥

- [Bun å®˜æ–¹æ–‡æ¡£](https://bun.sh/docs)
- [Hono å®˜æ–¹æ–‡æ¡£](https://hono.dev/)
- [SQLite æ–‡æ¡£](https://www.sqlite.org/docs.html)

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue

---

**æ³¨æ„**: æœ¬é¡¹ç›®éœ€è¦é…åˆå­¦æ ¡æ•™åŠ¡ç³»ç»Ÿä½¿ç”¨ï¼Œè¯·ç¡®ä¿æ‹¥æœ‰åˆæ³•çš„è®¿é—®æƒé™ã€‚
