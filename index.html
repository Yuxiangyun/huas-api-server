<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–‡ç†å°åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        popCyan: '#6AECE1',
                        popTeal: '#26CCC2',
                        popYellow: '#FFF57E',
                        popOrange: '#FFB76C',
                        popPurple: '#C084FC',
                        popPink: '#F472B6',
                        ink: '#134E4A',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #134E4A', 
                        'card': '2px 2px 0px 0px #134E4A',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        * { -webkit-tap-highlight-color: transparent; }
        
        /* ğŸ”¥ æ ¸å¿ƒä¼˜åŒ–ï¼šç§»åŠ¨ç«¯å›ºå®šåˆ— (Sticky Column) */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 30; /* ä¿è¯åœ¨è¯¾ç¨‹å¡ç‰‡ä¹‹ä¸Š */
            background-color: #F8FAFC; /* å¿…é¡»æœ‰èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€è§† */
        }
        /* å›ºå®šåˆ—å³ä¾§åŠ ä¸ªé˜´å½±ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
        .sticky-shadow::after {
            content: '';
            position: absolute;
            top: 0;
            right: -4px;
            width: 4px;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.05), transparent);
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-[#F0F4F8] text-ink min-h-[100dvh] flex flex-col items-center py-6 px-4 pb-10">

    <!-- å¤´éƒ¨ -->
    <header class="mb-6 text-center w-full">
        <h1 class="text-3xl font-black tracking-tighter text-popTeal italic">HUAS <span class="text-ink">Assistant</span></h1>
    </header>

    <!-- Loading -->
    <div id="loading" class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-popTeal border-t-popOrange mb-3"></div>
        <div class="font-black bg-popYellow px-3 py-1 border border-ink shadow-hard text-xs">åŠ è½½ä¸­...</div>
    </div>

    <!-- ç™»å½•å¡ç‰‡ -->
    <section id="loginCard" class="w-full max-w-sm bg-white border-2 border-ink rounded-xl shadow-hard p-5 mb-8">
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-black">ç™»å½•</h2>
            <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold text-slate-400">SYSTEM READY</span>
                <div class="w-2.5 h-2.5 rounded-full bg-green-400 border border-ink animate-pulse"></div>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">å­¦å·</label>
                <input type="text" id="username" 
                    class="w-full text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">å¯†ç </label>
                <input type="password" id="password" 
                    class="w-full text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal" placeholder="è¯·è¾“å…¥æ™ºæ…§æ–‡ç†å¯†ç ">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">éªŒè¯ç </label>
                <div class="flex gap-2 h-[50px]">
                    <input type="text" id="captcha" placeholder="ABCD" 
                        class="flex-1 min-w-0 text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold uppercase focus:outline-none focus:border-popTeal focus:shadow-hard transition-all">
                    
                    <div class="w-28 border-2 border-ink rounded-lg bg-slate-200 cursor-pointer overflow-hidden relative group shrink-0 active:scale-95 transition-transform" onclick="initCaptcha()">
                        <img id="captchaImg" class="w-full h-full object-fill hidden">
                        <div id="captchaText" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-slate-400">ç‚¹å‡»åˆ·æ–°</div>
                    </div>
                </div>
            </div>
            <label class="flex items-center gap-2 text-xs font-bold text-slate-500 select-none">
                <input id="rememberMe" type="checkbox" class="w-4 h-4 border-2 border-ink rounded">
                è®°ä½å­¦å·å’Œå¯†ç 
            </label>
            <button onclick="handleLogin()" class="w-full bg-popTeal border-2 border-ink text-white font-black py-3 rounded-lg shadow-hard hover:translate-y-[-2px] hover:bg-popOrange transition-all active:translate-y-0 active:shadow-none mt-2">
                ç™» å½•
            </button>
        </div>
    </section>

    <!-- æ•°æ®å±•ç¤ºåŒºåŸŸï¼šé¡¶ç½®ä¿¡æ¯ + è¯¾è¡¨ + æŠ˜å æˆç»©å• -->
    <section id="dataArea" class="hidden w-full max-w-4xl space-y-4">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ ï¼šä¸ªäºº + ä¸€å¡é€š -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- ä¸ªäººä¿¡æ¯ -->
            <div class="md:col-span-2 bg-white border-2 border-ink rounded-xl shadow-hard p-4 flex items-center gap-4 relative overflow-hidden">
                <div class="w-14 h-14 bg-indigo-50 rounded-full border-2 border-ink flex items-center justify-center shrink-0 overflow-hidden">
                    <img id="userAvatar" src="" alt="Avatar" class="w-full h-full object-cover mix-blend-multiply">
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-xl font-black text-ink truncate" id="uiName">--</div>
                    <div class="flex flex-wrap gap-1 mt-1">
                        <span class="px-1.5 py-0.5 bg-slate-100 border border-ink rounded text-[10px] font-bold font-mono" id="uiId">--</span>
                        <span class="px-1.5 py-0.5 bg-popYellow/50 border border-ink rounded text-[10px] font-bold break-words leading-tight" id="uiClass">--</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="absolute top-0 right-0 p-3 text-[10px] font-bold text-slate-300 hover:text-red-500">é€€å‡º</button>
            </div>

            <!-- ä¸€å¡é€š -->
            <div class="text-white border-2 border-transparent rounded-xl shadow-hard p-4 flex flex-col justify-between relative overflow-hidden" style="background: radial-gradient(circle at 20% 20%, #1f7a8c 0%, #0f3d3e 55%, #0b2b2c 100%);">
                <div class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start z-10">
                    <span class="text-[10px] font-bold tracking-widest opacity-80 text-[#9ee0ff]">æ ¡å›­å¡ä½™é¢</span>
                    <span class="px-2 py-0.5 border border-[#9ee0ff]/50 bg-[#9ee0ff]/15 rounded-full text-[10px] font-bold text-[#9ee0ff]" id="ecStatus">--</span>
                </div>
                <div class="z-10 mt-1 flex justify-between items-end">
                    <div class="text-3xl font-black tracking-tighter flex items-baseline gap-1">
                        <span class="text-sm text-[#ffd166]">Â¥</span>
                        <span id="ecBalance">--</span>
                    </div>
                    <button onclick="loadEcard(true)" class="text-[10px] font-bold px-3 py-1.5 rounded-md border border-white/30 bg-white/10 hover:bg-white/20 active:scale-95 transition-all">
                        åˆ·æ–°ä¸€å¡é€š
                    </button>
                </div>
            </div>
        </div>

        <!-- è¯¾è¡¨ï¼ˆé»˜è®¤å±•å¼€ï¼‰ -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-5 bg-popTeal border-2 border-ink -rotate-6 rounded-sm"></div>
                    <h3 class="text-lg font-black tracking-tight">è¯¾è¡¨</h3>
                    <span class="text-[10px] font-bold text-slate-400" id="schWeek">--</span>
                </div>
                <button onclick="loadSchedule(true)" class="text-[10px] font-bold bg-slate-50 px-3 py-1.5 border border-slate-300 rounded hover:bg-white active:scale-95 transition-all">
                    åˆ·æ–°è¯¾è¡¨
                </button>
            </div>
            <div class="overflow-x-auto hide-scroll pb-2">
                <div class="min-w-[160vw] md:min-w-full" id="scheduleContainer"></div>
            </div>
        </div>

        <!-- æˆç»©ï¼ˆé»˜è®¤æ”¶èµ·ï¼‰ -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden" data-panel="grades" data-open="false">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100">
                <button class="flex items-center gap-2" onclick="togglePanel('grades')">
                    <div class="w-2 h-5 bg-popOrange border-2 border-ink -rotate-6 rounded-sm"></div>
                    <h3 class="text-lg font-black tracking-tight">æˆç»©å•</h3>
                    <span id="gradeSource" class="px-2 py-0.5 text-[10px] font-bold bg-slate-100 border border-slate-200 rounded text-slate-500 hidden"></span>
                </button>
                <button onclick="refreshGradesButton()" class="text-[10px] font-bold bg-slate-50 px-3 py-1.5 border border-slate-300 rounded hover:bg-white active:scale-95 transition-all">
                    åˆ·æ–°æˆç»©
                </button>
            </div>
            <div id="panelContent-grades" class="hidden">
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm font-bold">
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">æ‰€ä¿®é—¨æ•°</div>
                            <div id="gTotal" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">æ‰€ä¿®æ€»å­¦åˆ†</div>
                            <div id="gCredits" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">å¹³å‡ç»©ç‚¹</div>
                            <div id="gGpa" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">å¹³å‡æˆç»©</div>
                            <div id="gAvg" class="text-lg">--</div>
                        </div>
                    </div>

                    <div id="gradeList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const API_BASE = ''; 
        
        let currentSessionId = '';
        let globalToken = localStorage.getItem('huas_token') || '';
        const panelLoaded = { schedule: false, grades: false };
        const SAVED_CRED_KEY = 'huas_saved_cred';

        const COURSE_COLORS = [
            'bg-popCyan', 'bg-popYellow', 'bg-popOrange', 'bg-popPurple', 
            'bg-popPink', 'bg-[#A5F3FC]', 'bg-[#FDA4AF]'
        ];

        if (globalToken) {
            loadAllData();
        } else {
            loadSavedCredentials();
            initCaptcha();
        }

        async function initCaptcha() {
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/auth/captcha`, { cache: 'no-store' });
                const json = await res.json();
                if (json.code === 200) {
                    currentSessionId = json.data.sessionId;
                    const img = document.getElementById('captchaImg');
                    img.src = 'data:image/png;base64,' + json.data.image;
                    img.classList.remove('hidden');
                    document.getElementById('captchaText').classList.add('hidden');
                } else {
                    alert('éªŒè¯ç è·å–å¤±è´¥: ' + json.msg);
                }
            } catch (e) {
                console.error(e);
            } finally {
                setLoading(false);
            }
        }

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const c = document.getElementById('captcha').value;
            if(!u || !p || !c) return alert('è¯·å¡«å†™å®Œæ•´');

            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: currentSessionId, username: u, password: p, code: c })
                });
                const json = await res.json();
                if (json.code === 200) {
                    globalToken = json.token;
                    localStorage.setItem('huas_token', globalToken);
                    saveCredentialsIfNeeded(u, p);
                    loadAllData();
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + json.msg);
                    initCaptcha();
                }
            } catch (e) {
                alert('ç™»å½•è¯·æ±‚é”™è¯¯');
            } finally {
                setLoading(false);
            }
        }

        async function loadAllData() {
            if (!globalToken) return;
            setLoading(true);
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('dataArea').classList.remove('hidden');
            await Promise.all([
                loadUser(false),
                loadEcard(false),
                loadSchedule(false)
            ]);
            setLoading(false);
        }

        async function loadUser(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderUser(json.data);
                panelLoaded.user = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    handleLogout();
                } else {
                    alert('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥');
                    console.error(e);
                }
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderUser(data) {
            if(!data) return;
            document.getElementById('uiName').innerText = data.name;
            document.getElementById('uiId').innerText = data.studentId;
            document.getElementById('uiClass').innerText = data.className;
            const seed = encodeURIComponent(data.name || 'Student');
            document.getElementById('userAvatar').src = `https://api.dicebear.com/9.x/notionists/svg?seed=${seed}&backgroundColor=e9d5ff`;
        }

        async function loadEcard(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/ecard${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderEcard(json.data);
                panelLoaded.ecard = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    handleLogout();
                } else {
                    alert('ä¸€å¡é€šè·å–å¤±è´¥');
                    console.error(e);
                }
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        // ğŸ”¥ ä¿®å¤ï¼šä¸€å¡é€šçŠ¶æ€æœªçŸ¥æ˜¾ç¤ºé—®é¢˜
        function renderEcard(data) {
            if(!data) return;
            
            // ä¿®å¤æœªçŸ¥çŠ¶æ€ï¼šå¦‚æœçŠ¶æ€ä¸ºç©ºæˆ–åŒ…å«"æœªçŸ¥"ï¼Œå¼ºåˆ¶æ˜¾ç¤º"æ­£å¸¸"
            let statusText = data.status;
            if (!statusText || statusText.includes('æœªçŸ¥')) {
                statusText = 'æ­£å¸¸';
            }
            
            // ä¿®å¤é‡‘é¢ï¼šå¦‚æœé‡‘é¢ä¸å­˜åœ¨ï¼Œæ˜¾ç¤º 0.00
            const balanceText = (data.balance === undefined || data.balance === null) ? '0.00' : data.balance;

            const elStatus = document.getElementById('ecStatus');
            elStatus.innerText = statusText;
            
            // çŠ¶æ€é¢œè‰²é€»è¾‘
            if (statusText === 'æ­£å¸¸') {
                elStatus.className = "px-2 py-0.5 border border-popCyan/40 bg-popCyan/10 rounded-full text-[10px] font-bold text-popCyan";
            } else {
                elStatus.className = "px-2 py-0.5 border border-red-400/40 bg-red-400/10 rounded-full text-[10px] font-bold text-red-400";
            }

            document.getElementById('ecBalance').innerText = balanceText;
        }

        async function loadSchedule(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/schedule${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderSchedule(json.data);
                panelLoaded.schedule = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    handleLogout();
                } else {
                    alert('è¯¾è¡¨è·å–å¤±è´¥');
                    console.error(e);
                }
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        // ğŸ”¥ ç§»åŠ¨ç«¯ Sticky è¯¾è¡¨
        function renderSchedule(data) {
            if(!data) return;
            document.getElementById('schWeek').innerText = data.week || 'Schedule';
            
            const container = document.getElementById('scheduleContainer');
            const isMobile = window.innerWidth < 768;
            const leftColWidth = isMobile ? 50 : 60;
            const dayMinWidth = isMobile ? 90 : 110;
            container.style.minWidth = `${leftColWidth + 7 * dayMinWidth}px`;
            const courseMap = {};
            if (data.courses && Array.isArray(data.courses)) {
                data.courses.forEach(c => {
                    const match = c.section.match(/(\d+)/);
                    if (!match) return;
                    const startNode = parseInt(match[1]);
                    const sectionIdx = Math.floor((startNode - 1) / 2);
                    const dayIdx = c.day - 1;
                    const key = `${dayIdx}_${sectionIdx}`;
                    if (!courseMap[key]) courseMap[key] = [];
                    courseMap[key].push(c);
                });
            }

            // Grid å®šä¹‰ï¼šç¬¬ä¸€åˆ—å›ºå®šï¼Œåé¢ 7 åˆ—æœ€å° 110pxï¼Œé¿å…å‘¨æœ«åˆ—è¢«å‹ç¼©
            let html = `<div class="grid" style="grid-template-columns:${leftColWidth}px repeat(7, minmax(${dayMinWidth}px,1fr));">`;
            
            // å·¦ä¸Šè§’ç©ºå— (Sticky)
            html += `<div class="sticky-col sticky-shadow bg-[#F8FAFC] border-b border-r border-slate-100 z-40" style="width:${leftColWidth}px"></div>`;
            
            // æ˜ŸæœŸè¡¨å¤´
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const todayColIdx = (new Date().getDay() + 6) % 7;
            days.forEach((d, i) => {
                const isToday = i === todayColIdx;
                const bgClass = isToday ? 'text-popTeal bg-popTeal/10' : 'text-slate-400';
                const marker = isToday ? 'today-col' : '';
                html += `<div class="text-center font-black text-[10px] py-3 border-b border-slate-100 ${bgClass} ${marker}" data-day="${i}">${d}</div>`;
            });

            const sections = ['1-2', '3-4', '5-6', '7-8', '9-10', '11-12'];
            
            for (let s = 0; s < 6; s++) {
                // å·¦ä¾§æ—¶é—´è½´ (Sticky + Shadow)
                html += `
                    <div class="sticky-col sticky-shadow flex items-center justify-center font-bold text-slate-400 bg-[#F8FAFC] border-r border-b border-slate-100 text-[10px] z-30" style="width:${leftColWidth}px">
                        ${sections[s]}
                    </div>
                `;
                
                // è¯¾ç¨‹æ ¼å­
                for (let d = 0; d < 7; d++) {
                    const courses = courseMap[`${d}_${s}`];
                    // ä»Šå¤©çš„åˆ—åŠ ä¸€ç‚¹å¾®èƒŒæ™¯åŒºåˆ†
                    const colBg = d === todayColIdx ? 'bg-popTeal/5' : '';
                    
                    html += `<div class="p-1 border-b border-slate-100 border-r border-dashed border-slate-200 ${colBg} min-h-[90px] relative" data-day="${d}">`;
                    
                    if (courses && courses.length > 0) {
                        html += `<div class="flex flex-col gap-1 h-full">`; 
                        courses.forEach((course, idx) => {
                             const colorIdx = (d + s + idx) % COURSE_COLORS.length;
                             const bgClass = COURSE_COLORS[colorIdx];
                             html += `
                                <div class="course-card flex-1 ${bgClass} border-2 border-ink rounded-lg p-1.5 shadow-card cursor-pointer flex flex-col justify-between relative overflow-hidden group" title="${course.name}">
                                    <div class="font-black text-[10px] text-ink leading-tight line-clamp-3 z-10 relative mb-1">
                                        ${course.name}
                                    </div>
                                    ${course.location ? `
                                    <div class="flex justify-start z-10 relative">
                                        <div class="inline-flex items-start bg-white/70 border border-ink/10 px-1.5 py-1 rounded-lg text-[8px] font-bold text-ink/80 backdrop-blur-sm max-w-full leading-tight flex-col">
                                            <span class="break-words">${course.location.replace('æ ¡æœ¬éƒ¨', '').replace(/(æ¥¼)[A-Za-z]?\d+.*/, '$1')}</span>
                                            <span class="text-[9px] font-black">${(course.location.match(/(æ¥¼)([A-Za-z]?\d+)/) || [,'',''])[2]}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        async function loadGrades(refresh = false) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/grades${refresh ? '?refresh=true' : ''}`, {
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                if (json.code && json.code !== 200) {
                    throw new Error(json.msg || 'æˆç»©è·å–å¤±è´¥');
                }
                renderGrades(json.data);
                panelLoaded.grades = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    handleLogout();
                } else {
                    alert(e.message || 'æˆç»©è·å–å¤±è´¥');
                    console.error(e);
                }
            } finally {
                setLoading(false);
            }
        }

        function renderGrades(data) {
            if (!data) return;
            const summary = data.summary || {};
            document.getElementById('gTotal').innerText = summary.totalCourses ?? '--';
            document.getElementById('gCredits').innerText = summary.totalCredits ?? '--';
            document.getElementById('gGpa').innerText = summary.averageGpa ?? '--';
            document.getElementById('gAvg').innerText = summary.averageScore ?? '--';
            const sourceEl = document.getElementById('gradeSource');
            if (data._source) {
                sourceEl.innerText = data._source.toUpperCase();
                sourceEl.classList.remove('hidden');
            } else {
                sourceEl.innerText = '';
                sourceEl.classList.add('hidden');
            }

            const list = document.getElementById('gradeList');
            list.innerHTML = '';
            const items = data.items || [];

            if (!items.length) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-6">æš‚æ— æˆç»©æ•°æ®</div>`;
                return;
            }

            // æŒ‰å­¦æœŸåˆ†ç»„å¹¶æŒ‰æ—¶é—´å€’åº
            const groupMap = {};
            items.forEach(item => {
                const term = item.term || 'æœªçŸ¥å­¦æœŸ';
                if (!groupMap[term]) groupMap[term] = [];
                groupMap[term].push(item);
            });

            const parseTerm = (term) => {
                const m = term.match(/(\d{4}).*?(\d{4}).*?(\d+)/);
                if (m) return { y1: parseInt(m[1]), y2: parseInt(m[2]), sem: parseInt(m[3]) };
                return null;
            };
            const sortedTerms = Object.keys(groupMap).sort((a, b) => {
                const pa = parseTerm(a); const pb = parseTerm(b);
                if (pa && pb) {
                    if (pa.y1 !== pb.y1) return pb.y1 - pa.y1;
                    if (pa.y2 !== pb.y2) return pb.y2 - pa.y2;
                    return (pb.sem || 0) - (pa.sem || 0);
                }
                return b.localeCompare(a);
            });

            sortedTerms.forEach(term => {
                list.innerHTML += `
                    <div class="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-[12px] font-black text-slate-600 tracking-wide">
                        ${term}
                    </div>
                `;

                groupMap[term].forEach(item => {
                    const passTag = item.pass === null ? '' : item.pass ? 'text-popTeal' : 'text-red-500';
                    const scoreText = item.score !== null ? item.score : item.scoreText || '--';
                    const natureText = item.courseCategory || item.courseAttribute || '';
                    const natureRow = natureText ? `<div class="flex items-center justify-between text-[11px] text-slate-500 mt-2">
                                <span>æ€§è´¨ï¼š${natureText}</span>
                            </div>` : '';

                    list.innerHTML += `
                        <div class="p-3 border border-slate-200 rounded-xl bg-white shadow-[0_1px_2px_rgba(0,0,0,0.04)]">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[12px] text-slate-500 font-bold">${item.term || ''}</div>
                                    <div class="text-base font-black text-ink leading-tight mt-1 line-clamp-2">${item.courseName}</div>
                                    <div class="text-[11px] text-slate-400 font-mono mt-0.5">${item.courseCode || '--'}</div>
                                </div>
                                <div class="flex flex-col items-end text-right">
                                    <div class="text-lg font-black ${passTag}">${scoreText}</div>
                                    <div class="text-[11px] text-slate-500 mt-1">å­¦åˆ† ${item.credit ?? '--'} Â· ç»©ç‚¹ ${item.gpa ?? '--'}</div>
                                    <div class="text-[10px] text-slate-400">${item.courseNature || '--'}</div>
                                </div>
                            </div>
                            ${natureRow}
                        </div>
                    `;
                });
            });
        }

        function handleLogout() {
            localStorage.removeItem('huas_token');
            globalToken = '';
            panelLoaded.schedule = panelLoaded.grades = panelLoaded.ecard = panelLoaded.user = false;
            location.reload();
        }

        function setLoading(isLoading) {
            const el = document.getElementById('loading');
            el.classList.toggle('hidden', !isLoading);
        }

        function loadSavedCredentials() {
            try {
                const saved = localStorage.getItem(SAVED_CRED_KEY);
                if (!saved) return;
                const { username, password, remember } = JSON.parse(saved);
                if (username) document.getElementById('username').value = username;
                if (password) document.getElementById('password').value = password;
                if (remember) document.getElementById('rememberMe').checked = true;
            } catch {}
        }

        function saveCredentialsIfNeeded(username, password) {
            const remember = document.getElementById('rememberMe').checked;
            if (remember) {
                localStorage.setItem(SAVED_CRED_KEY, JSON.stringify({ username, password, remember: true }));
            } else {
                localStorage.removeItem(SAVED_CRED_KEY);
            }
        }

        function togglePanel(name, forceOpen = null) {
            const container = document.getElementById(`panelContent-${name}`);
            const wrapper = document.querySelector(`[data-panel="${name}"]`);
            const isOpen = !container.classList.contains('hidden');
            const next = forceOpen !== null ? forceOpen : !isOpen;
            container.classList.toggle('hidden', !next);
            wrapper?.setAttribute('data-open', next ? 'true' : 'false');

            if (next && name === 'grades' && !panelLoaded.grades) {
                loadGrades();
            }
        }

        function refreshGradesButton() {
            // å±•å¼€æŠ˜å å¹¶åˆ·æ–°
            const container = document.getElementById('panelContent-grades');
            if (container.classList.contains('hidden')) {
                togglePanel('grades', true);
            }
            loadGrades(true);
        }
    </script>
</body>
</html>
