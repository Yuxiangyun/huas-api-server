<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>文理小助手</title>
    <!-- 样式：保留原始 Tailwind 配置，未改动配色和布局 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        popCyan: '#6AECE1',
                        popTeal: '#26CCC2',
                        popYellow: '#FFF57E',
                        popOrange: '#FFB76C',
                        popPurple: '#C084FC',
                        popPink: '#F472B6',
                        ink: '#134E4A',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #134E4A', 
                        'card': '2px 2px 0px 0px #134E4A',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        * { -webkit-tap-highlight-color: transparent; }
        
        /* 移动端课表左侧固定列 */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #F8FAFC;
        }
        /* 固定列右侧阴影 */
        .sticky-shadow::after {
            content: '';
            position: absolute;
            top: 0;
            right: -4px;
            width: 4px;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.05), transparent);
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-[#F0F4F8] text-ink min-h-[100dvh] flex flex-col items-center py-6 px-4 pb-10">

    <!-- 头部区域 -->
    <header class="mb-6 text-center w-full">
        <h1 class="text-3xl font-black tracking-tighter text-popTeal ">文理 <span class="text-ink">小助手</span></h1>
    </header>

    <!-- Loading 遮罩 -->
    <div id="loading" class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-popTeal border-t-popOrange mb-3"></div>
        <div class="font-black bg-popYellow px-3 py-1 border border-ink shadow-hard text-xs">加载中...</div>
    </div>

    <!-- 登录卡片 -->
    <section id="loginCard" class="w-full max-w-sm bg-white border-2 border-ink rounded-xl shadow-hard p-5 mb-8">
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-black">登录</h2>
            <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold text-slate-400">SYSTEM READY</span>
                <div class="w-2.5 h-2.5 rounded-full bg-green-400 border border-ink animate-pulse"></div>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">学号</label>
                <input type="text" id="username" 
                    class="w-full text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal" placeholder="请输入学号">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">密码</label>
                <input type="password" id="password" 
                    class="w-full text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal" placeholder="请输入智慧文理密码">
            </div>
            <div id="captchaBlock" class="hidden">
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">验证码（需要时）</label>
                <div class="flex gap-2 h-[50px]">
                    <input type="text" id="captcha" placeholder="ABCD" 
                        class="flex-1 min-w-0 text-base bg-slate-50 border-2 border-ink rounded-lg p-3 font-bold uppercase focus:outline-none focus:border-popTeal focus:shadow-hard transition-all">
                    
                    <div class="w-28 border-2 border-ink rounded-lg bg-slate-200 cursor-pointer overflow-hidden relative group shrink-0 active:scale-95 transition-transform" onclick="initCaptcha(true)">
                        <img id="captchaImg" class="w-full h-full object-fill hidden">
                        <div id="captchaText" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-slate-400">点击刷新</div>
                    </div>
                </div>
            </div>
            <label class="flex items-center gap-2 text-xs font-bold text-slate-500 select-none">
                <input id="rememberMe" type="checkbox" class="w-4 h-4 border-2 border-ink rounded">
                记住学号和密码
            </label>
            <button onclick="handleLogin()" class="w-full bg-popTeal border-2 border-ink text-white font-black py-3 rounded-lg shadow-hard hover:translate-y-[-2px] hover:bg-popOrange transition-all active:translate-y-0 active:shadow-none mt-2">
                登 录
            </button>
        </div>
    </section>

    <!-- 数据展示区域：顶置信息 + 课表 + 成绩 -->
    <section id="dataArea" class="hidden w-full max-w-4xl space-y-4">
        <!-- 顶部信息栏：个人 + 一卡通 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 个人信息卡片 -->
            <div class="md:col-span-2 bg-white border-2 border-ink rounded-xl shadow-hard p-4 flex items-center gap-4 relative overflow-hidden">
                <div class="w-14 h-14 bg-indigo-50 rounded-full border-2 border-ink flex items-center justify-center shrink-0 overflow-hidden">
                    <img id="userAvatar" src="" alt="Avatar" class="w-full h-full object-cover mix-blend-multiply">
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-xl font-black text-ink truncate" id="uiName">--</div>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <span class="px-2 py-1 bg-slate-100 border border-ink rounded-lg text-xs font-black font-mono text-ink shadow-card" id="uiId">--</span>
                        <span class="px-2 py-1 bg-popYellow/60 border border-ink rounded-lg text-xs font-black text-ink shadow-card" id="uiClass">--</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="absolute top-0 right-0 p-3 text-[10px] font-bold text-slate-300 hover:text-red-500">退出</button>
            </div>

            <!-- 一卡通卡片 -->
            <div class="text-white border-2 border-transparent rounded-xl shadow-hard p-4 flex flex-col justify-between relative overflow-hidden" style="background: radial-gradient(circle at 20% 20%, #1f7a8c 0%, #0f3d3e 55%, #0b2b2c 100%);">
                <div class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start z-10">
                    <span class="text-[10px] font-bold tracking-widest opacity-80 text-[#9ee0ff]">校园卡余额</span>
                    <span class="px-2 py-0.5 border border-[#9ee0ff]/50 bg-[#9ee0ff]/15 rounded-full text-[10px] font-bold text-[#9ee0ff]" id="ecStatus">--</span>
                </div>
                <div class="z-10 mt-1 flex justify-between items-end">
                    <div class="text-3xl font-black tracking-tighter flex items-baseline gap-1">
                        <span class="text-sm text-[#ffd166]">¥</span>
                        <span id="ecBalance">--</span>
                    </div>
                    <button onclick="loadEcard(true)" class="text-[10px] font-bold px-3 py-1.5 rounded-md border border-white/30 bg-white/10 hover:bg-white/20 active:scale-95 transition-all">
                        刷新一卡通
                    </button>
                </div>
            </div>
        </div>

        <!-- 课表（默认展开） -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-5 bg-popTeal border-2 border-ink -rotate-6 rounded-sm"></div>
                    <h3 class="text-lg font-black tracking-tight">课表</h3>
                    <span class="text-[10px] font-bold text-slate-400" id="schWeek">--</span>
                </div>
                <button onclick="loadSchedule(true)" class="text-[10px] font-bold bg-slate-50 px-3 py-1.5 border border-slate-300 rounded hover:bg-white active:scale-95 transition-all">
                    刷新课表
                </button>
            </div>
            <div class="overflow-x-auto hide-scroll pb-2">
                <div class="min-w-[160vw] md:min-w-full" id="scheduleContainer"></div>
            </div>
        </div>

        <!-- 成绩（默认收起） -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden" data-panel="grades" data-open="false">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100">
                <button class="flex items-center gap-2" onclick="togglePanel('grades')">
                    <div class="w-2 h-5 bg-popOrange border-2 border-ink -rotate-6 rounded-sm"></div>
                    <h3 class="text-lg font-black tracking-tight">成绩单</h3>
                    <span id="gradeSource" class="px-2 py-0.5 text-[10px] font-bold bg-slate-100 border border-slate-200 rounded text-slate-500 hidden"></span>
                </button>
                <button onclick="refreshGradesButton()" class="text-[10px] font-bold bg-slate-50 px-3 py-1.5 border border-slate-300 rounded hover:bg-white active:scale-95 transition-all">
                    刷新成绩
                </button>
            </div>
            <div id="panelContent-grades" class="hidden">
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm font-bold">
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">所修门数</div>
                            <div id="gTotal" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">所修总学分</div>
                            <div id="gCredits" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">平均绩点</div>
                            <div id="gGpa" class="text-lg">--</div>
                        </div>
                        <div class="p-3 border border-slate-200 rounded-lg bg-slate-50/60">
                            <div class="text-[10px] text-slate-500 mb-1">平均成绩</div>
                            <div id="gAvg" class="text-lg">--</div>
                        </div>
                    </div>

                    <div id="gradeList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const API_BASE = ''; 
        
        let currentSessionId = '';
        let requireCaptcha = false;
        let isRelogging = false;
        let reauthPromise = null;
        let reauthFailedNotified = false;
        const log = (...args) => console.log('[UI]', ...args);
        let globalToken = localStorage.getItem('huas_token') || '';
        const panelLoaded = { schedule: false, grades: false };
        const SAVED_CRED_KEY = 'huas_saved_cred';
        const SAVED_CRED_KEYS = [SAVED_CRED_KEY, 'huas_saved_cred_bak1', 'huas_saved_cred_bak2'];
        const IDB_CONFIG = { name: 'huasCredDB', store: 'creds', key: 'primary' };
        let autoLoginAttempted = false;

        const COURSE_COLORS = [
            'bg-popCyan', 'bg-popYellow', 'bg-popOrange', 'bg-popPurple', 
            'bg-popPink', 'bg-[#A5F3FC]', 'bg-[#FDA4AF]'
        ];

        if (globalToken) {
            loadAllData();
        } else {
            // 先加载已保存的凭据，再启动静默自动登录
            (async () => {
                await loadSavedCredentials();
                await autoLoginOnLoad();
            })();
            initCaptcha();
        }

        async function initCaptcha(forceShow = false) {
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/auth/captcha`, { cache: 'no-store' });
                const json = await res.json();
                if (json.code === 200) {
                    currentSessionId = json.data.sessionId;
                    const img = document.getElementById('captchaImg');
                    img.src = 'data:image/png;base64,' + json.data.image;
                    img.classList.remove('hidden');
                    document.getElementById('captchaText').classList.add('hidden');
                    if (forceShow) {
                        requireCaptcha = true;
                        document.getElementById('captchaBlock').classList.remove('hidden');
                    } else if (!requireCaptcha) {
                        document.getElementById('captchaBlock').classList.add('hidden');
                    }
                } else {
                    alert('验证码获取失败: ' + json.msg);
                }
            } catch (e) {
                console.error(e);
            } finally {
                setLoading(false);
            }
        }

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const c = document.getElementById('captcha').value;
            if(!u || !p) return alert('请填写学号和密码');
            if(requireCaptcha && !c) return alert('请输入验证码');
            await performLogin(u, p, c, false);
        }

        async function performLogin(username, password, captcha, quiet = false) {
            log('performLogin', { quiet, requireCaptcha });
            if (!quiet) setLoading(true);
            try {
                const payload = { sessionId: currentSessionId, username, password };
                if (requireCaptcha || captcha) payload.code = captcha;

                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                log('login response', json);
                if (json.code === 200) {
                    globalToken = json.token;
                    localStorage.setItem('huas_token', globalToken);
                    reauthFailedNotified = false;
                    if (!quiet) {
                        await saveCredentialsIfNeeded(username, password);
                        document.getElementById('loginCard').classList.add('hidden');
                        document.getElementById('dataArea').classList.remove('hidden');
                        await loadAllData();
                    }
                    return true;
                }

                if (json.action === 'NEED_CAPTCHA') {
                    log('login need captcha', json.msg);
                    requireCaptcha = true;
                    document.getElementById('captchaBlock').classList.remove('hidden');
                    document.getElementById('captcha').value = '';
                    initCaptcha(true);
                    if (!quiet) alert(json.msg || '登录失败，可能学号/密码错误，请输入验证码后再试');
                } else if (json.code === 400 && json.msg && json.msg.includes('会话ID无效')) {
                    log('login invalid sessionId, refreshing captcha session');
                    await initCaptcha(false);
                    if (quiet) {
                        return performLogin(username, password, '', true);
                    }
                    alert('会话已失效，已刷新验证码，请重试');
                } else {
                    log('login failed', json.msg);
                    if (!quiet) alert('登录失败: ' + json.msg);
                    initCaptcha(requireCaptcha);
                }
                return false;
            } catch (e) {
                log('login error', e);
                if (!quiet) alert('登录请求错误');
                return false;
            } finally {
                if (!quiet) setLoading(false);
            }
        }

        async function loadAllData() {
            if (!globalToken) return;
            setLoading(true);
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('dataArea').classList.remove('hidden');
            await Promise.all([
                loadUser(false),
                loadEcard(false),
                loadSchedule(false)
            ]);
            setLoading(false);
        }

        async function loadUser(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('请先登录');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderUser(json.data);
                panelLoaded.user = true;
            } catch (e) {
                await handleFetchError(e, () => loadUser(refresh, false));
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderUser(data) {
            if(!data) return;
            document.getElementById('uiName').innerText = data.name;
            document.getElementById('uiId').innerText = data.studentId;
            document.getElementById('uiClass').innerText = data.className;
            const seed = encodeURIComponent(data.name || 'Student');
            document.getElementById('userAvatar').src = `https://api.dicebear.com/9.x/notionists/svg?seed=${seed}&backgroundColor=e9d5ff`;
        }

        async function loadEcard(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('请先登录');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/ecard${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderEcard(json.data);
                panelLoaded.ecard = true;
            } catch (e) {
                log('loadEcard error', e);
                await handleFetchError(e, () => loadEcard(refresh, false), '一卡通获取失败');
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderEcard(data) {
            if(!data) return;
            let statusText = data.status;
            if (!statusText || statusText.includes('未知')) {
                statusText = '正常';
            }
            const balanceText = (data.balance === undefined || data.balance === null) ? '0.00' : data.balance;
            const elStatus = document.getElementById('ecStatus');
            elStatus.innerText = statusText;
            if (statusText === '正常') {
                elStatus.className = "px-2 py-0.5 border border-popCyan/40 bg-popCyan/10 rounded-full text-[10px] font-bold text-popCyan";
            } else {
                elStatus.className = "px-2 py-0.5 border border-red-400/40 bg-red-400/10 rounded-full text-[10px] font-bold text-red-400";
            }
            document.getElementById('ecBalance').innerText = balanceText;
        }

        async function loadSchedule(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('请先登录');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/schedule${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderSchedule(json.data);
                panelLoaded.schedule = true;
            } catch (e) {
                log('loadSchedule error', e);
                await handleFetchError(e, () => loadSchedule(refresh, false), '课表获取失败');
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderSchedule(data) {
            if(!data) return;
            document.getElementById('schWeek').innerText = data.week || 'Schedule';
            const container = document.getElementById('scheduleContainer');
            const isMobile = window.innerWidth < 768;
            const leftColWidth = isMobile ? 50 : 60;
            const dayMinWidth = isMobile ? 90 : 110;
            container.style.minWidth = `${leftColWidth + 7 * dayMinWidth}px`;
            const courseMap = {};
            if (data.courses && Array.isArray(data.courses)) {
                data.courses.forEach(c => {
                    const match = c.section.match(/(\d+)/);
                    if (!match) return;
                    const startNode = parseInt(match[1]);
                    const sectionIdx = Math.floor((startNode - 1) / 2);
                    const dayIdx = c.day - 1;
                    const key = `${dayIdx}_${sectionIdx}`;
                    if (!courseMap[key]) courseMap[key] = [];
                    courseMap[key].push(c);
                });
            }
            let html = `<div class="grid" style="grid-template-columns:${leftColWidth}px repeat(7, minmax(${dayMinWidth}px,1fr));">`;
            html += `<div class="sticky-col sticky-shadow bg-[#F8FAFC] border-b border-r border-slate-100 z-40" style="width:${leftColWidth}px"></div>`;
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const todayColIdx = (new Date().getDay() + 6) % 7;
            days.forEach((d, i) => {
                const isToday = i === todayColIdx;
                const bgClass = isToday ? 'text-popTeal bg-popTeal/10' : 'text-slate-400';
                const marker = isToday ? 'today-col' : '';
                html += `<div class="text-center font-black text-[10px] py-3 border-b border-slate-100 ${bgClass} ${marker}" data-day="${i}">${d}</div>`;
            });
            const sections = ['1-2', '3-4', '5-6', '7-8', '9-10', '11-12'];
            for (let s = 0; s < 6; s++) {
                html += `
                    <div class="sticky-col sticky-shadow flex items-center justify-center font-bold text-slate-400 bg-[#F8FAFC] border-r border-b border-slate-100 text-[10px] z-30" style="width:${leftColWidth}px">
                        ${sections[s]}
                    </div>
                `;
                for (let d = 0; d < 7; d++) {
                    const courses = courseMap[`${d}_${s}`];
                    const colBg = d === todayColIdx ? 'bg-popTeal/5' : '';
                    html += `<div class="p-1 border-b border-slate-100 border-r border-dashed border-slate-200 ${colBg} min-h-[90px] relative" data-day="${d}">`;
                    if (courses && courses.length > 0) {
                        html += `<div class="flex flex-col gap-1 h-full">`; 
                        courses.forEach((course, idx) => {
                             const colorIdx = (d + s + idx) % COURSE_COLORS.length;
                             const bgClass = COURSE_COLORS[colorIdx];
                             html += `
                                <div class="course-card flex-1 ${bgClass} border-2 border-ink rounded-lg p-1.5 shadow-card cursor-pointer flex flex-col justify-between relative overflow-hidden group" title="${course.name}">
                                    <div class="font-black text-[10px] text-ink leading-tight line-clamp-3 z-10 relative mb-1">
                                        ${course.name}
                                    </div>
                                    ${course.location ? `
                                    <div class="flex justify-start z-10 relative">
                                        <div class="inline-flex items-start bg-white/70 border border-ink/10 px-1.5 py-1 rounded-lg text-[8px] font-bold text-ink/80 backdrop-blur-sm max-w-full leading-tight flex-col">
                                            <span class="break-words">${course.location.replace('校本部', '').replace(/(楼)[A-Za-z]?\d+.*/, '$1')}</span>
                                            <span class="text-[9px] font-black">${(course.location.match(/(楼)([A-Za-z]?\d+)/) || [,'',''])[2]}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        async function loadGrades(refresh = false) {
            if (!globalToken) return alert('请先登录');
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/grades${refresh ? '?refresh=true' : ''}`, {
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                if (json.code && json.code !== 200) {
                    throw new Error(json.msg || '成绩获取失败');
                }
                renderGrades(json.data);
                panelLoaded.grades = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('登录已过期，请重新登录');
                    handleLogout();
                } else {
                    alert(e.message || '成绩获取失败');
                    console.error(e);
                }
            } finally {
                setLoading(false);
            }
        }

        function renderGrades(data) {
            if (!data) return;
            const summary = data.summary || {};
            document.getElementById('gTotal').innerText = summary.totalCourses ?? '--';
            document.getElementById('gCredits').innerText = summary.totalCredits ?? '--';
            document.getElementById('gGpa').innerText = summary.averageGpa ?? '--';
            document.getElementById('gAvg').innerText = summary.averageScore ?? '--';
            const sourceEl = document.getElementById('gradeSource');
            if (data._source) {
                sourceEl.innerText = data._source.toUpperCase();
                sourceEl.classList.remove('hidden');
            } else {
                sourceEl.innerText = '';
                sourceEl.classList.add('hidden');
            }
            const list = document.getElementById('gradeList');
            list.innerHTML = '';
            const items = data.items || [];
            if (!items.length) {
                // 教务返回空列表时，提示可能未完成评教或当前无成绩
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-6">
                    教务系统未返回成绩，可能未完成评教或当前无成绩数据，请完成评教后重试。
                </div>`;
                return;
            }
            const groupMap = {};
            items.forEach(item => {
                const term = item.term || '未知学期';
                if (!groupMap[term]) groupMap[term] = [];
                groupMap[term].push(item);
            });
            const parseTerm = (term) => {
                const m = term.match(/(\d{4}).*?(\d{4}).*?(\d+)/);
                if (m) return { y1: parseInt(m[1]), y2: parseInt(m[2]), sem: parseInt(m[3]) };
                return null;
            };
            const sortedTerms = Object.keys(groupMap).sort((a, b) => {
                const pa = parseTerm(a); const pb = parseTerm(b);
                if (pa && pb) {
                    if (pa.y1 !== pb.y1) return pb.y1 - pa.y1;
                    if (pa.y2 !== pb.y2) return pb.y2 - pa.y2;
                    return (pb.sem || 0) - (pa.sem || 0);
                }
                return b.localeCompare(a);
            });
            sortedTerms.forEach(term => {
                list.innerHTML += `
                    <div class="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-[12px] font-black text-slate-600 tracking-wide">
                        ${term}
                    </div>
                `;
                groupMap[term].forEach(item => {
                    const passTag = item.pass === null ? '' : item.pass ? 'text-popTeal' : 'text-red-500';
                    const scoreText = item.score !== null ? item.score : item.scoreText || '--';
                    const natureText = item.courseCategory || item.courseAttribute || '';
                    const natureRow = natureText ? `<div class="flex items-center justify-between text-[11px] text-slate-500 mt-2">
                                <span>性质：${natureText}</span>
                            </div>` : '';
                    list.innerHTML += `
                        <div class="p-3 border border-slate-200 rounded-xl bg-white shadow-[0_1px_2px_rgba(0,0,0,0.04)]">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[12px] text-slate-500 font-bold">${item.term || ''}</div>
                                    <div class="text-base font-black text-ink leading-tight mt-1 line-clamp-2">${item.courseName}</div>
                                    <div class="text-[11px] text-slate-400 font-mono mt-0.5">${item.courseCode || '--'}</div>
                                </div>
                                <div class="flex flex-col items-end text-right">
                                    <div class="text-lg font-black ${passTag}">${scoreText}</div>
                                    <div class="text-[11px] text-slate-500 mt-1">学分 ${item.credit ?? '--'} · 绩点 ${item.gpa ?? '--'}</div>
                                    <div class="text-[10px] text-slate-400">${item.courseNature || '--'}</div>
                                </div>
                            </div>
                            ${natureRow}
                        </div>
                    `;
                });
            });
        }

        async function handleLogout(preserveCreds = true) {
            localStorage.removeItem('huas_token');
            globalToken = '';
            panelLoaded.schedule = panelLoaded.grades = panelLoaded.ecard = panelLoaded.user = false;
            requireCaptcha = false;
            document.getElementById('captcha').value = '';
            document.getElementById('captchaBlock').classList.add('hidden');
            document.getElementById('dataArea').classList.add('hidden');
            document.getElementById('loginCard').classList.remove('hidden');
            if (!preserveCreds) {
                clearCredentialsLocal();
                await clearCredentialsIndexedDB();
            }
            loadSavedCredentials();
            initCaptcha(false);
        }

        function setLoading(isLoading) {
            const el = document.getElementById('loading');
            el.classList.toggle('hidden', !isLoading);
        }

        async function loadSavedCredentials() {
            try {
                const saved = await getSavedCredentials();
                if (!saved) {
                    log('no saved credentials found');
                    document.getElementById('rememberMe').checked = true;
                    return;
                }
                const { username, password, remember } = saved;
                log('load saved credentials', { hasUser: !!username, hasPass: !!password, remember });
                if (username) document.getElementById('username').value = username;
                if (password) document.getElementById('password').value = password;
                if (remember !== undefined) document.getElementById('rememberMe').checked = remember;
            } catch (e) {
                console.error('loadSavedCredentials error', e);
            }
        }

        async function autoLoginOnLoad() {
            if (autoLoginAttempted || globalToken) return;
            const saved = await getSavedCredentials();
            if (!saved || !saved.username || !saved.password || saved.remember !== true) return;
            autoLoginAttempted = true;
            setLoading(true);
            const ok = await tryAutoRelogin();
            if (ok) {
                document.getElementById('loginCard').classList.add('hidden');
                document.getElementById('dataArea').classList.remove('hidden');
                await loadAllData();
            }
            setLoading(false);
        }

        async function saveCredentialsIfNeeded(username, password) {
            const remember = document.getElementById('rememberMe').checked;
            if (remember) {
                const payload = { username, password, remember: true };
                saveCredentialsLocal(payload);
                await saveCredentialsIndexedDB(payload);
            } else {
                clearCredentialsLocal();
                await clearCredentialsIndexedDB();
            }
        }

        function togglePanel(name, forceOpen = null) {
            const container = document.getElementById(`panelContent-${name}`);
            const wrapper = document.querySelector(`[data-panel="${name}"]`);
            const isOpen = !container.classList.contains('hidden');
            const next = forceOpen !== null ? forceOpen : !isOpen;
            container.classList.toggle('hidden', !next);
            wrapper?.setAttribute('data-open', next ? 'true' : 'false');

            if (next && name === 'grades' && !panelLoaded.grades) {
                loadGrades();
            }
        }

        function refreshGradesButton() {
            const container = document.getElementById('panelContent-grades');
            if (container.classList.contains('hidden')) {
                togglePanel('grades', true);
            }
            loadGrades(true);
        }

        function readCredentialsLocal() {
            for (const key of SAVED_CRED_KEYS) {
                const raw = localStorage.getItem(key);
                if (!raw) continue;
                try {
                    const parsed = JSON.parse(raw);
                    if (parsed && (parsed.username || parsed.password)) {
                        return parsed;
                    }
                } catch (e) {
                    console.error('parse cred fail', key, e);
                }
            }
            return null;
        }

        function saveCredentialsLocal(payload) {
            try {
                const data = JSON.stringify(payload);
                SAVED_CRED_KEYS.forEach(k => localStorage.setItem(k, data));
            } catch (e) {
                console.error('saveCredentialsLocal error', e);
            }
        }

        function clearCredentialsLocal() {
            SAVED_CRED_KEYS.forEach(k => localStorage.removeItem(k));
        }

        function openCredDB() {
            return new Promise((resolve) => {
                if (!('indexedDB' in window)) return resolve(null);
                const req = indexedDB.open(IDB_CONFIG.name, 1);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(IDB_CONFIG.store)) {
                        db.createObjectStore(IDB_CONFIG.store);
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }

        async function saveCredentialsIndexedDB(payload) {
            const db = await openCredDB();
            if (!db) return false;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
                tx.objectStore(IDB_CONFIG.store).put(payload, IDB_CONFIG.key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => resolve(false);
            });
        }

        async function loadCredentialsIndexedDB() {
            const db = await openCredDB();
            if (!db) return null;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readonly');
                const req = tx.objectStore(IDB_CONFIG.store).get(IDB_CONFIG.key);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => resolve(null);
            });
        }

        async function clearCredentialsIndexedDB() {
            const db = await openCredDB();
            if (!db) return false;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
                tx.objectStore(IDB_CONFIG.store).delete(IDB_CONFIG.key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => resolve(false);
            });
        }

        async function handleFetchError(error, retryFn, fallbackMsg = '请求失败') {
            if (error.message === 'SESSION_EXPIRED') {
                log('session expired, start reauth');
                if (!reauthPromise) {
                    reauthPromise = tryAutoRelogin();
                }
                const reloginOk = await reauthPromise.catch(() => false);
                reauthPromise = null;
                if (reloginOk && typeof retryFn === 'function') {
                    log('reauth success, retrying');
                    return retryFn();
                }
                if (!reauthFailedNotified) {
                    alert('登录已过期，请重新登录');
                    reauthFailedNotified = true;
                }
                handleLogout(true);
            } else {
                alert(fallbackMsg);
                console.error(error);
            }
        }

        async function getSavedCredentials() {
            try {
                const local = readCredentialsLocal();
                if (local) return local;
                const idb = await loadCredentialsIndexedDB();
                return idb || null;
            } catch { return null; }
        }

        async function tryAutoRelogin() {
            if (isRelogging) return false;
            const saved = await getSavedCredentials();
            if (!saved || !saved.username || !saved.password) return false;
            isRelogging = true;
            currentSessionId = '';
            requireCaptcha = false;
            await initCaptcha(false);
            const ok = await performLogin(saved.username, saved.password, '', true);
            isRelogging = false;
            return ok;
        }
    </script>
</body>
</html>
