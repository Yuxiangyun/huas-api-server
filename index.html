<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>æ–‡ç†å°åŠ©æ‰‹</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
            mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
          },
          colors: {
            iosBg: '#F2F2F7',
            iosCard: '#FFFFFF',
            iosBlue: '#007AFF',
            iosTeal: '#30B0C7',
            iosGreen: '#34C759',
            iosRed: '#FF3B30',
            iosYellow: '#FFCC00',
            iosGray: '#8E8E93',
            iosGrayLight: '#E5E5EA',
            ink: '#1C1C1E',
            sub: '#8E8E93',
          },
          boxShadow: {
            'ios-sm': '0 1px 2px rgba(0,0,0,0.05)',
            'ios-card': '0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02)',
            'ios-float': '0 12px 32px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.08)',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'scale(0.98)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)' },
              '100%': { transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: #F2F2F7;
      -webkit-font-smoothing: antialiased;
    }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    * { -webkit-tap-highlight-color: transparent; }

    /* ç§»åŠ¨ç«¯è¯¾è¡¨å·¦ä¾§å›ºå®šåˆ— - ç£¨ç ‚æ•ˆæœ */
    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 30;
      background-color: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .sticky-shadow::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 1px;
      height: 100%;
      background: #E5E5EA;
      pointer-events: none;
    }

    /* 3D å›¾æ ‡ */
    .icon-3d {
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.08));
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .icon-3d:hover { transform: scale(1.1) rotate(5deg); }

    /* iOS é£æ ¼ Checkbox */
    .ios-checkbox {
      appearance: none;
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #C6C6C8;
      border-radius: 50%;
      display: inline-block;
      position: relative;
      transition: all 0.2s;
      background-color: white;
    }
    .ios-checkbox:checked {
      background-color: #007AFF;
      border-color: #007AFF;
    }
    .ios-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
  </style>
</head>

<body class="bg-iosBg text-ink min-h-[100dvh] flex flex-col py-8 px-4 pb-20 relative max-w-xl mx-auto border-x border-white/50 shadow-2xl">

  <!-- 1. å¤´éƒ¨åŒºåŸŸ -->
  <header class="mb-8 w-full flex flex-col items-center justify-center animate-fade-in">
    <div class="flex items-center gap-3">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/School/3D/school_3d.png"
           class="w-12 h-12 object-contain icon-3d" alt="School">
      <h1 class="text-2xl font-bold tracking-tight text-ink flex items-center gap-1">
        æ–‡ç†<span class="text-iosBlue">å°åŠ©æ‰‹</span>
      </h1>
    </div>
    <p class="text-[10px] font-semibold text-sub mt-2 tracking-[0.2em] uppercase opacity-70">Hunan University of Arts and Science</p>
  </header>

  <!-- Loading é®ç½© -->
  <div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/10 backdrop-blur-[2px]"></div>
    <div class="relative bg-white/80 backdrop-blur-xl px-6 py-5 rounded-2xl shadow-ios-float flex flex-col items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-[3px] border-gray-200 border-t-iosBlue mb-3"></div>
      <div class="text-xs font-medium text-sub">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- 2. ç™»å½•å¡ç‰‡ -->
  <section id="loginCard" class="w-full bg-iosCard rounded-2xl shadow-ios-card p-6 mb-8 relative overflow-hidden animate-fade-in border border-white/60">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-ink tracking-tight">ç™»å½•</h2>
      <div class="flex items-center gap-1.5 bg-gray-100 px-2 py-1 rounded-full border border-gray-100">
        <div class="w-1.5 h-1.5 rounded-full bg-iosGreen animate-pulse"></div>
        <span class="text-[11px] font-semibold text-sub">ONLINE</span>
      </div>
    </div>

    <div class="space-y-4">
      <!-- Username -->
      <div class="group">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub flex items-center gap-1.5 uppercase tracking-wide">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Identification%20card/3D/identification_card_3d.png" class="w-4 h-4 grayscale opacity-70">
          å­¦å·
        </label>
        <input type="text" id="username"
               class="w-full text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 py-3 font-medium focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all placeholder:text-gray-400 focus:outline-none"
               placeholder="è¯·è¾“å…¥å­¦å·">
      </div>

      <!-- Password -->
      <div class="group">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub flex items-center gap-1.5 uppercase tracking-wide">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Key/3D/key_3d.png" class="w-4 h-4 grayscale opacity-70">
          å¯†ç 
        </label>
        <input type="password" id="password"
               class="w-full text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 py-3 font-medium focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all placeholder:text-gray-400 focus:outline-none"
               placeholder="æ™ºæ…§æ–‡ç†å¯†ç ">
      </div>

      <!-- Captchaï¼šæŒ‰éœ€åŠ è½½ï¼ˆä»… NEED_CAPTCHA æˆ–ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æ—¶è¯·æ±‚ï¼‰ -->
      <div id="captchaBlock" class="hidden">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub">éªŒè¯ç </label>
        <div class="flex gap-3 h-[48px]">
          <input type="text" id="captcha" placeholder="ABCD"
                 class="flex-1 min-w-0 text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 font-medium uppercase focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all focus:outline-none">
          <div class="w-28 rounded-xl bg-gray-50 cursor-pointer overflow-hidden relative group shrink-0 active:opacity-70 transition-opacity border border-gray-200"
               onclick="initCaptcha(true, true)">
            <img id="captchaImg" class="w-full h-full object-fill hidden">
            <div id="captchaText" class="absolute inset-0 flex items-center justify-center text-[11px] font-bold text-iosBlue/70">ç‚¹å‡»åˆ·æ–°</div>
          </div>
        </div>
      </div>

      <!-- Remember Me -->
      <div class="flex items-center justify-between pt-1">
        <label class="flex items-center gap-2.5 cursor-pointer select-none group py-1">
          <input id="rememberMe" type="checkbox" class="ios-checkbox">
          <span class="text-[15px] text-ink font-medium">è®°ä½æˆ‘</span>
        </label>
      </div>

      <button id="loginBtn" onclick="handleLogin()"
              class="w-full bg-iosBlue text-white text-[17px] font-bold py-3.5 rounded-xl shadow-sm hover:bg-iosBlue/90 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2">
        <span>è¿›å…¥ç³»ç»Ÿ</span>
      </button>
    </div>
  </section>

  <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
  <section id="dataArea" class="hidden w-full space-y-6 animate-slide-up">

    <!-- 3. ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card p-4 flex items-center gap-4 relative overflow-hidden border border-white/60 group">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Identification%20card/3D/identification_card_3d.png"
           class="absolute -right-4 -bottom-4 w-24 h-24 opacity-10 rotate-[-15deg] pointer-events-none grayscale">

      <!-- å¤´åƒï¼šApple emoji ğŸ„ï¼ˆiOS é»˜è®¤æ˜¾ç¤º Apple é£æ ¼ï¼‰ -->
      <div class="w-16 h-16 bg-gray-100 rounded-full border border-gray-100 flex items-center justify-center shrink-0 overflow-hidden shadow-inner z-10">
        <div id="userAvatar" class="w-full h-full flex items-center justify-center text-[34px] leading-none select-none">ğŸ„</div>
      </div>

      <div class="flex-1 min-w-0 z-10">
        <div class="flex items-center gap-2 mb-0.5">
          <h2 class="text-[20px] font-bold text-ink tracking-tight truncate" id="uiName">--</h2>
          <span class="px-1.5 py-[1px] rounded bg-iosBlue/10 text-iosBlue text-[10px] font-bold border border-iosBlue/10">STUDENT</span>
        </div>
        <div class="space-y-0.5 text-sub text-[13px] font-medium">
          <div class="flex items-center gap-1.5">
            <span class="opacity-70">ID</span>
            <span id="uiId" class="font-mono text-ink">--</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="opacity-70">CL</span>
            <span id="uiClass" class="text-ink truncate">--</span>
          </div>
        </div>
      </div>

      <button onclick="handleLogout(true)"
              class="shrink-0 p-2 text-sub hover:text-iosRed bg-gray-50 hover:bg-red-50 rounded-full transition-all z-10"
              title="é€€å‡ºç™»å½•">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
        </svg>
      </button>
    </div>

    <!-- 4. ä¸€å¡é€šå¡ç‰‡ -->
    <div class="w-full bg-white border border-gray-200 rounded-2xl shadow-ios-card p-5 flex flex-col justify-between relative overflow-hidden h-[150px] group transition-all hover:shadow-ios-float active:scale-[0.99]">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Credit%20card/3D/credit_card_3d.png"
           class="absolute -right-4 -bottom-4 w-24 h-24 opacity-20 rotate-[-10deg] group-hover:rotate-0 group-hover:scale-105 transition-all duration-300 z-0 grayscale">

      <div class="flex justify-between items-start z-10 relative">
        <div class="flex items-center gap-3">
          <svg width="36" height="26" viewBox="0 0 40 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
            <rect width="40" height="28" rx="4" fill="#F0F0F0"/>
            <rect x="2" y="2" width="36" height="24" rx="2" stroke="#999" stroke-opacity="0.2" stroke-width="1"/>
            <path d="M12 2V26" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M28 2V26" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M2 14H12" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M28 14H38" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <rect x="15" y="8" width="10" height="12" rx="2" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
          </svg>
          <span class="text-[11px] font-bold tracking-widest uppercase text-sub mt-1">Campus Card</span>
        </div>
        <span class="px-2 py-0.5 bg-gray-100 rounded border border-gray-200 text-[10px] font-bold text-sub" id="ecStatus">--</span>
      </div>

      <div class="z-10 mt-1 flex justify-between items-end relative">
        <div class="flex flex-col">
          <span class="text-[10px] text-sub font-semibold uppercase mb-0.5 ml-0.5">Balance</span>
          <div class="text-4xl font-bold tracking-tighter flex items-baseline gap-1 text-ink">
            <span class="text-lg text-iosYellow font-bold">Â¥</span>
            <span id="ecBalance" class="drop-shadow-sm">--</span>
          </div>
        </div>
        <button onclick="loadEcard(true)" class="p-2 rounded-full bg-gray-50 border border-gray-100 hover:bg-gray-100 active:scale-90 transition-all text-sub">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
          </svg>
        </button>
      </div>
    </div>

    <!-- è¯¾è¡¨ -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card overflow-hidden border border-white/60">
      <div class="flex items-center justify-between p-4 border-b border-gray-100 bg-white/50 backdrop-blur-sm">
        <div class="flex items-center gap-3">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Spiral%20calendar/3D/spiral_calendar_3d.png" class="w-8 h-8 icon-3d">
          <div>
            <h3 class="text-[17px] font-bold tracking-tight text-ink">æœ¬å‘¨è¯¾è¡¨</h3>
            <span class="text-[11px] font-medium text-sub" id="schWeek">Loading...</span>
          </div>
        </div>
        <button onclick="loadSchedule(true)" class="text-[13px] font-bold text-iosBlue bg-iosBlue/5 px-3 py-1.5 rounded-full hover:bg-iosBlue/10 active:scale-95 transition-all">
          åˆ·æ–°
        </button>
      </div>
      <div class="overflow-x-auto hide-scroll pb-2 bg-white">
        <div class="min-w-[160vw] md:min-w-full" id="scheduleContainer"></div>
      </div>
    </div>

    <!-- 5. æˆç»© -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card overflow-hidden transition-all duration-300 border border-white/60" data-panel="grades" data-open="false">
      <div class="flex items-center justify-between p-4 border-b border-gray-100 cursor-pointer active:bg-gray-50 transition-colors" onclick="togglePanel('grades')">
        <div class="flex items-center gap-3">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Trophy/3D/trophy_3d.png" class="w-8 h-8 icon-3d">
          <div class="flex flex-col items-start">
            <div class="flex items-center gap-2">
              <h3 class="text-[17px] font-bold tracking-tight text-ink">æˆç»©å•</h3>
              <span id="gradeSource" class="px-1.5 py-0.5 text-[10px] font-bold bg-gray-100 rounded text-sub hidden transform scale-90 origin-left"></span>
            </div>
            <span class="text-[11px] font-medium text-sub">ç‚¹å‡»å±•å¼€/æ”¶èµ·</span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="event.stopPropagation(); refreshGradesButton()"
                  class="text-[13px] font-bold text-iosBlue bg-iosBlue/5 px-3 py-1.5 rounded-full hover:bg-iosBlue/10 active:scale-95 transition-all">
            åˆ·æ–°
          </button>
          <div class="w-6 h-6 flex items-center justify-center transition-transform duration-300" id="gradeArrow">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          </div>
        </div>
      </div>

      <div id="panelContent-grades" class="hidden bg-iosBg">
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
              <div class="text-[10px] text-sub mb-1 uppercase tracking-wider font-bold">Credits</div>
              <div id="gCredits" class="text-2xl font-bold text-ink tracking-tight">--</div>
            </div>
            <div class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
              <div class="text-[10px] text-sub mb-1 uppercase tracking-wider font-bold">GPA</div>
              <div id="gGpa" class="text-2xl font-bold text-iosTeal tracking-tight">--</div>
            </div>
          </div>

          <div id="gradeList" class="space-y-4 min-h-[100px]"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- åº•éƒ¨åŒºåŸŸ -->
  <footer class="mt-8 mb-4 w-full flex justify-center">
    <button onclick="toggleAboutModal(true)"
            class="group flex items-center gap-2 px-5 py-2.5 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-300">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Information/3D/information_3d.png" class="w-4 h-4 group-hover:rotate-12 transition-transform">
      <span class="text-[12px] font-semibold text-sub group-hover:text-ink">å…³äºæœåŠ¡</span>
    </button>
  </footer>

  <!-- å…³äºæœåŠ¡ Modal -->
  <div id="aboutModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-6">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px] transition-opacity" onclick="toggleAboutModal(false)"></div>
    <div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-ios-float w-full max-w-sm p-6 relative z-10 animate-fade-in text-center">
      <div class="mb-5">
        <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Rocket/3D/rocket_3d.png"
             width="64" height="64"
             class="mx-auto mb-3 drop-shadow-md icon-3d"
             alt="Rocket">
        <h3 class="text-lg font-bold text-ink">å…³äºæ–‡ç†å°åŠ©æ‰‹</h3>
        <p class="text-[11px] font-medium text-sub mt-1">Version 1.0.3 (Stable)</p>
      </div>

      <div class="space-y-3 text-[13px] font-medium text-sub leading-relaxed bg-gray-50/50 p-4 rounded-xl border border-gray-100 mb-6 text-left">
        <p class="flex gap-2"><span>ğŸ“</span> <span class="text-ink">çº¯å‡€æ— å¹¿ï¼Œä»…æä¾›æ ¸å¿ƒæŸ¥è¯¢ã€‚</span></p>
        <p class="flex gap-2"><span>ğŸ”’</span> <span class="text-ink">æœ¬åœ°ç›´è¿ï¼Œä¸å­˜å‚¨ä»»ä½•å¯†ç ã€‚</span></p>
        <p class="flex gap-2"><span>ğŸ”¨</span> <span class="text-ink">åé¦ˆè”ç³»ï¼š-nullsleep</span></p>
        <p class="flex gap-2">
          <span>ğŸ“¶</span>
          <a href="http://8.134.208.242:13001/dashboard" class="text-iosBlue font-semibold underline decoration-iosBlue/30 underline-offset-2" target="_blank">
            æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
          </a>
        </p>
      </div>

      <button onclick="toggleAboutModal(false)" class="w-full bg-iosBlue text-white font-bold py-3 rounded-xl active:opacity-70 transition-opacity">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
    /*****************************************************************
     * âœ… æœ¬æ¬¡ä¿®å¤ï¼ˆé’ˆå¯¹ä½ æå‡ºçš„é—®é¢˜ï¼‰
     *
     * ç°è±¡ï¼š
     *   localStorage.removeItem('huas_token'); globalToken = '';
     *   ç„¶åè§¦å‘åˆ·æ–°ï¼Œåªå¼¹â€œè¯·å…ˆç™»å½•â€ï¼Œä¸ä¼šè‡ªåŠ¨é‡ç™»ã€‚
     *
     * æ ¹å› ï¼š
     *   ä¹‹å‰ loadXxx() é¡¶éƒ¨ if (!globalToken) ç›´æ¥ return / alertï¼Œ
     *   è¯·æ±‚æ ¹æœ¬æ²¡å‘å‡ºå»ï¼Œå› æ­¤ apiFetch çš„ 401 è‡ªåŠ¨é‡ç™»é“¾è·¯æ²¡æœºä¼šè·‘ã€‚
     *
     * ä¿®å¤ï¼š
     *   1) apiFetchï¼šå³ä½¿æ²¡æœ‰ token ä¹Ÿä¼šå°è¯• ensureRelogin()ï¼ˆquiet è‡ªåŠ¨ç™»å½•ï¼‰
     *   2) ç§»é™¤å„ loadXxx é¡¶éƒ¨çš„ â€œæ—  token ç›´æ¥ return alertâ€
     *   3) ä¿æŒå¥å£®æ€§ï¼šsingle-flight é‡ç™»ã€é‡è¯•ä¸€æ¬¡ã€éªŒè¯ç æŒ‰éœ€ã€é”™è¯¯åˆ†æµ
     *
     * é¢å¤–å¢å¼ºï¼ˆå¥å£®æ€§ï¼‰ï¼š
     *   - sessionVersion ä»…åœ¨ logout æ—¶é€’å¢ï¼ˆé¿å…â€œè‡ªåŠ¨é‡ç™»â€å¯¼è‡´å“åº”è¢«è¯¯åˆ¤ä¸º staleï¼‰
     *   - authVersion è®°å½• token å˜æ›´ï¼ˆä¾¿äºè°ƒè¯•è¿½è¸ªï¼‰
     *   - handleLogout æ”¯æŒ keepCaptchaStateï¼šè‡ªåŠ¨é‡ç™»é‡åˆ° NEED_CAPTCHA æ—¶å¯ä¿ç•™éªŒè¯ç çŠ¶æ€
     *   - è°ƒè¯•ä¿¡æ¯å…¨è¦†ç›–ï¼šæ¯ä¸ªå…³é”®åˆ†æ”¯éƒ½ console.log / warn / error
     *****************************************************************/

    const API_BASE = '';  // åŒæºéƒ¨ç½²å»ºè®®ç•™ç©º
    const DEBUG = true;   // å…³é—­æ—¥å¿—å¯è®¾ false

    // iOS ä½é¥±å’Œç³–æœè‰²
    const COURSE_COLORS = [
      'bg-[#E8F2FF] border-[#B6D6F5] text-[#004085]',
      'bg-[#E8F8F5] border-[#A3E4D7] text-[#0E6251]',
      'bg-[#FEF9E7] border-[#F9E79F] text-[#9C640C]',
      'bg-[#FFF0F0] border-[#F5B7B1] text-[#922B21]',
      'bg-[#F3E5F5] border-[#D7BDE2] text-[#6A1B9A]',
      'bg-[#E0F2F1] border-[#80CBC4] text-[#004D40]',
      'bg-[#FBE9E7] border-[#FFCCBC] text-[#BF360C]'
    ];

    /***********************
     * 0) æ—¥å¿—å·¥å…·ï¼ˆå…¨è¦†ç›–ï¼‰
     ***********************/
    const log  = (...args) => DEBUG && console.log('%c[UI]', 'color:#007AFF;font-weight:bold', ...args);
    const warn = (...args) => DEBUG && console.warn('%c[UI]', 'color:#FF9500;font-weight:bold', ...args);
    const err  = (...args) => DEBUG && console.error('%c[UI]', 'color:#FF3B30;font-weight:bold', ...args);
    function group(title, fn) {
      if (!DEBUG) return fn();
      console.groupCollapsed(`%c[UI] ${title}`, 'color:#007AFF;font-weight:bold');
      try { return fn(); } finally { console.groupEnd(); }
    }

    /***********************
     * 1) å…¨å±€çŠ¶æ€
     ***********************/
    let currentSessionId = '';
    let requireCaptcha = false;

    // å•é£é‡ç™» Promiseï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è§¦å‘åªç™»å½•ä¸€æ¬¡
    let reauthPromise = null;
    let isRelogging = false;

    // ç™»å½•äº’æ–¥é”ï¼šé˜²æ­¢ç”¨æˆ·ç‹‚ç‚¹â€œè¿›å…¥ç³»ç»Ÿâ€
    let loginPromise = null;

    // âœ… åªåœ¨ logout æ—¶é€’å¢ï¼šç”¨äºé˜²æ­¢â€œç™»å‡ºåæ—§è¯·æ±‚å†™å›â€
    let sessionVersion = 0;

    // âœ… ä»…ç”¨äºè°ƒè¯•ï¼šæ¯æ¬¡ token å˜æ›´éƒ½ä¼šé€’å¢ï¼ˆè§‚å¯Ÿ token ç”Ÿå‘½å‘¨æœŸï¼‰
    let authVersion = 0;

    // é¢æ¿åŠ è½½æ ‡è®°
    const panelLoaded = { schedule: false, grades: false, ecard: false, user: false };
    let autoLoginAttempted = false;

    // tokenï¼ˆè¿è¡Œæ€ï¼‰ä¸æœ¬åœ°å­˜å‚¨
    let globalToken = localStorage.getItem('huas_token') || '';

    // ä¿å­˜å‡­æ®ï¼ˆæŒ‰ä½ è¦æ±‚ï¼šä¸æ”¹â€œ#6â€ï¼Œä»ä¿ç•™æ˜æ–‡å­˜å‚¨é€»è¾‘ï¼‰
    const SAVED_CRED_KEY = 'huas_saved_cred';
    const SAVED_CRED_KEYS = [SAVED_CRED_KEY, 'huas_saved_cred_bak1', 'huas_saved_cred_bak2'];
    const IDB_CONFIG = { name: 'huasCredDB', store: 'creds', key: 'primary' };

    // é˜²é‡å¤å¼¹çª—
    let reauthFailedNotified = false;
    let noTokenNotified = false;

    /***********************
     * 2) UI å·¥å…·
     ***********************/
    function setLoading(isLoading) {
      document.getElementById('loading').classList.toggle('hidden', !isLoading);
    }
    function showLogin() {
      document.getElementById('dataArea').classList.add('hidden');
      document.getElementById('loginCard').classList.remove('hidden');
    }
    function showData() {
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('dataArea').classList.remove('hidden');
    }
    function bumpSessionVersion(reason = '') {
      sessionVersion += 1;
      log('sessionVersion++ =>', sessionVersion, reason ? `(reason: ${reason})` : '');
    }
    function setLoginButtonDisabled(disabled) {
      const btn = document.getElementById('loginBtn');
      if (!btn) return;
      btn.disabled = disabled;
      btn.classList.toggle('opacity-60', disabled);
      btn.classList.toggle('pointer-events-none', disabled);
    }
    function toggleAboutModal(show) {
      const modal = document.getElementById('aboutModal');
      modal.classList.toggle('hidden', !show);
    }

    /***********************
     * 3) Token ç»Ÿä¸€å…¥å£ï¼ˆä¿è¯æ—¥å¿—/ç‰ˆæœ¬ä¸€è‡´ï¼‰
     *
     * - æ‰€æœ‰è®¾ç½® token çš„åœ°æ–¹å¿…é¡»èµ° setToken()
     * - ä¾¿äºè°ƒè¯• token æ˜¯è°æ”¹çš„ã€ä½•æ—¶æ”¹çš„
     ***********************/
    function setToken(token, reason = '') {
      globalToken = token || '';
      authVersion += 1;

      if (globalToken) localStorage.setItem('huas_token', globalToken);
      else localStorage.removeItem('huas_token');

      log('setToken()', {
        authVersion,
        hasToken: !!globalToken,
        tokenPreview: globalToken ? String(globalToken).slice(0, 12) + '...' : '',
        reason
      });
    }

    /***********************
     * 4) Fetch å°è£…ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šNO_TOKEN ä¹Ÿè‡ªåŠ¨ç™»å½•ï¼‰
     *
     * âœ… è¡Œä¸ºï¼š
     *   - å¦‚æœæ²¡æœ‰ tokenï¼šå…ˆ ensureRelogin()ï¼ˆquiet è‡ªåŠ¨ç™»å½•ï¼‰
     *   - å¦‚æœ 401ï¼šå† ensureRelogin()ï¼ŒæˆåŠŸåé‡è¯•ä¸€æ¬¡
     *   - retry=falseï¼šé¿å…æ— é™é€’å½’/æ­»å¾ªç¯
     ***********************/
    async function apiFetch(path, { method = 'GET', headers = {}, body, cache = 'no-store', retry = true } = {}) {
      const url = `${API_BASE}${path}`;

      // âœ… å…³é”®ä¿®å¤ï¼šæ—  token ä¸å†ç›´æ¥å¤±è´¥ï¼Œè€Œæ˜¯å°è¯•è‡ªåŠ¨ç™»å½•
      if (!globalToken) {
        warn('apiFetch: NO_TOKEN -> try ensureRelogin()', { url, retry, authVersion, sessionVersion });

        if (!retry) throw new Error('NO_TOKEN');

        const ok = await ensureRelogin('NO_TOKEN');
        if (!ok || !globalToken) {
          warn('apiFetch: ensureRelogin failed -> still NO_TOKEN', { url, ok, hasToken: !!globalToken });
          throw new Error('NO_TOKEN');
        }

        log('apiFetch: ensureRelogin success -> token restored', { url, authVersion });
      }

      log('apiFetch ->', { url, method, retry, hasToken: !!globalToken, authVersion, sessionVersion });

      const res = await fetch(url, {
        method,
        headers: {
          ...headers,
          Authorization: globalToken,
          ...(body ? { 'Content-Type': 'application/json' } : {}),
        },
        body: body ? JSON.stringify(body) : undefined,
        cache
      });

      // é 401ï¼šç›´æ¥è¿”å›
      if (res.status !== 401) return res;

      // 401ï¼šä¼šè¯è¿‡æœŸ
      warn('apiFetch: got 401 -> SESSION_EXPIRED', { url, retry });

      if (!retry) throw new Error('SESSION_EXPIRED');

      const ok = await ensureRelogin('401');
      if (!ok) throw new Error('SESSION_EXPIRED');

      // é‡ç™»æˆåŠŸ -> é‡è¯•ä¸€æ¬¡ï¼ˆretry=false é˜²æ­¢æ­»å¾ªç¯ï¼‰
      return apiFetch(path, { method, headers, body, cache, retry: false });
    }

    /***********************
     * 5) ensureReloginï¼ˆsingle-flightï¼‰
     *
     * - NO_TOKEN å’Œ 401 éƒ½èµ°è¿™é‡Œ
     * - å¤šä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶è§¦å‘ï¼šåªä¼šç™»å½•ä¸€æ¬¡
     ***********************/
    async function ensureRelogin(trigger = '') {
      if (!reauthPromise) {
        reauthPromise = (async () => {
          group(`ensureRelogin(trigger=${trigger})`, () => {
            log('start', { isRelogging, requireCaptcha, hasToken: !!globalToken, authVersion, sessionVersion });
          });

          // å¦‚æœå·²ç»æœ‰ token äº†ï¼ˆå¯èƒ½è¢«åˆ«çš„å¹¶å‘è¯·æ±‚ä¿®å¤äº†ï¼‰ï¼Œç›´æ¥æˆåŠŸ
          if (globalToken) {
            log('ensureRelogin: already has token -> skip login');
            return true;
          }

          const ok = await tryAutoRelogin();
          log('ensureRelogin: result', { ok, hasToken: !!globalToken, authVersion });

          return ok;
        })().finally(() => {
          reauthPromise = null;
          log('ensureRelogin: end (reauthPromise cleared)');
        });
      } else {
        log('ensureRelogin: reuse existing reauthPromise (single-flight)');
      }
      return reauthPromise;
    }

    /***********************
     * 6) éªŒè¯ç ï¼šæŒ‰éœ€åŠ è½½
     ***********************/
    async function initCaptcha(forceShow = false, withSpinner = false) {
      if (withSpinner) setLoading(true);

      group('initCaptcha()', () => {
        log('params', { forceShow, withSpinner, requireCaptcha, currentSessionId });
      });

      try {
        const res = await fetch(`${API_BASE}/auth/captcha`, { cache: 'no-store' });
        const json = await res.json();
        log('captcha response', json);

        if (json.code === 200) {
          currentSessionId = json.data.sessionId;

          const img = document.getElementById('captchaImg');
          img.src = 'data:image/png;base64,' + json.data.image;
          img.classList.remove('hidden');
          document.getElementById('captchaText').classList.add('hidden');

          if (forceShow) {
            requireCaptcha = true;
            document.getElementById('captchaBlock').classList.remove('hidden');
          } else if (!requireCaptcha) {
            document.getElementById('captchaBlock').classList.add('hidden');
          }
        } else {
          alert('éªŒè¯ç è·å–å¤±è´¥: ' + json.msg);
        }
      } catch (e) {
        err('initCaptcha error', e);
        alert('éªŒè¯ç è¯·æ±‚é”™è¯¯');
      } finally {
        if (withSpinner) setLoading(false);
      }
    }

    async function ensureCaptchaSession(forceShow = false, withSpinner = false) {
      if (!currentSessionId) {
        log('ensureCaptchaSession: no sessionId -> initCaptcha');
        await initCaptcha(forceShow, withSpinner);
        return;
      }
      if (forceShow) {
        requireCaptcha = true;
        document.getElementById('captchaBlock').classList.remove('hidden');
      }
    }

    /***********************
     * 7) ç™»å½•ï¼šæŒ‰é’®ç‚¹å‡»ï¼ˆäº¤äº’ç™»å½•ï¼‰
     ***********************/
    async function handleLogin() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      const c = document.getElementById('captcha').value;

      if (!u || !p) return alert('è¯·å¡«å†™å­¦å·å’Œå¯†ç ');
      if (requireCaptcha && !c) return alert('è¯·è¾“å…¥éªŒè¯ç ');

      // å¦‚æœéœ€è¦éªŒè¯ç ï¼Œä½†å½“å‰æ²¡æœ‰ sessionIdï¼Œåˆ™æŒ‰éœ€æ‹‰å–
      await ensureCaptchaSession(requireCaptcha, true);

      setLoginButtonDisabled(true);
      setLoading(true);

      try {
        const ok = await performLoginGuarded(u, p, c, false);
        if (!ok) return;

        // ç™»å½•æˆåŠŸï¼šè¿›å…¥æ•°æ®åŒº
        showData();
        await loadAllData(false);
      } finally {
        setLoading(false);
        setLoginButtonDisabled(false);
      }
    }

    // ç™»å½•äº’æ–¥é”ï¼šé¿å…å¹¶å‘ performLogin
    async function performLoginGuarded(username, password, captcha, quiet = false) {
      if (!loginPromise) {
        loginPromise = performLogin(username, password, captcha, quiet, 0)
          .finally(() => (loginPromise = null));
      } else {
        log('performLoginGuarded: reuse loginPromise');
      }
      return loginPromise;
    }

    /***********************
     * 8) performLoginï¼šçœŸæ­£çš„ç™»å½•è¯·æ±‚
     *
     * - quiet=trueï¼šç”¨äºè‡ªåŠ¨é‡ç™»/è‡ªåŠ¨ç™»å½•ï¼Œä¸å¼¹çª—ï¼ˆé™¤éå¿…é¡»æç¤ºï¼‰
     * - retryCountï¼šä¼šè¯IDæ— æ•ˆè‡ªæ„ˆæœ€å¤š 1 æ¬¡
     ***********************/
    async function performLogin(username, password, captcha, quiet = false, retryCount = 0) {
      group(`performLogin(quiet=${quiet})`, () => {
        log('payload draft', {
          username,
          hasPwd: !!password,
          hasCaptcha: !!captcha,
          requireCaptcha,
          currentSessionId,
          retryCount
        });
      });

      try {
        const payload = { sessionId: currentSessionId, username, password };
        if (requireCaptcha || captcha) payload.code = captcha;

        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        log('login response', json);

        // âœ… ç™»å½•æˆåŠŸ
        if (json.code === 200) {
          setToken(json.token, quiet ? 'silent relogin / auto login' : 'interactive login');
          reauthFailedNotified = false;
          noTokenNotified = false;

          if (!quiet) {
            await saveCredentialsIfNeeded(username, password);
          }

          // ç™»å½•æˆåŠŸæ—¶ï¼Œéšè—éªŒè¯ç å—ï¼ˆè®© UI æ›´å¹²å‡€ï¼‰
          // æ³¨æ„ï¼šå¦‚æœåç»­åˆ NEED_CAPTCHAï¼Œä¼šå†æ˜¾ç¤º
          requireCaptcha = false;
          document.getElementById('captchaBlock').classList.add('hidden');

          return true;
        }

        // âœ… éœ€è¦éªŒè¯ç 
        if (json.action === 'NEED_CAPTCHA') {
          warn('login need captcha', json.msg);

          requireCaptcha = true;
          document.getElementById('captchaBlock').classList.remove('hidden');
          document.getElementById('captcha').value = '';

          // å¼ºåˆ¶åˆ·æ–°éªŒè¯ç å›¾ç‰‡
          await initCaptcha(true, false);

          // quiet æ¨¡å¼ä¸å¼¹â€œç™»å½•å¤±è´¥â€ï¼Œä½†ä¸ºäº†ç”¨æˆ·å¯æ“ä½œï¼Œéœ€è¦åœ¨åç»­é”™è¯¯å¤„ç†å¼•å¯¼å›ç™»å½•é¡µ
          if (!quiet) alert(json.msg || 'ç™»å½•å¤±è´¥ï¼Œéœ€è¦éªŒè¯ç ï¼Œè¯·è¾“å…¥éªŒè¯ç åå†è¯•');
          return false;
        }

        // âœ… ä¼šè¯IDæ— æ•ˆï¼šè‡ªæ„ˆåˆ·æ–° captcha sessionï¼Œæœ€å¤š 1 æ¬¡
        if (json.code === 400 && json.msg && json.msg.includes('ä¼šè¯IDæ— æ•ˆ')) {
          warn('login invalid sessionId -> refresh captcha session', { retryCount });

          if (retryCount >= 1) {
            if (!quiet) alert('ä¼šè¯å¤šæ¬¡å¤±æ•ˆï¼Œè¯·åˆ·æ–°éªŒè¯ç åé‡è¯•');
            return false;
          }

          currentSessionId = '';
          await initCaptcha(false, false);
          return performLogin(username, password, '', quiet, retryCount + 1);
        }

        // å…¶å®ƒå¤±è´¥
        warn('login failed', json.msg);
        if (!quiet) alert('ç™»å½•å¤±è´¥: ' + (json.msg || 'æœªçŸ¥é”™è¯¯'));

        // å¦‚æœå½“å‰å¤„äºéªŒè¯ç æ¨¡å¼ï¼Œé¡ºä¾¿åˆ·æ–°éªŒè¯ç ï¼Œé¿å…ç”¨æˆ·ä¸€ç›´å¡«æ—§å›¾
        if (requireCaptcha) await initCaptcha(true, false);

        return false;
      } catch (e) {
        err('login error', e);
        if (!quiet) alert('ç™»å½•è¯·æ±‚é”™è¯¯');
        return false;
      }
    }

    /***********************
     * 9) tryAutoReloginï¼šè‡ªåŠ¨é‡ç™»/è‡ªåŠ¨ç™»å½•ï¼ˆquietï¼‰
     *
     * âœ… è§¦å‘æ¡ä»¶ï¼š
     *   - apiFetch å‘ç° NO_TOKEN
     *   - apiFetch å‘ç° 401
     *
     * âœ… è¡Œä¸ºï¼š
     *   - è¯»å–ä¿å­˜çš„è´¦å·å¯†ç 
     *   - æŒ‰éœ€æ‹‰ captcha sessionIdï¼ˆä¸å¼ºåˆ¶æ˜¾ç¤ºéªŒè¯ç å—ï¼‰
     *   - quiet ç™»å½•
     ***********************/
    async function tryAutoRelogin() {
      if (isRelogging) {
        warn('tryAutoRelogin: already relogging -> skip');
        return false;
      }

      const saved = await getSavedCredentials();
      if (!saved || !saved.username || !saved.password || saved.remember !== true) {
        warn('tryAutoRelogin: no saved credentials / remember not true', saved);
        return false;
      }

      isRelogging = true;
      group('tryAutoRelogin()', () => {
        log('saved credentials found', { username: saved.username, remember: saved.remember });
      });

      try {
        // è‡ªåŠ¨é‡ç™»ä¸éœ€è¦å±•ç¤ºéªŒè¯ç å—ï¼Œä½†éœ€è¦ sessionId
        currentSessionId = '';
        requireCaptcha = false;
        await ensureCaptchaSession(false, false);

        const ok = await performLogin(saved.username, saved.password, '', true);
        log('tryAutoRelogin result', { ok, hasToken: !!globalToken, authVersion });

        return ok;
      } finally {
        isRelogging = false;
      }
    }

    /***********************
     * 10) å¯åŠ¨ç­–ç•¥ï¼štoken æ¢æ´» -> å¹¶å‘åŠ è½½
     ***********************/
    async function appStart() {
      group('appStart()', () => {
        log('initial', { hasToken: !!globalToken, authVersion, sessionVersion });
      });

      setLoading(true);
      try {
        // å…ˆå¡«å……ä¿å­˜è´¦å·/å¯†ç ï¼ˆä¸è¯·æ±‚éªŒè¯ç ï¼‰
        await loadSavedCredentials();

        if (globalToken) {
          const ok = await bootstrapWithToken();
          if (ok) return;
        }

        const autoOk = await autoLoginOnLoad();
        if (autoOk) return;

        showLogin();
        log('appStart: stay on login');
      } finally {
        setLoading(false);
      }
    }

    async function bootstrapWithToken() {
      group('bootstrapWithToken()', () => {});
      try {
        // ç”¨ apiFetch æ¢æ´»ï¼šè‹¥ 401 åˆ™è‡ªåŠ¨é‡ç™»å¹¶é‡è¯•
        const res = await apiFetch('/api/user', { retry: true });
        const json = await res.json();
        log('token probe success -> /api/user', json);

        showData();
        renderUser(json.data);

        await Promise.all([
          loadEcard(false, false),
          loadSchedule(false, false),
        ]);

        return true;
      } catch (e) {
        warn('bootstrapWithToken failed', e);

        // å¦‚æœå¤±è´¥æ—¶ requireCaptcha=trueï¼Œè¯´æ˜è‡ªåŠ¨é‡ç™»éœ€è¦éªŒè¯ç ï¼šä¿ç•™éªŒè¯ç çŠ¶æ€ç»™ç”¨æˆ·è¾“å…¥
        if (requireCaptcha) {
          alert('è‡ªåŠ¨ç™»å½•éœ€è¦éªŒè¯ç ï¼Œè¯·åœ¨ç™»å½•é¡µè¾“å…¥éªŒè¯ç åç™»å½•');
          await handleLogout(true, true);
          return false;
        }

        alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        await handleLogout(true, false);
        return false;
      }
    }

    /***********************
     * 11) æ•°æ®åŠ è½½ï¼ˆå»æ‰â€œæ—  token ç›´æ¥ return alertâ€ï¼‰
     *
     * âœ… å…³é”®ç‚¹ï¼š
     *   - ç°åœ¨å…è®¸ globalToken ä¸ºç©ºè¿›å…¥ loadXxxï¼Œ
     *     ç”± apiFetch è´Ÿè´£è‡ªåŠ¨ç™»å½•/é‡ç™»ã€‚
     *   - v=sessionVersion ä»…åœ¨ logout æ—¶å˜åŒ–ï¼Œå› æ­¤è‡ªåŠ¨é‡ç™»ä¸ä¼šå¯¼è‡´è¯¯åˆ¤ staleã€‚
     ***********************/
    async function loadAllData(withSpinner = true) {
      const v = sessionVersion;
      log('loadAllData start', { sessionVersion: v, hasToken: !!globalToken, authVersion });

      if (withSpinner) setLoading(true);
      try {
        await Promise.all([
          loadUser(false, false),
          loadEcard(false, false),
          loadSchedule(false, false),
        ]);
      } finally {
        if (withSpinner) setLoading(false);
      }
    }

    async function loadUser(refresh = false, withSpinner = true) {
      const v = sessionVersion;
      if (withSpinner) setLoading(true);

      try {
        if (!globalToken) warn('loadUser: NO_TOKEN -> apiFetch will try auto login');

        const res = await apiFetch(`/api/user${refresh ? '?refresh=true' : ''}`, { retry: true });
        const json = await res.json();

        if (v !== sessionVersion) {
          warn('loadUser: stale response ignored', { v, sessionVersion });
          return;
        }

        renderUser(json.data);
        panelLoaded.user = true;
      } catch (e) {
        await handleFetchError(e, () => loadUser(refresh, false), 'ä¸ªäººä¿¡æ¯è·å–å¤±è´¥');
      } finally {
        if (withSpinner) setLoading(false);
      }
    }

    function renderUser(data) {
      if (!data) return;
      document.getElementById('uiName').innerText = data.name ?? '--';
      document.getElementById('uiId').innerText = data.studentId ?? '--';
      document.getElementById('uiClass').innerText = data.className ?? '--';

      // å›ºå®šå¤´åƒ ğŸ„
      const avatar = document.getElementById('userAvatar');
      if (avatar) avatar.textContent = 'ğŸ„';
    }

    async function loadEcard(refresh = false, withSpinner = true) {
      const v = sessionVersion;
      if (withSpinner) setLoading(true);

      try {
        if (!globalToken) warn('loadEcard: NO_TOKEN -> apiFetch will try auto login');

        const res = await apiFetch(`/api/ecard${refresh ? '?refresh=true' : ''}`, { retry: true });
        const json = await res.json();

        if (v !== sessionVersion) {
          warn('loadEcard: stale response ignored', { v, sessionVersion });
          return;
        }

        renderEcard(json.data);
        panelLoaded.ecard = true;
      } catch (e) {
        await handleFetchError(e, () => loadEcard(refresh, false), 'ä¸€å¡é€šè·å–å¤±è´¥');
      } finally {
        if (withSpinner) setLoading(false);
      }
    }

    function renderEcard(data) {
      if (!data) return;

      let statusText = data.status;
      if (!statusText || String(statusText).includes('æœªçŸ¥')) statusText = 'æ­£å¸¸';

      const balanceText = (data.balance === undefined || data.balance === null) ? '0.00' : data.balance;
      const elStatus = document.getElementById('ecStatus');

      elStatus.innerText = statusText;
      if (statusText === 'æ­£å¸¸') {
        elStatus.className = "px-2 py-0.5 bg-green-500/10 border border-green-500/20 rounded text-[10px] font-bold text-green-600";
      } else {
        elStatus.className = "px-2 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-[10px] font-bold text-red-600";
      }
      document.getElementById('ecBalance').innerText = balanceText;
    }

    async function loadSchedule(refresh = false, withSpinner = true) {
      const v = sessionVersion;
      if (withSpinner) setLoading(true);

      try {
        if (!globalToken) warn('loadSchedule: NO_TOKEN -> apiFetch will try auto login');

        const res = await apiFetch(`/api/schedule${refresh ? '?refresh=true' : ''}`, { retry: true });
        const json = await res.json();

        if (v !== sessionVersion) {
          warn('loadSchedule: stale response ignored', { v, sessionVersion });
          return;
        }

        renderSchedule(json.data);
        panelLoaded.schedule = true;
      } catch (e) {
        await handleFetchError(e, () => loadSchedule(refresh, false), 'è¯¾è¡¨è·å–å¤±è´¥');
      } finally {
        if (withSpinner) setLoading(false);
      }
    }

    // å›ºå®šé«˜åº¦ h-[120px] ç¡®ä¿ä¸¥æ ¼å¯¹é½
    function renderSchedule(data) {
      if (!data) return;
      document.getElementById('schWeek').innerText = data.week || 'Schedule';

      const container = document.getElementById('scheduleContainer');
      const isMobile = window.innerWidth < 768;
      const leftColWidth = isMobile ? 50 : 60;
      const dayMinWidth = isMobile ? 90 : 110;
      container.style.minWidth = `${leftColWidth + 7 * dayMinWidth}px`;

      const courseMap = {};
      if (data.courses && Array.isArray(data.courses)) {
        data.courses.forEach(c => {
          const match = c.section?.match?.(/(\d+)/);
          if (!match) return;
          const startNode = parseInt(match[1]);
          const sectionIdx = Math.floor((startNode - 1) / 2);
          const dayIdx = (c.day || 1) - 1;
          const key = `${dayIdx}_${sectionIdx}`;
          if (!courseMap[key]) courseMap[key] = [];
          courseMap[key].push(c);
        });
      }

      let html = `<div class="grid" style="grid-template-columns:${leftColWidth}px repeat(7, minmax(${dayMinWidth}px,1fr));">`;
      html += `<div class="sticky-col sticky-shadow bg-[#FFFFFF] border-b border-r border-gray-100 z-40" style="width:${leftColWidth}px"></div>`;

      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const todayColIdx = (new Date().getDay() + 6) % 7;

      days.forEach((d, i) => {
        const isToday = i === todayColIdx;
        const bgClass = isToday ? 'text-iosBlue bg-iosBlue/5 font-bold' : 'text-sub font-semibold';
        html += `<div class="text-center text-[11px] py-3 border-b border-gray-100 ${bgClass}" data-day="${i}">${d}</div>`;
      });

      const sections = ['1-2', '3-4', '5-6', '7-8', '9-10', '11-12'];
      for (let s = 0; s < 6; s++) {
        html += `
          <div class="sticky-col sticky-shadow flex items-center justify-center font-semibold text-sub bg-[#FFFFFF] border-r border-b border-gray-100 text-[10px] z-30" style="width:${leftColWidth}px">
            ${sections[s]}
          </div>
        `;

        for (let d = 0; d < 7; d++) {
          const courses = courseMap[`${d}_${s}`];
          const colBg = d === todayColIdx ? 'bg-iosBlue/5' : '';
          html += `<div class="p-1 border-b border-gray-100 border-r border-gray-100 ${colBg} h-[120px] relative" data-day="${d}">`;

          if (courses && courses.length > 0) {
            html += `<div class="flex flex-col gap-1 h-full">`;
            courses.forEach((course, idx) => {
              const colorIdx = (d + s + idx) % COURSE_COLORS.length;
              const bgClass = COURSE_COLORS[colorIdx];
              html += `
                <div class="course-card flex-1 ${bgClass} border border-transparent rounded-lg p-2 shadow-sm cursor-pointer flex flex-col justify-between relative overflow-hidden group hover:shadow-md transition-all duration-200" title="${course.name || ''}">
                  <div class="font-bold text-[11px] text-ink leading-tight line-clamp-3 z-10 relative mb-1">
                    ${course.name || '--'}
                  </div>
                  ${course.location ? `
                    <div class="flex justify-start z-10 relative">
                      <div class="inline-flex items-start bg-white/60 px-1.5 py-0.5 rounded text-[9px] font-semibold text-ink/80 backdrop-blur-sm max-w-full leading-tight flex-col">
                        <span class="break-words">${String(course.location).replace('æ ¡æœ¬éƒ¨', '').replace(/(æ¥¼)[A-Za-z]?\d+.*/, '$1')}</span>
                        <span class="text-[10px] font-bold">${(String(course.location).match(/(æ¥¼)([A-Za-z]?\d+)/) || [,'',''])[2]}</span>
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            });
            html += `</div>`;
          }

          html += `</div>`;
        }
      }

      html += `</div>`;
      container.innerHTML = html;
    }

    async function loadGrades(refresh = false) {
      const v = sessionVersion;
      setLoading(true);

      try {
        if (!globalToken) warn('loadGrades: NO_TOKEN -> apiFetch will try auto login');

        const res = await apiFetch(`/api/grades${refresh ? '?refresh=true' : ''}`, { retry: true });
        const json = await res.json();

        if (v !== sessionVersion) {
          warn('loadGrades: stale response ignored', { v, sessionVersion });
          return;
        }

        if (json.code && json.code !== 200) throw new Error(json.msg || 'æˆç»©è·å–å¤±è´¥');
        renderGrades(json.data);
        panelLoaded.grades = true;
      } catch (e) {
        await handleFetchError(e, () => loadGrades(refresh), 'æˆç»©è·å–å¤±è´¥');
      } finally {
        setLoading(false);
      }
    }

    function renderGrades(data) {
      if (!data) return;

      const summary = data.summary || {};
      document.getElementById('gCredits').innerText = summary.totalCredits ?? '--';
      document.getElementById('gGpa').innerText = summary.averageGpa ?? '--';

      const sourceEl = document.getElementById('gradeSource');
      if (data._source) {
        sourceEl.innerText = String(data._source).toUpperCase();
        sourceEl.classList.remove('hidden');
      } else {
        sourceEl.innerText = '';
        sourceEl.classList.add('hidden');
      }

      const list = document.getElementById('gradeList');
      list.innerHTML = '';

      const items = data.items || [];
      if (!items.length) {
        list.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 border border-dashed border-gray-200 rounded-xl bg-gray-50/50">
            <div class="text-3xl grayscale opacity-30 mb-2">ğŸ’¯</div>
            <div class="text-xs font-bold text-sub">æš‚æ— æˆç»©æ•°æ®</div>
            <div class="text-[10px] text-gray-400 mt-1">è¯·å°è¯•åˆ·æ–°æˆ–è¯„æ•™åå†è¯•</div>
          </div>`;
        return;
      }

      const groupMap = {};
      items.forEach(item => {
        const term = item.term || 'æœªçŸ¥å­¦æœŸ';
        if (!groupMap[term]) groupMap[term] = [];
        groupMap[term].push(item);
      });

      const parseTerm = (term) => {
        const m = String(term).match(/(\d{4}).*?(\d{4}).*?(\d+)/);
        if (m) return { y1: parseInt(m[1]), y2: parseInt(m[2]), sem: parseInt(m[3]) };
        return null;
      };

      const sortedTerms = Object.keys(groupMap).sort((a, b) => {
        const pa = parseTerm(a); const pb = parseTerm(b);
        if (pa && pb) {
          if (pa.y1 !== pb.y1) return pb.y1 - pa.y1;
          if (pa.y2 !== pb.y2) return pb.y2 - pa.y2;
          return (pb.sem || 0) - (pa.sem || 0);
        }
        return String(b).localeCompare(String(a));
      });

      sortedTerms.forEach(term => {
        list.innerHTML += `
          <div class="px-2 py-1 text-[11px] font-semibold text-sub uppercase tracking-wider mt-4">
            ${term}
          </div>
          <div class="bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm">
        `;

        const termItems = groupMap[term];
        termItems.forEach((item, index) => {
          const passTag = item.pass === null ? '' : item.pass ? 'text-iosGreen' : 'text-iosRed';
          const scoreText = item.score !== null ? item.score : item.scoreText || '--';
          const natureText = item.courseCategory || item.courseAttribute || '';
          const natureRow = natureText ? `
            <div class="flex items-center justify-between text-[11px] text-sub mt-1">
              <span class="bg-gray-100 px-1 rounded">${natureText}</span>
            </div>` : '';
          const borderClass = index === termItems.length - 1 ? '' : 'border-b border-gray-100';

          list.innerHTML += `
            <div class="p-3.5 ${borderClass} hover:bg-gray-50 transition-colors">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <div class="text-[15px] font-bold text-ink leading-tight mt-0.5 line-clamp-2">${item.courseName || '--'}</div>
                  <div class="text-[12px] text-sub font-mono mt-0.5">${item.courseCode || '--'}</div>
                </div>
                <div class="flex flex-col items-end text-right">
                  <div class="text-[17px] font-bold ${passTag}">${scoreText}</div>
                  <div class="text-[11px] text-sub mt-0.5">å­¦åˆ† ${item.credit ?? '--'} Â· ç»©ç‚¹ ${item.gpa ?? '--'}</div>
                </div>
              </div>
              ${natureRow}
            </div>
          `;
        });

        list.innerHTML += `</div>`;
      });
    }

    /***********************
     * 12) Panel & åˆ·æ–°
     ***********************/
    function togglePanel(name, forceOpen = null) {
      const container = document.getElementById(`panelContent-${name}`);
      const wrapper = document.querySelector(`[data-panel="${name}"]`);
      const arrow = document.getElementById('gradeArrow');

      const isOpen = !container.classList.contains('hidden');
      const next = forceOpen !== null ? forceOpen : !isOpen;

      container.classList.toggle('hidden', !next);
      wrapper?.setAttribute('data-open', next ? 'true' : 'false');
      if (arrow) arrow.style.transform = next ? 'rotate(180deg)' : 'rotate(0deg)';

      if (next && name === 'grades' && !panelLoaded.grades) loadGrades(false);
    }

    function refreshGradesButton() {
      const container = document.getElementById('panelContent-grades');
      if (container.classList.contains('hidden')) togglePanel('grades', true);
      loadGrades(true);
    }

    /***********************
     * 13) ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆå…¨è¦†ç›–ï¼‰
     *
     * apiFetch å¯èƒ½æŠ›ï¼š
     *  - NO_TOKENï¼šæ—  token ä¸”è‡ªåŠ¨ç™»å½•å¤±è´¥
     *  - SESSION_EXPIREDï¼š401 ä¸”è‡ªåŠ¨é‡ç™»å¤±è´¥
     *  - å…¶ä»–ï¼šç½‘ç»œ/è§£æ/ä¸šåŠ¡å¼‚å¸¸
     ***********************/
    async function handleFetchError(error, retryFn, fallbackMsg = 'è¯·æ±‚å¤±è´¥') {
      const msg = error?.message || String(error);
      warn('handleFetchError', { msg, error, requireCaptcha, hasToken: !!globalToken, authVersion, sessionVersion });

      // âœ… è‡ªåŠ¨é‡ç™»éœ€è¦éªŒè¯ç ï¼šå¼•å¯¼ç”¨æˆ·å›ç™»å½•é¡µè¾“å…¥éªŒè¯ç ï¼ˆå¹¶ä¿ç•™éªŒè¯ç çŠ¶æ€ï¼‰
      if (requireCaptcha) {
        alert('è‡ªåŠ¨ç™»å½•éœ€è¦éªŒè¯ç ï¼Œè¯·åœ¨ç™»å½•é¡µè¾“å…¥éªŒè¯ç åç™»å½•');
        await handleLogout(true, true);
        return;
      }

      if (msg === 'NO_TOKEN') {
        // é¿å…åˆ·å±å¼¹çª—
        if (!noTokenNotified) {
          alert('è¯·å…ˆç™»å½•');
          noTokenNotified = true;
        }
        await handleLogout(true, false);
        return;
      }

      if (msg === 'SESSION_EXPIRED') {
        if (!reauthFailedNotified) {
          alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
          reauthFailedNotified = true;
        }
        await handleLogout(true, false);
        return;
      }

      alert(fallbackMsg);
    }

    /***********************
     * 14) ç™»å‡ºï¼ˆä¿æŒå¥å£®æ€§ï¼‰
     *
     * preserveCreds:
     *   - trueï¼šä¿ç•™ä¿å­˜çš„è´¦å·å¯†ç ï¼ˆé»˜è®¤ï¼‰
     *   - falseï¼šæ¸…ç©º localStorage + indexedDB ä¿å­˜çš„å‡­æ®
     *
     * keepCaptchaState:
     *   - trueï¼šä¿ç•™ requireCaptcha/currentSessionIdï¼Œä¸éšè—éªŒè¯ç å—
     *           ç”¨äºâ€œè‡ªåŠ¨é‡ç™»éœ€è¦éªŒè¯ç â€çš„å¼•å¯¼åœºæ™¯
     *   - falseï¼šæ¸…ç†éªŒè¯ç çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰
     ***********************/
    async function handleLogout(preserveCreds = true, keepCaptchaState = false) {
      group('handleLogout()', () => {
        log('logout params', { preserveCreds, keepCaptchaState, hasToken: !!globalToken, authVersion, sessionVersion });
      });

      bumpSessionVersion('logout');
      setToken('', 'logout');

      panelLoaded.schedule = panelLoaded.grades = panelLoaded.ecard = panelLoaded.user = false;

      // é»˜è®¤æ¸…ç†éªŒè¯ç çŠ¶æ€
      if (!keepCaptchaState) {
        requireCaptcha = false;
        currentSessionId = '';
        document.getElementById('captcha').value = '';
        document.getElementById('captchaBlock').classList.add('hidden');
      } else {
        // ä¿ç•™éªŒè¯ç çŠ¶æ€ï¼ˆå¹¶ç¡®ä¿éªŒè¯ç å—å¯è§ï¼‰
        document.getElementById('captchaBlock').classList.remove('hidden');
      }

      showLogin();

      if (!preserveCreds) {
        clearCredentialsLocal();
        await clearCredentialsIndexedDB();
      }

      // å›åˆ°ç™»å½•é¡µï¼šå¡«å……ä¿å­˜çš„è´¦å·å¯†ç ï¼ˆä¸è‡ªåŠ¨è¯·æ±‚éªŒè¯ç ï¼‰
      await loadSavedCredentials();
    }

    /***********************
     * 15) ä¿å­˜å‡­æ®ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
     ***********************/
    async function loadSavedCredentials() {
      try {
        const saved = await getSavedCredentials();
        if (!saved) {
          log('no saved credentials found -> default rememberMe checked');
          document.getElementById('rememberMe').checked = true;
          return;
        }

        const { username, password, remember } = saved;
        if (username) document.getElementById('username').value = username;
        if (password) document.getElementById('password').value = password;
        if (remember !== undefined) document.getElementById('rememberMe').checked = remember;
      } catch (e) {
        err('loadSavedCredentials error', e);
      }
    }

    async function autoLoginOnLoad() {
      if (autoLoginAttempted) return false;
      autoLoginAttempted = true;

      const saved = await getSavedCredentials();
      if (!saved || !saved.username || !saved.password || saved.remember !== true) {
        log('autoLoginOnLoad skipped', { hasSaved: !!saved, remember: saved?.remember });
        return false;
      }

      log('autoLoginOnLoad start...');
      setLoading(true);
      try {
        // å¤ç”¨ ensureReloginï¼šå®ƒä¼šæ£€æŸ¥ tokenï¼Œæ²¡æœ‰å°± tryAutoRelogin
        const ok = await ensureRelogin('AUTO_ON_LOAD');
        if (!ok) {
          log('autoLoginOnLoad failed');
          return false;
        }

        showData();
        await loadAllData(false);
        log('autoLoginOnLoad success');
        return true;
      } finally {
        setLoading(false);
      }
    }

    async function saveCredentialsIfNeeded(username, password) {
      const remember = document.getElementById('rememberMe').checked;
      if (remember) {
        const payload = { username, password, remember: true };
        saveCredentialsLocal(payload);
        await saveCredentialsIndexedDB(payload);
      } else {
        clearCredentialsLocal();
        await clearCredentialsIndexedDB();
      }
    }

    function readCredentialsLocal() {
      for (const key of SAVED_CRED_KEYS) {
        const raw = localStorage.getItem(key);
        if (!raw) continue;
        try {
          const parsed = JSON.parse(raw);
          if (parsed && (parsed.username || parsed.password)) return parsed;
        } catch (e) {}
      }
      return null;
    }

    function saveCredentialsLocal(payload) {
      try {
        const data = JSON.stringify(payload);
        SAVED_CRED_KEYS.forEach(k => localStorage.setItem(k, data));
      } catch (e) {}
    }

    function clearCredentialsLocal() {
      SAVED_CRED_KEYS.forEach(k => localStorage.removeItem(k));
    }

    function openCredDB() {
      return new Promise((resolve) => {
        if (!('indexedDB' in window)) return resolve(null);
        const req = indexedDB.open(IDB_CONFIG.name, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(IDB_CONFIG.store)) db.createObjectStore(IDB_CONFIG.store);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });
    }

    async function saveCredentialsIndexedDB(payload) {
      const db = await openCredDB();
      if (!db) return false;
      return new Promise((resolve) => {
        const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
        tx.objectStore(IDB_CONFIG.store).put(payload, IDB_CONFIG.key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => resolve(false);
      });
    }

    async function loadCredentialsIndexedDB() {
      const db = await openCredDB();
      if (!db) return null;
      return new Promise((resolve) => {
        const tx = db.transaction(IDB_CONFIG.store, 'readonly');
        const req = tx.objectStore(IDB_CONFIG.store).get(IDB_CONFIG.key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => resolve(null);
      });
    }

    async function clearCredentialsIndexedDB() {
      const db = await openCredDB();
      if (!db) return false;
      return new Promise((resolve) => {
        const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
        tx.objectStore(IDB_CONFIG.store).delete(IDB_CONFIG.key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => resolve(false);
      });
    }

    async function getSavedCredentials() {
      try {
        const local = readCredentialsLocal();
        if (local) return local;
        const idb = await loadCredentialsIndexedDB();
        return idb || null;
      } catch {
        return null;
      }
    }

    /***********************
     * 16) å…¥å£ï¼šä¸å† initCaptchaï¼ˆæŒ‰éœ€ï¼‰
     ***********************/
    appStart();
  </script>
</body>
</html>
