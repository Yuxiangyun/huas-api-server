<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–‡ç†å°åŠ©æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        popCyan: '#6AECE1',
                        popTeal: '#26CCC2',
                        popYellow: '#FFF57E',
                        popOrange: '#FFB76C',
                        popPurple: '#C084FC',
                        popPink: '#F472B6',
                        ink: '#134E4A',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #134E4A', 
                        'card': '2px 2px 0px 0px #134E4A',
                        'float': '6px 6px 0px 0px #134E4A',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        * { -webkit-tap-highlight-color: transparent; }
        
        /* ç§»åŠ¨ç«¯è¯¾è¡¨å·¦ä¾§å›ºå®šåˆ— */
        .sticky-col { position: sticky; left: 0; z-index: 30; background-color: #F8FAFC; }
        .sticky-shadow::after {
            content: ''; position: absolute; top: 0; right: -4px; width: 4px; height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.05), transparent); pointer-events: none;
        }
        /* 3D å›¾æ ‡å¾®äº¤äº’ */
        .icon-3d { filter: drop-shadow(2px 4px 6px rgba(19, 78, 74, 0.2)); transition: transform 0.3s; }
        .icon-3d:hover { transform: scale(1.1) rotate(5deg); }
    </style>
</head>
<!-- æ ¸å¿ƒå¸ƒå±€ï¼šé™åˆ¶æœ€å¤§å®½åº¦ max-w-xl å¹¶å±…ä¸­ï¼Œé˜²æ­¢å¤§å±æ‹‰ä¼¸ -->
<body class="bg-[#F0F4F8] text-ink min-h-[100dvh] flex flex-col py-8 px-4 pb-20 relative max-w-xl mx-auto shadow-[0_0_50px_rgba(0,0,0,0.05)] border-x border-white/50">

    <!-- èƒŒæ™¯è£…é¥° Blob -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden -z-10">
        <div class="absolute -top-10 -right-10 w-64 h-64 bg-popCyan/10 rounded-full blur-3xl"></div>
        <div class="absolute top-40 -left-10 w-40 h-40 bg-popPink/10 rounded-full blur-2xl"></div>
    </div>

    <!-- 1. å¤´éƒ¨åŒºåŸŸï¼šæ¨ªå‘å¸ƒå±€ï¼Œç¨³é‡ä¸”ç¾è§‚ -->
    <header class="mb-8 w-full flex flex-col items-center justify-center animate-float">
        <div class="flex items-center gap-3">
            <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/School/3D/school_3d.png" 
                 class="w-12 h-12 object-contain drop-shadow-sm icon-3d" alt="School">
            <h1 class="text-3xl font-black tracking-tighter text-ink flex items-center gap-1">
                æ–‡ç†<span class="text-popTeal underline decoration-4 decoration-popYellow underline-offset-4">å°åŠ©æ‰‹</span>
            </h1>
        </div>
        <p class="text-[10px] font-bold text-slate-400 mt-2 tracking-[0.2em] uppercase">Hunan University of Arts and Science</p>
    </header>

    <!-- Loading é®ç½© -->
    <div id="loading" class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="relative">
            <div class="animate-spin rounded-full h-12 w-12 border-[5px] border-slate-200 border-t-popTeal mb-4"></div>
        </div>
        <div class="font-black bg-popYellow px-4 py-1 border-2 border-ink shadow-hard text-xs rounded-full">æ•°æ®åŠ è½½ä¸­...</div>
    </div>

    <!-- 2. ç™»å½•å¡ç‰‡ -->
    <section id="loginCard" class="w-full bg-white border-2 border-ink rounded-xl shadow-float p-6 mb-8 relative overflow-hidden">
        <div class="absolute -right-4 -top-4 w-20 h-20 bg-popYellow/30 rounded-full blur-xl"></div>
        
        <div class="flex items-center justify-between mb-6 relative z-10">
            <h2 class="text-2xl font-black italic text-ink">ç™»å½•</h2>
            <div class="flex items-center gap-2 bg-slate-100 px-2 py-1 rounded border border-ink/20">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-slate-400">ONLINE</span>
            </div>
        </div>

        <div class="space-y-5 relative z-10">
            <div class="relative group">
                <label class="block text-xs font-bold mb-1.5 ml-1 text-slate-500 flex items-center gap-1">
                    <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Identification%20card/3D/identification_card_3d.png" class="w-4 h-4">
                    å­¦å·
                </label>
                <input type="text" id="username" class="w-full text-base bg-slate-50 border-2 border-ink rounded-xl p-3 pl-4 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal placeholder:text-slate-300 focus:bg-white" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <div class="relative group">
                <label class="block text-xs font-bold mb-1.5 ml-1 text-slate-500 flex items-center gap-1">
                    <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Key/3D/key_3d.png" class="w-4 h-4">
                    å¯†ç 
                </label>
                <input type="password" id="password" class="w-full text-base bg-slate-50 border-2 border-ink rounded-xl p-3 pl-4 font-bold focus:outline-none focus:border-popTeal focus:shadow-hard transition-all placeholder:font-normal placeholder:text-slate-300 focus:bg-white" placeholder="æ™ºæ…§æ–‡ç†å¯†ç ">
            </div>
            <div id="captchaBlock" class="hidden">
                <label class="block text-xs font-bold mb-1 ml-1 text-slate-500">éªŒè¯ç </label>
                <div class="flex gap-2 h-[50px]">
                    <input type="text" id="captcha" placeholder="ABCD" class="flex-1 min-w-0 text-base bg-slate-50 border-2 border-ink rounded-xl p-3 font-bold uppercase focus:outline-none focus:border-popTeal focus:shadow-hard transition-all">
                    <div class="w-28 border-2 border-ink rounded-xl bg-slate-100 cursor-pointer overflow-hidden relative group shrink-0 active:scale-95 transition-transform shadow-card" onclick="initCaptcha(true)">
                        <img id="captchaImg" class="w-full h-full object-fill hidden">
                        <div id="captchaText" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-slate-400 group-hover:text-popTeal">ç‚¹å‡»åˆ·æ–°</div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <label class="flex items-center gap-2 text-xs font-bold text-slate-500 select-none cursor-pointer">
                    <input id="rememberMe" type="checkbox" class="w-4 h-4 border-2 border-ink rounded checked:bg-popTeal checked:border-ink focus:ring-0 transition-colors">
                    è®°ä½æˆ‘
                </label>
            </div>
            <button onclick="handleLogin()" class="w-full bg-popTeal border-2 border-ink text-white text-lg font-black py-3 rounded-xl shadow-hard hover:translate-y-[-2px] hover:bg-popTeal/90 transition-all active:translate-y-0 active:shadow-none mt-2 flex items-center justify-center gap-2 group">
                <span>è¿›å…¥ç³»ç»Ÿ</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-5 h-5 group-hover:translate-x-1 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                </svg>
            </button>
        </div>
    </section>

    <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
    <section id="dataArea" class="hidden w-full space-y-6">
        
        <!-- 3. ä¸ªäººä¿¡æ¯å¡ç‰‡ (ID Card é£æ ¼ï¼Œæ•´æ´ç´§å‡‘) -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-card relative overflow-hidden group">
             <!-- èƒŒæ™¯è£…é¥°æ°´å° -->
            <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Identification%20card/3D/identification_card_3d.png" 
            class="absolute -right-4 -bottom-4 w-24 h-24 opacity-10 rotate-[-15deg] pointer-events-none grayscale">
            
            <div class="p-4 flex items-center gap-4 relative z-10">
                <!-- å¤´åƒï¼šåœ†è§’çŸ©å½¢ -->
                <div class="w-16 h-16 bg-indigo-50 rounded-xl border-2 border-ink flex items-center justify-center shrink-0 overflow-hidden shadow-[2px_2px_0_0_#134E4A]">
                    <img id="userAvatar" src="" alt="Avatar" class="w-full h-full object-cover">
                </div>

                <!-- ä¸­é—´ä¿¡æ¯ -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <h2 class="text-xl font-black text-ink tracking-tight truncate" id="uiName">--</h2>
                        <!-- èº«ä»½æ ‡ç­¾ -->
                        <span class="px-1.5 py-[2px] rounded bg-popPink border border-ink text-white text-[9px] font-black shadow-[1px_1px_0_0_#134E4A]">STUDENT</span>
                    </div>
                    <div class="space-y-0.5">
                        <div class="flex items-center gap-1.5 text-xs font-bold text-slate-500">
                            <span class="w-3.5 h-3.5 flex items-center justify-center bg-slate-100 rounded border border-slate-200 text-[8px] text-slate-400">ID</span>
                            <span id="uiId" class="font-mono tracking-wide">--</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-xs font-bold text-slate-500">
                            <span class="w-3.5 h-3.5 flex items-center justify-center bg-slate-100 rounded border border-slate-200 text-[8px] text-slate-400">CL</span>
                            <span id="uiClass" class="truncate">--</span>
                        </div>
                    </div>
                </div>

                <!-- é€€å‡ºæŒ‰é’® (Flex å¸ƒå±€ï¼Œé å³å¯¹é½) -->
                <button onclick="handleLogout()" class="shrink-0 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="é€€å‡ºç™»å½•">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 4. ä¸€å¡é€šå¡ç‰‡ (SVG èŠ¯ç‰‡ï¼Œæ·±è‰²è´¨æ„Ÿ) -->
        <div class="w-full text-white border-2 border-ink rounded-xl shadow-card p-5 flex flex-col justify-between relative overflow-hidden h-[140px] group transition-all hover:shadow-hard">
            <!-- 3D ä¿¡ç”¨å¡å›¾æ ‡è£…é¥° -->
            <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Credit%20card/3D/credit_card_3d.png" 
                    class="absolute -right-5 -bottom-6 w-24 h-24 opacity-90 rotate-[-15deg] group-hover:rotate-0 group-hover:scale-110 transition-all duration-300 z-0 drop-shadow-lg">
            
            <!-- æ·±è‰²èƒŒæ™¯ä¸çº¹ç† -->
            <div class="absolute inset-0 bg-[#134E4A] z-[-1]"></div>
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>

            <!-- é¡¶éƒ¨ï¼šèŠ¯ç‰‡ä¸æ ‡é¢˜ -->
            <div class="flex justify-between items-start z-10 relative">
                <div class="flex items-center gap-3">
                    <!-- SVG çŸ¢é‡èŠ¯ç‰‡ (æ¸…æ™°é”åˆ©) -->
                    <svg width="36" height="26" viewBox="0 0 40 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
                        <rect width="40" height="28" rx="4" fill="#FCD34D"/> <!-- é‡‘è‰²åº• -->
                        <rect x="2" y="2" width="36" height="24" rx="2" stroke="#B45309" stroke-opacity="0.2" stroke-width="1"/>
                        <path d="M12 2V26" stroke="#B45309" stroke-opacity="0.3" stroke-width="1.5"/>
                        <path d="M28 2V26" stroke="#B45309" stroke-opacity="0.3" stroke-width="1.5"/>
                        <path d="M2 14H12" stroke="#B45309" stroke-opacity="0.3" stroke-width="1.5"/>
                        <path d="M28 14H38" stroke="#B45309" stroke-opacity="0.3" stroke-width="1.5"/>
                        <rect x="15" y="8" width="10" height="12" rx="2" stroke="#B45309" stroke-opacity="0.3" stroke-width="1.5"/>
                    </svg>
                    <span class="text-[10px] font-black tracking-widest opacity-80 uppercase text-yellow-50/70 mt-1">Campus Card</span>
                </div>
                <!-- çŠ¶æ€æ ‡ç­¾ -->
                <span class="px-2 py-0.5 border border-white/20 bg-white/10 rounded-full text-[10px] font-bold backdrop-blur-sm" id="ecStatus">--</span>
            </div>

            <!-- åº•éƒ¨ï¼šä½™é¢ä¸åˆ·æ–° -->
            <div class="z-10 mt-1 flex justify-between items-end relative">
                <div class="flex flex-col">
                    <span class="text-[9px] text-white/50 font-bold uppercase mb-0.5 ml-0.5">Balance</span>
                    <div class="text-4xl font-black tracking-tighter flex items-baseline gap-1">
                        <span class="text-lg text-popYellow font-bold">Â¥</span>
                        <span id="ecBalance" class="text-white drop-shadow-md">--</span>
                    </div>
                </div>
                <button onclick="loadEcard(true)" class="p-2 rounded-full bg-white/10 border border-white/10 hover:bg-white/20 hover:rotate-180 transition-all active:scale-90 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- è¯¾è¡¨ -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100 bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Spiral%20calendar/3D/spiral_calendar_3d.png" class="w-8 h-8 icon-3d">
                    <div>
                        <h3 class="text-lg font-black tracking-tight leading-none text-ink">æœ¬å‘¨è¯¾è¡¨</h3>
                        <span class="text-[10px] font-bold text-slate-400" id="schWeek">Loading...</span>
                    </div>
                </div>
                <button onclick="loadSchedule(true)" class="text-[10px] font-bold bg-white px-3 py-1.5 border-2 border-slate-200 rounded-lg text-slate-600 hover:border-popTeal hover:text-popTeal active:scale-95 transition-all shadow-sm">
                    åˆ·æ–°
                </button>
            </div>
            <div class="overflow-x-auto hide-scroll pb-2 bg-white">
                <div class="min-w-[160vw] md:min-w-full" id="scheduleContainer"></div>
            </div>
        </div>

        <!-- 5. æˆç»© (ç¾åŒ–ç»Ÿè®¡æ¡† + ç©ºçŠ¶æ€) -->
        <div class="bg-white border-2 border-ink rounded-xl shadow-hard overflow-hidden transition-all duration-300" data-panel="grades" data-open="false">
            <div class="flex items-center justify-between p-4 border-b-2 border-slate-100 bg-slate-50/50 cursor-pointer hover:bg-slate-50" onclick="togglePanel('grades')">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Trophy/3D/trophy_3d.png" class="w-8 h-8 icon-3d">
                    <div class="flex flex-col items-start">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-black tracking-tight leading-none text-ink">æˆç»©å•</h3>
                            <span id="gradeSource" class="px-1.5 py-0.5 text-[9px] font-black bg-slate-200 rounded text-slate-500 hidden transform scale-90 origin-left"></span>
                        </div>
                        <span class="text-[10px] font-bold text-slate-400">ç‚¹å‡»å±•å¼€/æ”¶èµ·</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="event.stopPropagation(); refreshGradesButton()" class="text-[10px] font-bold bg-white px-3 py-1.5 border-2 border-slate-200 rounded-lg text-slate-600 hover:border-popOrange hover:text-popOrange active:scale-95 transition-all shadow-sm">
                        åˆ·æ–°
                    </button>
                    <div class="w-6 h-6 flex items-center justify-center transition-transform duration-300" id="gradeArrow">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4 text-slate-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div id="panelContent-grades" class="hidden">
                <div class="p-4 space-y-5 bg-[#F8FAFC]">
                    <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ï¼šåŠ é‡æ ·å¼ (è¾¹æ¡†+é˜´å½±) -->
                    <div class="grid grid-cols-2 gap-4 text-sm font-bold">
                        <!-- å­¦åˆ†å¡ç‰‡ -->
                        <div class="p-3 bg-white border-2 border-ink rounded-xl shadow-card flex flex-col items-center justify-center text-center relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-8 h-8 bg-popTeal/10 rounded-bl-xl"></div>
                            <div class="text-[10px] text-slate-400 mb-1 uppercase tracking-wider font-black">Credits</div>
                            <div id="gCredits" class="text-2xl font-black text-popTeal tracking-tight">--</div>
                        </div>
                        <!-- GPAå¡ç‰‡ -->
                        <div class="p-3 bg-white border-2 border-ink rounded-xl shadow-card flex flex-col items-center justify-center text-center relative overflow-hidden">
                             <div class="absolute top-0 right-0 w-8 h-8 bg-popOrange/10 rounded-bl-xl"></div>
                            <div class="text-[10px] text-slate-400 mb-1 uppercase tracking-wider font-black">GPA</div>
                            <div id="gGpa" class="text-2xl font-black text-popOrange tracking-tight">--</div>
                        </div>
                    </div>
                    
                    <!-- æˆç»©åˆ—è¡¨å®¹å™¨ -->
                    <div id="gradeList" class="space-y-3 min-h-[100px]"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- åº•éƒ¨åŒºåŸŸ -->
    <footer class="mt-8 mb-4 w-full flex justify-center">
        <button onclick="toggleAboutModal(true)" class="group flex items-center gap-2 px-5 py-2 rounded-full bg-white border border-ink/10 shadow-sm hover:shadow-card hover:border-ink hover:-translate-y-1 transition-all duration-300">
            <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Information/3D/information_3d.png" class="w-5 h-5 group-hover:rotate-12 transition-transform">
            <span class="text-xs font-bold text-slate-500 group-hover:text-ink">å…³äºæœåŠ¡</span>
        </button>
    </footer>

    <!-- å…³äºæœåŠ¡ Modal -->
    <div id="aboutModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-ink/20 backdrop-blur-sm transition-opacity" onclick="toggleAboutModal(false)"></div>
        <div class="bg-white border-2 border-ink rounded-2xl shadow-float w-full max-w-sm p-6 relative z-10 animate-float-up transform transition-all">
            <button onclick="toggleAboutModal(false)" class="absolute top-4 right-4 p-1 hover:bg-slate-100 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-slate-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="text-center mb-6">
                <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Rocket/3D/rocket_3d.png" 
     width="80" height="80" 
     style="margin: 0 auto 12px auto; filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.15)); display: block;"
     alt="Rocket">
                <h3 class="text-xl font-black text-ink">å…³äºæ–‡ç†å°åŠ©æ‰‹</h3>
                <p class="text-xs font-bold text-slate-400 mt-1">Version 1.0.3 (Stable)</p>
            </div>
            <div class="space-y-3 text-sm font-medium text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                <p>ğŸ“ <strong class="text-ink">çº¯å‡€ä½“éªŒï¼š</strong><br>æ— å¹¿å‘Šã€æ— æ¨å¹¿ï¼Œä»…æä¾›æœ€æ ¸å¿ƒçš„æŸ¥è¯¢æœåŠ¡ã€‚</p>
                <p>ğŸ”’ <strong class="text-ink">å®‰å…¨ç›´è¿ï¼š</strong><br>æ•°æ®ä»…åœ¨æœ¬åœ°ä¸æ•™åŠ¡ç³»ç»Ÿäº¤äº’ï¼Œä¸å­˜å‚¨å¯†ç ã€‚</p>
                <p>ğŸ”¨ <strong class="text-ink">åæ˜ é—®é¢˜è”ç³»æˆ‘ï¼š</strong><br>å¾®ä¿¡ï¼š-nullsleep</p>
                <p>
                    ğŸ“¶ <strong class="text-ink">çŠ¶æ€</strong><br>
                    <a
                        href="http://8.134.208.242:13001/dashboard"
                        class="text-ink"
                        target="_blank"
                        rel="noopener noreferrer"
                        style="text-decoration: underline; cursor: pointer;"
                    >
                        ç‚¹å‡»æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
                    </a>
                </p>
            </div>
            <button onclick="toggleAboutModal(false)" class="w-full bg-popYellow border-2 border-ink text-ink font-black py-3 rounded-xl shadow-card active:shadow-none active:translate-y-[2px] transition-all">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        const API_BASE = ''; 
        
        let currentSessionId = '';
        let requireCaptcha = false;
        let isRelogging = false;
        let reauthPromise = null;
        let reauthFailedNotified = false;
        const log = (...args) => console.log('[UI]', ...args);
        let globalToken = localStorage.getItem('huas_token') || '';
        const panelLoaded = { schedule: false, grades: false };
        const SAVED_CRED_KEY = 'huas_saved_cred';
        const SAVED_CRED_KEYS = [SAVED_CRED_KEY, 'huas_saved_cred_bak1', 'huas_saved_cred_bak2'];
        const IDB_CONFIG = { name: 'huasCredDB', store: 'creds', key: 'primary' };
        let autoLoginAttempted = false;

        const COURSE_COLORS = [
            'bg-popCyan', 'bg-popYellow', 'bg-popOrange', 'bg-popPurple', 
            'bg-popPink', 'bg-[#A5F3FC]', 'bg-[#FDA4AF]'
        ];

        function toggleAboutModal(show) {
            const modal = document.getElementById('aboutModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.querySelector('div.bg-white').classList.add('animate-bounce-in');
            } else {
                modal.classList.add('hidden');
            }
        }

        if (globalToken) {
            loadAllData();
        } else {
            (async () => {
                await loadSavedCredentials();
                await autoLoginOnLoad();
            })();
            initCaptcha();
        }

        async function initCaptcha(forceShow = false) {
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/auth/captcha`, { cache: 'no-store' });
                const json = await res.json();
                if (json.code === 200) {
                    currentSessionId = json.data.sessionId;
                    const img = document.getElementById('captchaImg');
                    img.src = 'data:image/png;base64,' + json.data.image;
                    img.classList.remove('hidden');
                    document.getElementById('captchaText').classList.add('hidden');
                    if (forceShow) {
                        requireCaptcha = true;
                        document.getElementById('captchaBlock').classList.remove('hidden');
                    } else if (!requireCaptcha) {
                        document.getElementById('captchaBlock').classList.add('hidden');
                    }
                } else {
                    alert('éªŒè¯ç è·å–å¤±è´¥: ' + json.msg);
                }
            } catch (e) {
                console.error(e);
            } finally {
                setLoading(false);
            }
        }

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const c = document.getElementById('captcha').value;
            if(!u || !p) return alert('è¯·å¡«å†™å­¦å·å’Œå¯†ç ');
            if(requireCaptcha && !c) return alert('è¯·è¾“å…¥éªŒè¯ç ');
            await performLogin(u, p, c, false);
        }

        async function performLogin(username, password, captcha, quiet = false) {
            log('performLogin', { quiet, requireCaptcha });
            if (!quiet) setLoading(true);
            try {
                const payload = { sessionId: currentSessionId, username, password };
                if (requireCaptcha || captcha) payload.code = captcha;

                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                log('login response', json);
                if (json.code === 200) {
                    globalToken = json.token;
                    localStorage.setItem('huas_token', globalToken);
                    reauthFailedNotified = false;
                    if (!quiet) {
                        await saveCredentialsIfNeeded(username, password);
                        document.getElementById('loginCard').classList.add('hidden');
                        document.getElementById('dataArea').classList.remove('hidden');
                        await loadAllData();
                    }
                    return true;
                }

                if (json.action === 'NEED_CAPTCHA') {
                    log('login need captcha', json.msg);
                    requireCaptcha = true;
                    document.getElementById('captchaBlock').classList.remove('hidden');
                    document.getElementById('captcha').value = '';
                    initCaptcha(true);
                    if (!quiet) alert(json.msg || 'ç™»å½•å¤±è´¥ï¼Œå¯èƒ½å­¦å·/å¯†ç é”™è¯¯ï¼Œè¯·è¾“å…¥éªŒè¯ç åå†è¯•');
                } else if (json.code === 400 && json.msg && json.msg.includes('ä¼šè¯IDæ— æ•ˆ')) {
                    log('login invalid sessionId, refreshing captcha session');
                    await initCaptcha(false);
                    if (quiet) {
                        return performLogin(username, password, '', true);
                    }
                    alert('ä¼šè¯å·²å¤±æ•ˆï¼Œå·²åˆ·æ–°éªŒè¯ç ï¼Œè¯·é‡è¯•');
                } else {
                    log('login failed', json.msg);
                    if (!quiet) alert('ç™»å½•å¤±è´¥: ' + json.msg);
                    initCaptcha(requireCaptcha);
                }
                return false;
            } catch (e) {
                log('login error', e);
                if (!quiet) alert('ç™»å½•è¯·æ±‚é”™è¯¯');
                return false;
            } finally {
                if (!quiet) setLoading(false);
            }
        }

        async function loadAllData() {
            if (!globalToken) return;
            setLoading(true);
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('dataArea').classList.remove('hidden');
            await Promise.all([
                loadUser(false),
                loadEcard(false),
                loadSchedule(false)
            ]);
            setLoading(false);
        }

        async function loadUser(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderUser(json.data);
                panelLoaded.user = true;
            } catch (e) {
                await handleFetchError(e, () => loadUser(refresh, false));
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderUser(data) {
            if(!data) return;
            document.getElementById('uiName').innerText = data.name;
            document.getElementById('uiId').innerText = data.studentId;
            document.getElementById('uiClass').innerText = data.className;
            const seed = encodeURIComponent(data.name || 'Student');
            document.getElementById('userAvatar').src = `https://api.dicebear.com/9.x/notionists/svg?seed=${seed}&backgroundColor=e9d5ff`;
        }

        async function loadEcard(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/ecard${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderEcard(json.data);
                panelLoaded.ecard = true;
            } catch (e) {
                log('loadEcard error', e);
                await handleFetchError(e, () => loadEcard(refresh, false), 'ä¸€å¡é€šè·å–å¤±è´¥');
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderEcard(data) {
            if(!data) return;
            let statusText = data.status;
            if (!statusText || statusText.includes('æœªçŸ¥')) {
                statusText = 'æ­£å¸¸';
            }
            const balanceText = (data.balance === undefined || data.balance === null) ? '0.00' : data.balance;
            const elStatus = document.getElementById('ecStatus');
            elStatus.innerText = statusText;
            if (statusText === 'æ­£å¸¸') {
                elStatus.className = "px-2 py-0.5 border border-white/20 bg-green-400/20 rounded-full text-[10px] font-bold text-green-200";
            } else {
                elStatus.className = "px-2 py-0.5 border border-red-400/40 bg-red-400/10 rounded-full text-[10px] font-bold text-red-200";
            }
            document.getElementById('ecBalance').innerText = balanceText;
        }

        async function loadSchedule(refresh = false, withSpinner = true) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            if (withSpinner) setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/schedule${refresh ? '?refresh=true' : ''}`, { 
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                renderSchedule(json.data);
                panelLoaded.schedule = true;
            } catch (e) {
                log('loadSchedule error', e);
                await handleFetchError(e, () => loadSchedule(refresh, false), 'è¯¾è¡¨è·å–å¤±è´¥');
            } finally {
                if (withSpinner) setLoading(false);
            }
        }

        function renderSchedule(data) {
            if(!data) return;
            document.getElementById('schWeek').innerText = data.week || 'Schedule';
            const container = document.getElementById('scheduleContainer');
            const isMobile = window.innerWidth < 768;
            const leftColWidth = isMobile ? 50 : 60;
            const dayMinWidth = isMobile ? 90 : 110;
            container.style.minWidth = `${leftColWidth + 7 * dayMinWidth}px`;
            const courseMap = {};
            if (data.courses && Array.isArray(data.courses)) {
                data.courses.forEach(c => {
                    const match = c.section.match(/(\d+)/);
                    if (!match) return;
                    const startNode = parseInt(match[1]);
                    const sectionIdx = Math.floor((startNode - 1) / 2);
                    const dayIdx = c.day - 1;
                    const key = `${dayIdx}_${sectionIdx}`;
                    if (!courseMap[key]) courseMap[key] = [];
                    courseMap[key].push(c);
                });
            }
            let html = `<div class="grid" style="grid-template-columns:${leftColWidth}px repeat(7, minmax(${dayMinWidth}px,1fr));">`;
            html += `<div class="sticky-col sticky-shadow bg-[#F8FAFC] border-b border-r border-slate-100 z-40" style="width:${leftColWidth}px"></div>`;
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const todayColIdx = (new Date().getDay() + 6) % 7;
            days.forEach((d, i) => {
                const isToday = i === todayColIdx;
                const bgClass = isToday ? 'text-popTeal bg-popTeal/10' : 'text-slate-400';
                const marker = isToday ? 'today-col' : '';
                html += `<div class="text-center font-black text-[10px] py-3 border-b border-slate-100 ${bgClass} ${marker}" data-day="${i}">${d}</div>`;
            });
            const sections = ['1-2', '3-4', '5-6', '7-8', '9-10', '11-12'];
            for (let s = 0; s < 6; s++) {
                html += `
                    <div class="sticky-col sticky-shadow flex items-center justify-center font-bold text-slate-400 bg-[#F8FAFC] border-r border-b border-slate-100 text-[10px] z-30" style="width:${leftColWidth}px">
                        ${sections[s]}
                    </div>
                `;
                for (let d = 0; d < 7; d++) {
                    const courses = courseMap[`${d}_${s}`];
                    const colBg = d === todayColIdx ? 'bg-popTeal/5' : '';
                    html += `<div class="p-1 border-b border-slate-100 border-r border-dashed border-slate-200 ${colBg} min-h-[90px] relative" data-day="${d}">`;
                    if (courses && courses.length > 0) {
                        html += `<div class="flex flex-col gap-1 h-full">`; 
                        courses.forEach((course, idx) => {
                             const colorIdx = (d + s + idx) % COURSE_COLORS.length;
                             const bgClass = COURSE_COLORS[colorIdx];
                             html += `
                                <div class="course-card flex-1 ${bgClass} border-2 border-ink rounded-lg p-1.5 shadow-card cursor-pointer flex flex-col justify-between relative overflow-hidden group hover:translate-y-[-2px] hover:shadow-hard transition-all duration-200" title="${course.name}">
                                    <div class="font-black text-[10px] text-ink leading-tight line-clamp-3 z-10 relative mb-1">
                                        ${course.name}
                                    </div>
                                    ${course.location ? `
                                    <div class="flex justify-start z-10 relative">
                                        <div class="inline-flex items-start bg-white/70 border border-ink/10 px-1.5 py-1 rounded-lg text-[8px] font-bold text-ink/80 backdrop-blur-sm max-w-full leading-tight flex-col">
                                            <span class="break-words">${course.location.replace('æ ¡æœ¬éƒ¨', '').replace(/(æ¥¼)[A-Za-z]?\d+.*/, '$1')}</span>
                                            <span class="text-[9px] font-black">${(course.location.match(/(æ¥¼)([A-Za-z]?\d+)/) || [,'',''])[2]}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        async function loadGrades(refresh = false) {
            if (!globalToken) return alert('è¯·å…ˆç™»å½•');
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/grades${refresh ? '?refresh=true' : ''}`, {
                    headers: { 'Authorization': globalToken },
                    cache: 'no-store'
                });
                if (res.status === 401) throw new Error('SESSION_EXPIRED');
                const json = await res.json();
                if (json.code && json.code !== 200) {
                    throw new Error(json.msg || 'æˆç»©è·å–å¤±è´¥');
                }
                renderGrades(json.data);
                panelLoaded.grades = true;
            } catch (e) {
                if (e.message === 'SESSION_EXPIRED') {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    handleLogout();
                } else {
                    alert(e.message || 'æˆç»©è·å–å¤±è´¥');
                    console.error(e);
                }
            } finally {
                setLoading(false);
            }
        }

        function renderGrades(data) {
            if (!data) return;
            const summary = data.summary || {};
            document.getElementById('gCredits').innerText = summary.totalCredits ?? '--';
            document.getElementById('gGpa').innerText = summary.averageGpa ?? '--';
            const sourceEl = document.getElementById('gradeSource');
            if (data._source) {
                sourceEl.innerText = data._source.toUpperCase();
                sourceEl.classList.remove('hidden');
            } else {
                sourceEl.innerText = '';
                sourceEl.classList.add('hidden');
            }
            const list = document.getElementById('gradeList');
            list.innerHTML = '';
            
            const items = data.items || [];
            
            // ä¼˜åŒ–ç©ºçŠ¶æ€æ˜¾ç¤º (Dashed Box Empty State)
            if (!items.length) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                        <div class="text-3xl grayscale opacity-50 mb-2">ğŸ’¯</div>
                        <div class="text-xs font-bold text-slate-400">æš‚æ— æˆç»©æ•°æ®</div>
                        <div class="text-[10px] text-slate-300 mt-1">è¯·å°è¯•åˆ·æ–°æˆ–è¯„æ•™åå†è¯•</div>
                    </div>`;
                return;
            }

            const groupMap = {};
            items.forEach(item => {
                const term = item.term || 'æœªçŸ¥å­¦æœŸ';
                if (!groupMap[term]) groupMap[term] = [];
                groupMap[term].push(item);
            });
            const parseTerm = (term) => {
                const m = term.match(/(\d{4}).*?(\d{4}).*?(\d+)/);
                if (m) return { y1: parseInt(m[1]), y2: parseInt(m[2]), sem: parseInt(m[3]) };
                return null;
            };
            const sortedTerms = Object.keys(groupMap).sort((a, b) => {
                const pa = parseTerm(a); const pb = parseTerm(b);
                if (pa && pb) {
                    if (pa.y1 !== pb.y1) return pb.y1 - pa.y1;
                    if (pa.y2 !== pb.y2) return pb.y2 - pa.y2;
                    return (pb.sem || 0) - (pa.sem || 0);
                }
                return b.localeCompare(a);
            });
            sortedTerms.forEach(term => {
                list.innerHTML += `
                    <div class="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-[12px] font-black text-slate-600 tracking-wide mt-2">
                        ${term}
                    </div>
                `;
                groupMap[term].forEach(item => {
                    const passTag = item.pass === null ? '' : item.pass ? 'text-popTeal' : 'text-red-500';
                    const scoreText = item.score !== null ? item.score : item.scoreText || '--';
                    const natureText = item.courseCategory || item.courseAttribute || '';
                    const natureRow = natureText ? `<div class="flex items-center justify-between text-[11px] text-slate-500 mt-2">
                                <span>æ€§è´¨ï¼š${natureText}</span>
                            </div>` : '';
                    list.innerHTML += `
                        <div class="p-3 border border-slate-200 rounded-xl bg-white shadow-sm hover:shadow-card transition-shadow">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="text-base font-black text-ink leading-tight mt-1 line-clamp-2">${item.courseName}</div>
                                    <div class="text-[11px] text-slate-400 font-mono mt-0.5">${item.courseCode || '--'}</div>
                                </div>
                                <div class="flex flex-col items-end text-right">
                                    <div class="text-xl font-black ${passTag}">${scoreText}</div>
                                    <div class="text-[11px] text-slate-500 mt-1">å­¦åˆ† ${item.credit ?? '--'} Â· ç»©ç‚¹ ${item.gpa ?? '--'}</div>
                                    <div class="text-[10px] text-slate-400">${item.courseNature || '--'}</div>
                                </div>
                            </div>
                            ${natureRow}
                        </div>
                    `;
                });
            });
        }

        async function handleLogout(preserveCreds = true) {
            localStorage.removeItem('huas_token');
            globalToken = '';
            panelLoaded.schedule = panelLoaded.grades = panelLoaded.ecard = panelLoaded.user = false;
            requireCaptcha = false;
            document.getElementById('captcha').value = '';
            document.getElementById('captchaBlock').classList.add('hidden');
            document.getElementById('dataArea').classList.add('hidden');
            document.getElementById('loginCard').classList.remove('hidden');
            if (!preserveCreds) {
                clearCredentialsLocal();
                await clearCredentialsIndexedDB();
            }
            loadSavedCredentials();
            initCaptcha(false);
        }

        function setLoading(isLoading) {
            const el = document.getElementById('loading');
            el.classList.toggle('hidden', !isLoading);
        }

        async function loadSavedCredentials() {
            try {
                const saved = await getSavedCredentials();
                if (!saved) {
                    log('no saved credentials found');
                    document.getElementById('rememberMe').checked = true;
                    return;
                }
                const { username, password, remember } = saved;
                if (username) document.getElementById('username').value = username;
                if (password) document.getElementById('password').value = password;
                if (remember !== undefined) document.getElementById('rememberMe').checked = remember;
            } catch (e) { console.error(e); }
        }

        async function autoLoginOnLoad() {
            if (autoLoginAttempted || globalToken) return;
            const saved = await getSavedCredentials();
            if (!saved || !saved.username || !saved.password || saved.remember !== true) return;
            autoLoginAttempted = true;
            setLoading(true);
            const ok = await tryAutoRelogin();
            if (ok) {
                document.getElementById('loginCard').classList.add('hidden');
                document.getElementById('dataArea').classList.remove('hidden');
                await loadAllData();
            }
            setLoading(false);
        }

        async function saveCredentialsIfNeeded(username, password) {
            const remember = document.getElementById('rememberMe').checked;
            if (remember) {
                const payload = { username, password, remember: true };
                saveCredentialsLocal(payload);
                await saveCredentialsIndexedDB(payload);
            } else {
                clearCredentialsLocal();
                await clearCredentialsIndexedDB();
            }
        }

        function togglePanel(name, forceOpen = null) {
            const container = document.getElementById(`panelContent-${name}`);
            const wrapper = document.querySelector(`[data-panel="${name}"]`);
            const arrow = document.getElementById('gradeArrow');
            
            const isOpen = !container.classList.contains('hidden');
            const next = forceOpen !== null ? forceOpen : !isOpen;
            container.classList.toggle('hidden', !next);
            wrapper?.setAttribute('data-open', next ? 'true' : 'false');
            if(arrow) arrow.style.transform = next ? 'rotate(180deg)' : 'rotate(0deg)';
            if (next && name === 'grades' && !panelLoaded.grades) loadGrades();
        }

        function refreshGradesButton() {
            const container = document.getElementById('panelContent-grades');
            if (container.classList.contains('hidden')) togglePanel('grades', true);
            loadGrades(true);
        }

        function readCredentialsLocal() {
            for (const key of SAVED_CRED_KEYS) {
                const raw = localStorage.getItem(key);
                if (!raw) continue;
                try {
                    const parsed = JSON.parse(raw);
                    if (parsed && (parsed.username || parsed.password)) return parsed;
                } catch (e) {}
            }
            return null;
        }

        function saveCredentialsLocal(payload) {
            try {
                const data = JSON.stringify(payload);
                SAVED_CRED_KEYS.forEach(k => localStorage.setItem(k, data));
            } catch (e) {}
        }

        function clearCredentialsLocal() { SAVED_CRED_KEYS.forEach(k => localStorage.removeItem(k)); }

        function openCredDB() {
            return new Promise((resolve) => {
                if (!('indexedDB' in window)) return resolve(null);
                const req = indexedDB.open(IDB_CONFIG.name, 1);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(IDB_CONFIG.store)) db.createObjectStore(IDB_CONFIG.store);
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }

        async function saveCredentialsIndexedDB(payload) {
            const db = await openCredDB();
            if (!db) return false;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
                tx.objectStore(IDB_CONFIG.store).put(payload, IDB_CONFIG.key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => resolve(false);
            });
        }

        async function loadCredentialsIndexedDB() {
            const db = await openCredDB();
            if (!db) return null;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readonly');
                const req = tx.objectStore(IDB_CONFIG.store).get(IDB_CONFIG.key);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => resolve(null);
            });
        }

        async function clearCredentialsIndexedDB() {
            const db = await openCredDB();
            if (!db) return false;
            return new Promise((resolve) => {
                const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
                tx.objectStore(IDB_CONFIG.store).delete(IDB_CONFIG.key);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => resolve(false);
            });
        }

        async function handleFetchError(error, retryFn, fallbackMsg = 'è¯·æ±‚å¤±è´¥') {
            if (error.message === 'SESSION_EXPIRED') {
                if (!reauthPromise) reauthPromise = tryAutoRelogin();
                const reloginOk = await reauthPromise.catch(() => false);
                reauthPromise = null;
                if (reloginOk && typeof retryFn === 'function') return retryFn();
                if (!reauthFailedNotified) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    reauthFailedNotified = true;
                }
                handleLogout(true);
            } else {
                alert(fallbackMsg);
            }
        }

        async function getSavedCredentials() {
            try {
                const local = readCredentialsLocal();
                if (local) return local;
                const idb = await loadCredentialsIndexedDB();
                return idb || null;
            } catch { return null; }
        }

        async function tryAutoRelogin() {
            if (isRelogging) return false;
            const saved = await getSavedCredentials();
            if (!saved || !saved.username || !saved.password) return false;
            isRelogging = true;
            currentSessionId = '';
            requireCaptcha = false;
            await initCaptcha(false);
            const ok = await performLogin(saved.username, saved.password, '', true);
            isRelogging = false;
            return ok;
        }
    </script>
</body>
</html>