<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>æ–‡ç†å°åŠ©æ‰‹</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
            mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
          },
          colors: {
            iosBg: '#F2F2F7',
            iosCard: '#FFFFFF',
            iosBlue: '#007AFF',
            iosTeal: '#30B0C7',
            iosGreen: '#34C759',
            iosRed: '#FF3B30',
            iosYellow: '#FFCC00',
            iosGray: '#8E8E93',
            iosGrayLight: '#E5E5EA',
            ink: '#1C1C1E',
            sub: '#8E8E93',
          },
          boxShadow: {
            'ios-sm': '0 1px 2px rgba(0,0,0,0.05)',
            'ios-card': '0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02)',
            'ios-float': '0 12px 32px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.08)',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'scale(0.98)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)' },
              '100%': { transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: #F2F2F7;
      -webkit-font-smoothing: antialiased;
    }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    * { -webkit-tap-highlight-color: transparent; }

    /* ç§»åŠ¨ç«¯è¯¾è¡¨å·¦ä¾§å›ºå®šåˆ— - ç£¨ç ‚æ•ˆæœ */
    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 30;
      background-color: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .sticky-shadow::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 1px;
      height: 100%;
      background: #E5E5EA;
      pointer-events: none;
    }

    /* 3D å›¾æ ‡ */
    .icon-3d {
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.08));
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .icon-3d:hover { transform: scale(1.1) rotate(5deg); }

    /* iOS é£æ ¼ Checkbox */
    .ios-checkbox {
      appearance: none;
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #C6C6C8;
      border-radius: 50%;
      display: inline-block;
      position: relative;
      transition: all 0.2s;
      background-color: white;
    }
    .ios-checkbox:checked {
      background-color: #007AFF;
      border-color: #007AFF;
    }
    .ios-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
  </style>
</head>

<body class="bg-iosBg text-ink min-h-[100dvh] flex flex-col py-8 px-4 pb-20 relative max-w-xl mx-auto border-x border-white/50 shadow-2xl">

  <!-- 1. å¤´éƒ¨åŒºåŸŸ -->
  <header class="mb-8 w-full flex flex-col items-center justify-center animate-fade-in">
    <div class="flex items-center gap-3">
      <!-- <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/School/3D/school_3d.png"
           class="w-12 h-12 object-contain icon-3d" alt="School"> -->
      <h1 class="text-5xl font-bold tracking-tight text-ink flex items-center gap-1">
        æ–‡ç†<span class="text-iosBlue">å°åŠ©æ‰‹</span>
      </h1>
    </div>
    <p class="text-[10px] font-semibold text-sub mt-2 tracking-[0.2em] uppercase opacity-70">Hunan University of Arts and Science</p>
  </header>

  <!-- Loading é®ç½© -->
  <div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/10 backdrop-blur-[2px]"></div>
    <div class="relative bg-white/80 backdrop-blur-xl px-6 py-5 rounded-2xl shadow-ios-float flex flex-col items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-[3px] border-gray-200 border-t-iosBlue mb-3"></div>
      <div class="text-xs font-medium text-sub">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- 2. ç™»å½•å¡ç‰‡ -->
  <section id="loginCard" class="w-full bg-iosCard rounded-2xl shadow-ios-card p-6 mb-8 relative overflow-hidden animate-fade-in border border-white/60">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-ink tracking-tight">ç™»å½•</h2>
      <div class="flex items-center gap-1.5 bg-gray-100 px-2 py-1 rounded-full border border-gray-100">
        <div class="w-1.5 h-1.5 rounded-full bg-iosGreen animate-pulse"></div>
        <span class="text-[11px] font-semibold text-sub">ONLINE</span>
      </div>
    </div>

    <div class="space-y-4">
      <!-- Username -->
      <div class="group">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub flex items-center gap-1.5 uppercase tracking-wide">
          å­¦å·
        </label>
        <input type="text" id="username"
               class="w-full text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 py-3 font-medium focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all placeholder:text-gray-400 focus:outline-none"
               placeholder="è¯·è¾“å…¥å­¦å·">
      </div>

      <!-- Password -->
      <div class="group">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub flex items-center gap-1.5 uppercase tracking-wide">
          å¯†ç 
        </label>
        <input type="password" id="password"
               class="w-full text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 py-3 font-medium focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all placeholder:text-gray-400 focus:outline-none"
               placeholder="æ™ºæ…§æ–‡ç†å¯†ç ">
      </div>

      <!-- Captchaï¼šæŒ‰éœ€åŠ è½½ -->
      <div id="captchaBlock" class="hidden">
        <label class="block text-[11px] font-semibold mb-1.5 ml-1 text-sub">éªŒè¯ç </label>
        <div class="flex gap-3 h-[48px]">
          <input type="text" id="captcha" placeholder="ABCD"
                 class="flex-1 min-w-0 text-[17px] bg-iosGrayLight/50 border border-transparent rounded-xl px-4 font-medium uppercase focus:bg-white focus:border-iosBlue focus:ring-4 focus:ring-iosBlue/10 transition-all focus:outline-none">
          <div class="w-28 rounded-xl bg-gray-50 cursor-pointer overflow-hidden relative group shrink-0 active:opacity-70 transition-opacity border border-gray-200"
               onclick="initCaptcha(true, true)">
            <img id="captchaImg" class="w-full h-full object-fill hidden">
            <div id="captchaText" class="absolute inset-0 flex items-center justify-center text-[11px] font-bold text-iosBlue/70">ç‚¹å‡»åˆ·æ–°</div>
          </div>
        </div>
      </div>

      <!-- Remember Me -->
      <div class="flex items-center justify-between pt-1">
        <label class="flex items-center gap-2.5 cursor-pointer select-none group py-1">
          <input id="rememberMe" type="checkbox" class="ios-checkbox">
          <span class="text-[15px] text-ink font-medium">è®°ä½æˆ‘</span>
        </label>
      </div>

      <button id="loginBtn" onclick="handleLogin()"
              class="w-full bg-iosBlue text-white text-[17px] font-bold py-3.5 rounded-xl shadow-sm hover:bg-iosBlue/90 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2">
        <span>è¿›å…¥ç³»ç»Ÿ</span>
      </button>
    </div>
  </section>

  <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
  <section id="dataArea" class="hidden w-full space-y-6 animate-slide-up">

    <!-- 3. ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card p-4 flex items-center gap-4 relative overflow-hidden border border-white/60 group">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Identification%20card/3D/identification_card_3d.png"
           class="absolute -right-4 -bottom-4 w-24 h-24 opacity-10 rotate-[-15deg] pointer-events-none grayscale">

      <div class="w-16 h-16 bg-gray-100 rounded-full border border-gray-100 flex items-center justify-center shrink-0 overflow-hidden shadow-inner z-10">
        <div id="userAvatar" class="w-full h-full flex items-center justify-center text-[48px] leading-none select-none"></div>
      </div>

      <div class="flex-1 min-w-0 z-10">
        <div class="flex items-center gap-2 mb-0.5">
          <h2 class="text-[20px] font-bold text-ink tracking-tight truncate" id="uiName">--</h2>
          <span class="px-1.5 py-[1px] rounded bg-iosBlue/10 text-iosBlue text-[10px] font-bold border border-iosBlue/10">STUDENT</span>
        </div>
        <div class="space-y-0.5 text-sub text-[13px] font-medium">
          <div class="flex items-center gap-1.5">
            <span class="opacity-70">ID</span>
            <span id="uiId" class="font-mono text-ink">--</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="opacity-70">CL</span>
            <span id="uiClass" class="text-ink truncate">--</span>
          </div>
        </div>
      </div>

      <button onclick="handleLogout(true)"
              class="shrink-0 p-2 text-sub hover:text-iosRed bg-gray-50 hover:bg-red-50 rounded-full transition-all z-10"
              title="é€€å‡ºç™»å½•">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
        </svg>
      </button>
    </div>

    <!-- 4. ä¸€å¡é€šå¡ç‰‡ -->
    <div class="w-full bg-white border border-gray-200 rounded-2xl shadow-ios-card p-5 flex flex-col justify-between relative overflow-hidden h-[150px] group transition-all hover:shadow-ios-float active:scale-[0.99]">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Credit%20card/3D/credit_card_3d.png"
           class="absolute -right-4 -bottom-4 w-24 h-24 opacity-20 rotate-[-10deg] group-hover:rotate-0 group-hover:scale-105 transition-all duration-300 z-0 grayscale">

      <div class="flex justify-between items-start z-10 relative">
        <div class="flex items-center gap-3">
          <svg width="36" height="26" viewBox="0 0 40 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
            <rect width="40" height="28" rx="4" fill="#F0F0F0"/>
            <rect x="2" y="2" width="36" height="24" rx="2" stroke="#999" stroke-opacity="0.2" stroke-width="1"/>
            <path d="M12 2V26" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M28 2V26" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M2 14H12" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <path d="M28 14H38" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
            <rect x="15" y="8" width="10" height="12" rx="2" stroke="#999" stroke-opacity="0.3" stroke-width="1.5"/>
          </svg>
          <span class="text-[11px] font-bold tracking-widest uppercase text-sub mt-1">Campus Card</span>
        </div>
        <span class="px-2 py-0.5 bg-gray-100 rounded border border-gray-200 text-[10px] font-bold text-sub" id="ecStatus">--</span>
      </div>

      <div class="z-10 mt-1 flex justify-between items-end relative">
        <div class="flex flex-col">
          <span class="text-[10px] text-sub font-semibold uppercase mb-0.5 ml-0.5">Balance</span>
          <div class="text-4xl font-bold tracking-tighter flex items-baseline gap-1 text-ink">
            <span class="text-lg text-iosYellow font-bold">Â¥</span>
            <span id="ecBalance" class="drop-shadow-sm">--</span>
          </div>
        </div>
        <button onclick="loadEcard(true)" class="p-2 rounded-full bg-gray-50 border border-gray-100 hover:bg-gray-100 active:scale-90 transition-all text-sub">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
          </svg>
        </button>
      </div>
    </div>

    <!-- è¯¾è¡¨ -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card overflow-hidden border border-white/60">
      <div class="flex items-center justify-between p-4 border-b border-gray-100 bg-white/50 backdrop-blur-sm">
        <div class="flex items-center gap-3">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Spiral%20calendar/3D/spiral_calendar_3d.png" class="w-8 h-8 icon-3d">
          <div>
            <h3 class="text-[17px] font-bold tracking-tight text-ink">æœ¬å‘¨è¯¾è¡¨</h3>
            <span class="text-[11px] font-medium text-sub" id="schWeek">Loading...</span>
          </div>
        </div>
        <button onclick="loadSchedule(true)" class="text-[13px] font-bold text-iosBlue bg-iosBlue/5 px-3 py-1.5 rounded-full hover:bg-iosBlue/10 active:scale-95 transition-all">
          åˆ·æ–°
        </button>
      </div>
      <div class="overflow-x-auto hide-scroll pb-2 bg-white">
        <div class="min-w-[160vw] md:min-w-full" id="scheduleContainer"></div>
      </div>
    </div>

    <!-- 5. æˆç»© -->
    <div class="bg-iosCard rounded-2xl shadow-ios-card overflow-hidden transition-all duration-300 border border-white/60" data-panel="grades" data-open="false">
      <div class="flex items-center justify-between p-4 border-b border-gray-100 cursor-pointer active:bg-gray-50 transition-colors" onclick="togglePanel('grades')">
        <div class="flex items-center gap-3">
          <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Trophy/3D/trophy_3d.png" class="w-8 h-8 icon-3d">
          <div class="flex flex-col items-start">
            <div class="flex items-center gap-2">
              <h3 class="text-[17px] font-bold tracking-tight text-ink">æˆç»©å•</h3>
              <span id="gradeSource" class="px-1.5 py-0.5 text-[10px] font-bold bg-gray-100 rounded text-sub hidden transform scale-90 origin-left"></span>
            </div>
            <span class="text-[11px] font-medium text-sub">ç‚¹å‡»å±•å¼€/æ”¶èµ·</span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="event.stopPropagation(); refreshGradesButton()"
                  class="text-[13px] font-bold text-iosBlue bg-iosBlue/5 px-3 py-1.5 rounded-full hover:bg-iosBlue/10 active:scale-95 transition-all">
            åˆ·æ–°
          </button>
          <div class="w-6 h-6 flex items-center justify-center transition-transform duration-300" id="gradeArrow">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          </div>
        </div>
      </div>

      <div id="panelContent-grades" class="hidden bg-iosBg">
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
              <div class="text-[10px] text-sub mb-1 uppercase tracking-wider font-bold">Credits</div>
              <div id="gCredits" class="text-2xl font-bold text-ink tracking-tight">--</div>
            </div>
            <div class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
              <div class="text-[10px] text-sub mb-1 uppercase tracking-wider font-bold">GPA</div>
              <div id="gGpa" class="text-2xl font-bold text-iosTeal tracking-tight">--</div>
            </div>
          </div>

          <div id="gradeList" class="space-y-4 min-h-[100px]"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- åº•éƒ¨åŒºåŸŸ -->
  <footer class="mt-8 mb-4 w-full flex justify-center">
    <button onclick="toggleAboutModal(true)"
            class="group flex items-center gap-2 px-5 py-2.5 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-300">
      <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Information/3D/information_3d.png" class="w-4 h-4 group-hover:rotate-12 transition-transform">
      <span class="text-[12px] font-semibold text-sub group-hover:text-ink">å…³äºæœåŠ¡</span>
    </button>
  </footer>

  <!-- å…³äºæœåŠ¡ Modal -->
  <div id="aboutModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-6">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px] transition-opacity" onclick="toggleAboutModal(false)"></div>
    <div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-ios-float w-full max-w-sm p-6 relative z-10 animate-fade-in text-center">
      <div class="mb-5">
        <img src="https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@latest/assets/Rocket/3D/rocket_3d.png"
             width="64" height="64"
             class="mx-auto mb-3 drop-shadow-md icon-3d"
             alt="Rocket">
        <h3 class="text-lg font-bold text-ink">å…³äºæ–‡ç†å°åŠ©æ‰‹</h3>
        <p class="text-[11px] font-medium text-sub mt-1">Version 1.0.3 (Stable)</p>
      </div>

      <div class="space-y-3 text-[13px] font-medium text-sub leading-relaxed bg-gray-50/50 p-4 rounded-xl border border-gray-100 mb-6 text-left">
        <p class="flex gap-2"><span>ğŸ“</span> <span class="text-ink">çº¯å‡€æ— å¹¿ï¼Œä»…æä¾›æ ¸å¿ƒæŸ¥è¯¢ã€‚</span></p>
        <p class="flex gap-2"><span>ğŸ”’</span> <span class="text-ink">æœ¬åœ°ç›´è¿ï¼Œä¸å­˜å‚¨ä»»ä½•å¯†ç ã€‚</span></p>
        <p class="flex gap-2"><span>ğŸ”¨</span> <span class="text-ink">åé¦ˆè”ç³»ï¼š-nullsleep</span></p>
        <p class="flex gap-2">
          <span>ğŸ“¶</span>
          <a href="http://8.134.208.242:13001/dashboard" class="text-iosBlue font-semibold underline decoration-iosBlue/30 underline-offset-2" target="_blank">
            æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
          </a>
        </p>
      </div>

      <button onclick="toggleAboutModal(false)" class="w-full bg-iosBlue text-white font-bold py-3 rounded-xl active:opacity-70 transition-opacity">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
/**
 * ============================================================
 * æ–‡ç†å°åŠ©æ‰‹ï¼ˆå•æ–‡ä»¶é‡æ„ç‰ˆï¼ŒVanilla SPAï¼‰
 * ------------------------------------------------------------
 * ç›®æ ‡ï¼š
 * 1) ä¿æŒåŸæœ‰ UI/äº¤äº’/æ¥å£å¥‘çº¦ä¸å˜ï¼ˆDOM idã€onclick å…¥å£ä¸å˜ï¼‰
 * 2) å½»åº•è§£å†³ç«æ€è¦†ç›–ã€æˆç»©åŒè¯·æ±‚ã€æ¥å£å¤±è´¥æœªåˆ¤å®šã€Loading å¹¶å‘é—ªçƒç­‰é€»è¾‘é—®é¢˜
 * 3) ä»£ç åˆ†åŒºæ˜ç¡®ï¼ˆâ€œç”Ÿæˆçº§åˆ«æ³¨é‡Šâ€ï¼‰ï¼šçŠ¶æ€/å­˜å‚¨/API/ä¸šåŠ¡/æ¸²æŸ“/æ§åˆ¶å™¨
 *
 * æ³¨æ„ï¼šä¸è®¨è®ºå®‰å…¨ï¼›åªåšé€»è¾‘æ­£ç¡®æ€§ä¸å¯ç»´æŠ¤æ€§ä¼˜åŒ–ã€‚
 * ============================================================
 */
(() => {
  'use strict';

  /*****************************************************************
   * 0) é…ç½®
   *****************************************************************/
  const API_BASE = '';  // åŒæºéƒ¨ç½²å»ºè®®ç•™ç©º
  const DEBUG = true;

  // è¯¾ç¨‹é…è‰²ï¼ˆä¿æŒåŸæ ·ï¼‰
  const COURSE_COLORS = [
    'bg-[#E8F2FF] border-[#B6D6F5] text-[#004085]',
    'bg-[#E8F8F5] border-[#A3E4D7] text-[#0E6251]',
    'bg-[#FEF9E7] border-[#F9E79F] text-[#9C640C]',
    'bg-[#FFF0F0] border-[#F5B7B1] text-[#922B21]',
    'bg-[#F3E5F5] border-[#D7BDE2] text-[#6A1B9A]',
    'bg-[#E0F2F1] border-[#80CBC4] text-[#004D40]',
    'bg-[#FBE9E7] border-[#FFCCBC] text-[#BF360C]'
  ];

  /*****************************************************************
   * 1) DOM Helpers
   *****************************************************************/
  const $ = (id) => document.getElementById(id);

  function toggleHidden(el, hidden) {
    if (!el) return;
    el.classList.toggle('hidden', !!hidden);
  }

  /*****************************************************************
   * 2) Loggerï¼ˆå¯æ›¿æ¢ä¸º noop / ä¸ŠæŠ¥ç³»ç»Ÿï¼‰
   *****************************************************************/
  const log  = (...args) => DEBUG && console.log('%c[UI]', 'color:#007AFF;font-weight:bold', ...args);
  const warn = (...args) => DEBUG && console.warn('%c[UI]', 'color:#FF9500;font-weight:bold', ...args);
  const err  = (...args) => DEBUG && console.error('%c[UI]', 'color:#FF3B30;font-weight:bold', ...args);

  function group(title, fn) {
    if (!DEBUG) return fn();
    console.groupCollapsed(`%c[UI] ${title}`, 'color:#007AFF;font-weight:bold');
    try { return fn(); } finally { console.groupEnd(); }
  }

  /*****************************************************************
   * 3) è½»é‡ Storeï¼ˆå•æ–‡ä»¶å†…çš„â€œæ¨¡å—åŒ–â€ï¼‰
   *    - é¿å…å…¨å±€å˜é‡æ•£è½ï¼›å¹¶ä¸ºâ€œå¹¶å‘/çŠ¶æ€æœºâ€æä¾›ç»Ÿä¸€å…¥å£
   *****************************************************************/
  function createStore(initial) {
    let state = structuredClone(initial);
    const subs = new Set();
    return {
      get: () => state,
      set: (patch) => {
        const next = (typeof patch === 'function') ? patch(state) : { ...state, ...patch };
        state = next;
        subs.forEach(fn => fn(state));
      },
      subscribe: (fn) => { subs.add(fn); return () => subs.delete(fn); }
    };
  }

  /*****************************************************************
   * 4) æ ¸å¿ƒçŠ¶æ€ï¼ˆä¸¥æ ¼å…¼å®¹ä½ åŸæœ‰å­—æ®µè¯­ä¹‰ï¼‰
   *****************************************************************/
  const uiStore = createStore({
    /** âœ… åªåœ¨ logout æ—¶é€’å¢ï¼šç”¨äºé˜²æ­¢â€œç™»å‡ºåæ—§è¯·æ±‚å†™å›â€ */
    sessionVersion: 0,
    /** Loading å¼•ç”¨è®¡æ•°ï¼šå¹¶å‘è¯·æ±‚ä¸ä¼šæå‰å…³æ‰é®ç½© */
    loadingCount: 0,
  });

  const authStore = createStore({
    /** token & ç‰ˆæœ¬ï¼šæ¯æ¬¡ token å˜åŒ–é€’å¢ï¼Œç”¨äºä¸¢å¼ƒæ—§å“åº” */
    token: localStorage.getItem('huas_token') || '',
    authVersion: 0,

    /** éªŒè¯ç ä¼šè¯ä¸çŠ¶æ€ */
    sessionId: '',
    requireCaptcha: false,

    /** single-flightï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è§¦å‘åªç™»å½•ä¸€æ¬¡ */
    reauthPromise: null,
    isRelogging: false,

    /** ç™»å½•äº’æ–¥é”ï¼šé˜²æ­¢ç”¨æˆ·ç‹‚ç‚¹â€œè¿›å…¥ç³»ç»Ÿâ€ */
    loginPromise: null,

    /** é˜²é‡å¤å¼¹çª— */
    reauthFailedNotified: false,
    noTokenNotified: false,

    /** âœ… NO_TOKEN è‡ªåŠ¨é‡ç™»å†·å´ */
    AUTO_RELOGIN_COOLDOWN_MS: 8000,
    lastAutoReloginFailedAt: 0,

    /** âœ… ç½‘ç»œé”™è¯¯æŒ‰ key ä»…é‡è¯•ä¸€æ¬¡ï¼ˆçª—å£æœŸï¼‰ */
    RETRY_WINDOW_MS: 5000,
  });

  /*****************************************************************
   * 5) Loadingï¼ˆå¼•ç”¨è®¡æ•°ï¼‰
   *****************************************************************/
  function setLoading(on) {
    uiStore.set(s => {
      const nextCount = Math.max(0, s.loadingCount + (on ? 1 : -1));
      return { ...s, loadingCount: nextCount };
    });
    const { loadingCount } = uiStore.get();
    toggleHidden($('loading'), loadingCount === 0);
  }

  /*****************************************************************
   * 6) åŸºç¡€ UI åˆ‡æ¢ï¼ˆä¿æŒåŸæœ‰ id/ç»“æ„ï¼‰
   *****************************************************************/
  function showLogin() {
    toggleHidden($('dataArea'), true);
    toggleHidden($('loginCard'), false);
  }

  function showData() {
    toggleHidden($('loginCard'), true);
    toggleHidden($('dataArea'), false);
  }

  function setLoginButtonDisabled(disabled) {
    const btn = $('loginBtn');
    if (!btn) return;
    btn.disabled = disabled;
    btn.classList.toggle('opacity-60', disabled);
    btn.classList.toggle('pointer-events-none', disabled);
  }

  // HTML é‡ŒæŒ‰é’®åœ¨ç”¨
  window.toggleAboutModal = function(show) {
    toggleHidden($('aboutModal'), !show);
  };

  /*****************************************************************
   * 7) Credentials Repoï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼šlocalStorage + IndexedDBï¼Œå¤š key å¤‡ä»½ï¼‰
   *****************************************************************/
  const SAVED_CRED_KEY = 'huas_saved_cred';
  const SAVED_CRED_KEYS = [SAVED_CRED_KEY, 'huas_saved_cred_bak1', 'huas_saved_cred_bak2'];
  const IDB_CONFIG = { name: 'huasCredDB', store: 'creds', key: 'primary' };

  function readCredentialsLocal() {
    for (const key of SAVED_CRED_KEYS) {
      const raw = localStorage.getItem(key);
      if (!raw) continue;
      try {
        const parsed = JSON.parse(raw);
        if (parsed && (parsed.username || parsed.password)) return parsed;
      } catch {}
    }
    return null;
  }

  function saveCredentialsLocal(payload) {
    try {
      const data = JSON.stringify(payload);
      SAVED_CRED_KEYS.forEach(k => localStorage.setItem(k, data));
    } catch {}
  }

  function clearCredentialsLocal() {
    SAVED_CRED_KEYS.forEach(k => localStorage.removeItem(k));
  }

  function openCredDB() {
    return new Promise((resolve) => {
      if (!('indexedDB' in window)) return resolve(null);
      const req = indexedDB.open(IDB_CONFIG.name, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(IDB_CONFIG.store)) db.createObjectStore(IDB_CONFIG.store);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => resolve(null);
    });
  }

  async function saveCredentialsIndexedDB(payload) {
    const db = await openCredDB();
    if (!db) return false;
    return new Promise((resolve) => {
      const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
      tx.objectStore(IDB_CONFIG.store).put(payload, IDB_CONFIG.key);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  }

  async function loadCredentialsIndexedDB() {
    const db = await openCredDB();
    if (!db) return null;
    return new Promise((resolve) => {
      const tx = db.transaction(IDB_CONFIG.store, 'readonly');
      const req = tx.objectStore(IDB_CONFIG.store).get(IDB_CONFIG.key);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => resolve(null);
    });
  }

  async function clearCredentialsIndexedDB() {
    const db = await openCredDB();
    if (!db) return false;
    return new Promise((resolve) => {
      const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
      tx.objectStore(IDB_CONFIG.store).delete(IDB_CONFIG.key);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  }

  async function getSavedCredentials() {
    try {
      const local = readCredentialsLocal();
      if (local) return local;
      const idb = await loadCredentialsIndexedDB();
      return idb || null;
    } catch {
      return null;
    }
  }

  async function saveCredentialsIfNeeded(username, password) {
    const remember = $('rememberMe')?.checked;
    if (remember) {
      const payload = { username, password, remember: true };
      saveCredentialsLocal(payload);
      await saveCredentialsIndexedDB(payload);
    } else {
      clearCredentialsLocal();
      await clearCredentialsIndexedDB();
    }
  }

  async function loadSavedCredentialsToUI() {
    try {
      const saved = await getSavedCredentials();
      if (!saved) {
        log('no saved credentials -> default rememberMe checked');
        if ($('rememberMe')) $('rememberMe').checked = true;
        return;
      }

      const { username, password, remember } = saved;
      if (username) $('username').value = username;
      if (password) $('password').value = password;
      if (remember !== undefined && $('rememberMe')) $('rememberMe').checked = remember;
    } catch (e) {
      err('loadSavedCredentialsToUI error', e);
    }
  }

  /*****************************************************************
   * 8) Request Gateï¼ˆå¹¶å‘æ²»ç†ï¼‰
   *    - singleFlightï¼šåŒ key å¹¶å‘å¤ç”¨ä¸€æ¬¡è¯·æ±‚
   *    - latestAbortableï¼šåŒ key è¿ç»­è§¦å‘ï¼Œå–æ¶ˆå‰ä¸€ä¸ªï¼Œä»…æœ€åä¸€æ¬¡å…è®¸å†™å›
   *****************************************************************/
  function createRequestGate() {
    const inFlight = new Map();          // key -> Promise
    const aborters = new Map();          // key -> AbortController
    const latestSeq = new Map();         // key -> number

    return {
      async singleFlight(key, fn) {
        if (inFlight.has(key)) return inFlight.get(key);
        const p = (async () => fn())().finally(() => inFlight.delete(key));
        inFlight.set(key, p);
        return p;
      },

      /**
       * latestAbortableï¼š
       * - å¯¹äºâ€œåˆ·æ–°ç±»â€éå¸¸å…³é”®ï¼ˆæˆç»©é¢æ¿ï¼‰
       * - å–æ¶ˆæ—§è¯·æ±‚ï¼Œé¿å…æµªè´¹ï¼›ä¸”ä¿è¯æœ€åä¸€æ¬¡å†™å›
       *
       * @param {string} key
       * @param {(signal:AbortSignal)=>Promise<any>} fn
       */
      async latestAbortable(key, fn) {
        // é€’å¢åºå·ï¼Œæ ‡è®°æœ¬æ¬¡ä¸ºâ€œæœ€æ–°æ„å›¾â€
        const seq = (latestSeq.get(key) || 0) + 1;
        latestSeq.set(key, seq);

        // å–æ¶ˆæ—§è¯·æ±‚
        const prev = aborters.get(key);
        if (prev) prev.abort();
        const ac = new AbortController();
        aborters.set(key, ac);

        const result = await fn(ac.signal);

        // è‹¥æœŸé—´åˆæœ‰æ›´æ–°æ„å›¾ï¼ˆseq è¢«æ”¹äº†ï¼‰ï¼Œåˆ™ä¸¢å¼ƒ
        if (latestSeq.get(key) !== seq) {
          const e = new Error('STALE_RESPONSE_DROPPED');
          e.code = 'STALE_RESPONSE_DROPPED';
          throw e;
        }
        return result;
      }
    };
  }

  const requestGate = createRequestGate();

  /*****************************************************************
   * 9) é”™è¯¯åˆ¤æ–­ & ç»Ÿä¸€é‡è¯•ä¸€æ¬¡çª—å£
   *****************************************************************/
  const retryOnceMap = new Map(); // key -> timestamp

  function isNetworkErrorMessage(msg) {
    const s = String(msg || '');
    return (
      s.includes('Failed to fetch') ||
      s.includes('NetworkError') ||
      s.includes('Load failed') ||
      s.includes('ç½‘ç»œ') ||
      s.includes('timeout') ||
      s.includes('è¶…æ—¶')
    );
  }

  /*****************************************************************
   * 10) Token ç®¡ç†ï¼ˆä¸¥æ ¼ä¿ç•™ä½ çš„è¯­ä¹‰ï¼šauthVersion++ã€localStorage åŒæ­¥ï¼‰
   *****************************************************************/
  function setToken(token, reason = '') {
    authStore.set(s => ({ ...s, token: token || '', authVersion: s.authVersion + 1 }));
    const { token: t, authVersion } = authStore.get();

    if (t) localStorage.setItem('huas_token', t);
    else localStorage.removeItem('huas_token');

    log('setToken()', {
      authVersion,
      hasToken: !!t,
      tokenPreview: t ? String(t).slice(0, 12) + '...' : '',
      reason
    });
  }

  function hasToken() {
    return !!authStore.get().token;
  }

  /*****************************************************************
   * 11) AuthServiceï¼ˆéªŒè¯ç /ç™»å½•/è‡ªåŠ¨é‡ç™» single-flight + å†·å´ï¼‰
   *****************************************************************/
  async function fetchCaptchaSession({ forceShow = false, withSpinner = false } = {}) {
    if (withSpinner) setLoading(true);

    group('fetchCaptchaSession()', () => {
      const s = authStore.get();
      log('params', { forceShow, withSpinner, requireCaptcha: s.requireCaptcha, sessionId: s.sessionId });
    });

    try {
      const res = await fetch(`${API_BASE}/auth/captcha`, { cache: 'no-store' });
      const json = await res.json();
      log('captcha response', json);

      if (json.code === 200) {
        authStore.set(s => ({ ...s, sessionId: json.data.sessionId }));
        // è¿™é‡Œâ€œå³ä½¿ä¸å¼ºåˆ¶å±•ç¤ºâ€ï¼Œä¹ŸæŠŠå›¾ç‰‡å‡†å¤‡å¥½ï¼›éœ€è¦æ—¶ç«‹åˆ»å¯æ˜¾ç¤º
        const img = $('captchaImg');
        if (img) {
          img.src = 'data:image/png;base64,' + json.data.image;
        }

        if (forceShow) {
          authStore.set(s => ({ ...s, requireCaptcha: true }));
          toggleHidden($('captchaBlock'), false);
          toggleHidden($('captchaImg'), false);
          toggleHidden($('captchaText'), true);
        } else {
          // ä¸å¼ºåˆ¶æ˜¾ç¤ºï¼šä¿æŒä½ åŸâ€œæŒ‰éœ€æ˜¾ç¤ºâ€é€»è¾‘
          if (!authStore.get().requireCaptcha) toggleHidden($('captchaBlock'), true);
        }
        return true;
      }

      alert('éªŒè¯ç è·å–å¤±è´¥: ' + (json.msg || 'æœªçŸ¥é”™è¯¯'));
      return false;
    } catch (e) {
      err('fetchCaptchaSession error', e);
      alert('éªŒè¯ç è¯·æ±‚é”™è¯¯');
      return false;
    } finally {
      if (withSpinner) setLoading(false);
    }
  }

  async function ensureCaptchaSession(forceShow = false, withSpinner = false) {
    const s = authStore.get();
    if (!s.sessionId) {
      // éœ€è¦ sessionIdï¼šæ‹‰ä¸€æ¬¡ captcha sessionï¼ˆä¸ä¸€å®šå±•ç¤ºï¼‰
      await fetchCaptchaSession({ forceShow, withSpinner });
      return;
    }
    if (forceShow) {
      authStore.set(st => ({ ...st, requireCaptcha: true }));
      toggleHidden($('captchaBlock'), false);
    }
  }

  async function performLogin(username, password, captcha, quiet = false, retryCount = 0) {
    group(`performLogin(quiet=${quiet})`, () => {
      const s = authStore.get();
      log('payload draft', {
        username,
        hasPwd: !!password,
        hasCaptcha: !!captcha,
        requireCaptcha: s.requireCaptcha,
        sessionId: s.sessionId,
        retryCount
      });
    });

    try {
      // âœ… ä¸¥æ ¼å®ç°ä½ åŸè¦æ±‚ï¼šç™»å½•å‰ç¡®ä¿ sessionId/éªŒè¯ç å›¾å·²å‡†å¤‡
      // - ä½†ä¼˜åŒ–ï¼šå¦‚æœä¸éœ€è¦å±•ç¤ºéªŒè¯ç ï¼Œä¸é¢å¤–æ‰“å¼€éªŒè¯ç  UI
      await ensureCaptchaSession(authStore.get().requireCaptcha, false);

      const s = authStore.get();
      const payload = { sessionId: s.sessionId, username, password };
      if (s.requireCaptcha || captcha) payload.code = captcha;

      const res = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      log('login response', json);

      if (json.code === 200) {
        setToken(json.token, quiet ? 'silent relogin / auto login' : 'interactive login');

        authStore.set(st => ({
          ...st,
          reauthFailedNotified: false,
          noTokenNotified: false,
          lastAutoReloginFailedAt: 0,
          requireCaptcha: false
        }));

        toggleHidden($('captchaBlock'), true);

        if (!quiet) {
          await saveCredentialsIfNeeded(username, password);
        }
        return true;
      }

      // éœ€è¦éªŒè¯ç ï¼šè¿›å…¥éªŒè¯ç æ€ + æ‹‰æ–°å›¾
      if (json.action === 'NEED_CAPTCHA') {
        warn('login need captcha', json.msg);

        authStore.set(st => ({ ...st, requireCaptcha: true }));
        toggleHidden($('captchaBlock'), false);
        if ($('captcha')) $('captcha').value = '';

        await fetchCaptchaSession({ forceShow: true, withSpinner: false });

        if (!quiet) alert(json.msg || 'ç™»å½•å¤±è´¥ï¼Œéœ€è¦éªŒè¯ç ï¼Œè¯·è¾“å…¥éªŒè¯ç åå†è¯•');
        return false;
      }

      // ä¼šè¯IDæ— æ•ˆï¼šåˆ·æ–° sessionId åä»…é‡è¯•ä¸€æ¬¡ï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼‰
      if (json.code === 400 && json.msg && String(json.msg).includes('ä¼šè¯IDæ— æ•ˆ')) {
        warn('login invalid sessionId -> refresh captcha session', { retryCount });
        if (retryCount >= 1) {
          if (!quiet) alert('ä¼šè¯å¤šæ¬¡å¤±æ•ˆï¼Œè¯·åˆ·æ–°éªŒè¯ç åé‡è¯•');
          return false;
        }
        authStore.set(st => ({ ...st, sessionId: '' }));
        await fetchCaptchaSession({ forceShow: false, withSpinner: false });
        return performLogin(username, password, '', quiet, retryCount + 1);
      }

      warn('login failed', json.msg);
      if (!quiet) alert('ç™»å½•å¤±è´¥: ' + (json.msg || 'æœªçŸ¥é”™è¯¯'));

      // è‡ªåŠ¨ç™»å½•å¤±è´¥ä¸”ä¸æ˜¯ NEED_CAPTCHAï¼šè¿›å…¥å†·å´
      if (quiet && !authStore.get().requireCaptcha) {
        authStore.set(st => ({ ...st, lastAutoReloginFailedAt: Date.now() }));
      }
      return false;

    } catch (e) {
      err('login error', e);
      if (!quiet) alert('ç™»å½•è¯·æ±‚é”™è¯¯');

      if (quiet && !authStore.get().requireCaptcha) {
        authStore.set(st => ({ ...st, lastAutoReloginFailedAt: Date.now() }));
      }
      return false;
    }
  }

  async function tryAutoRelogin() {
    const s = authStore.get();
    if (s.isRelogging) {
      warn('tryAutoRelogin: already relogging -> skip');
      return false;
    }

    const saved = await getSavedCredentials();
    if (!saved || !saved.username || !saved.password || saved.remember !== true) {
      warn('tryAutoRelogin: no saved credentials / remember not true', saved);
      authStore.set(st => ({ ...st, lastAutoReloginFailedAt: Date.now() }));
      return false;
    }

    authStore.set(st => ({ ...st, isRelogging: true }));
    group('tryAutoRelogin()', () => log('saved credentials found', { username: saved.username, remember: saved.remember }));

    try {
      // é‡ç½®éªŒè¯ç æ€ï¼ˆä¿æŒä½ åŸè®¾è®¡ï¼‰
      authStore.set(st => ({ ...st, sessionId: '', requireCaptcha: false }));

      const ok = await performLogin(saved.username, saved.password, '', true);
      log('tryAutoRelogin result', { ok, hasToken: hasToken(), authVersion: authStore.get().authVersion });

      if (!ok && !authStore.get().requireCaptcha) {
        authStore.set(st => ({ ...st, lastAutoReloginFailedAt: Date.now() }));
      }
      return ok;
    } finally {
      authStore.set(st => ({ ...st, isRelogging: false }));
    }
  }

  async function ensureRelogin(trigger = '') {
    const s = authStore.get();
    const now = Date.now();

    // âœ… NO_TOKEN/AUTO_ON_LOAD å†·å´ï¼ˆ401 ä¸å†·å´ï¼‰
    if ((trigger === 'NO_TOKEN' || trigger === 'AUTO_ON_LOAD') &&
        s.lastAutoReloginFailedAt &&
        (now - s.lastAutoReloginFailedAt) < s.AUTO_RELOGIN_COOLDOWN_MS) {
      warn('ensureRelogin: cooldown active -> skip', {
        trigger,
        cooldownLeftMs: s.AUTO_RELOGIN_COOLDOWN_MS - (now - s.lastAutoReloginFailedAt)
      });
      return false;
    }

    // single-flightï¼šå¹¶å‘å¤ç”¨åŒä¸€ä¸ª reauthPromise
    if (!s.reauthPromise) {
      const p = (async () => {
        group(`ensureRelogin(trigger=${trigger})`, () => {
          const st = authStore.get();
          log('start', { requireCaptcha: st.requireCaptcha, hasToken: hasToken(), authVersion: st.authVersion });
        });

        // å¦‚æœå·²ç»è¢«å…¶å®ƒå¹¶å‘è¯·æ±‚ä¿®å¤äº† tokenï¼Œåˆ™ç›´æ¥æˆåŠŸ
        if (hasToken()) {
          log('ensureRelogin: already has token -> skip login');
          return true;
        }

        const ok = await tryAutoRelogin();
        log('ensureRelogin: result', { ok, hasToken: hasToken(), authVersion: authStore.get().authVersion });
        return ok;
      })().finally(() => {
        authStore.set(st => ({ ...st, reauthPromise: null }));
        log('ensureRelogin: end (reauthPromise cleared)');
      });

      authStore.set(st => ({ ...st, reauthPromise: p }));
    } else {
      log('ensureRelogin: reuse existing reauthPromise (single-flight)');
    }

    return authStore.get().reauthPromise;
  }

  /*****************************************************************
   * 12) ApiClientï¼ˆä¸¥æ ¼ï¼šé 2xx / code!=200 ç›´æ¥ throwï¼›401 è‡ªåŠ¨é‡ç™»é‡æ”¾ä¸€æ¬¡ï¼‰
   *****************************************************************/
  async function apiFetchJson(path, { method='GET', headers={}, body, cache='no-store', retry=true, signal } = {}) {
    const url = `${API_BASE}${path}`;

    // âœ… æ—  tokenï¼šå°è¯•è‡ªåŠ¨ç™»å½•ï¼ˆä¸ä½ åŸé€»è¾‘ä¸€è‡´ï¼‰
    if (!hasToken()) {
      warn('apiFetchJson: NO_TOKEN -> ensureRelogin()', { url, retry });
      if (!retry) throw new Error('NO_TOKEN');

      const ok = await ensureRelogin('NO_TOKEN');
      if (!ok || !hasToken()) throw new Error('NO_TOKEN');
    }

    const token = authStore.get().token;

    const res = await fetch(url, {
      method,
      headers: {
        ...headers,
        Authorization: token,
        ...(body ? { 'Content-Type': 'application/json' } : {}),
      },
      body: body ? JSON.stringify(body) : undefined,
      cache,
      signal
    });

    // 401ï¼šå¼ºåˆ¶æ¸… token -> ensureRelogin('401') -> é‡æ”¾ä¸€æ¬¡
    if (res.status === 401) {
      warn('apiFetchJson: got 401 -> invalidate token', { url, retry });
      setToken('', 'apiFetchJson 401 -> invalidate token');

      if (!retry) throw new Error('SESSION_EXPIRED');

      const ok = await ensureRelogin('401');
      if (!ok) throw new Error('SESSION_EXPIRED');

      // é‡æ”¾ä¸€æ¬¡ï¼ˆretry=false é˜²æ­»å¾ªç¯ï¼‰
      return apiFetchJson(path, { method, headers, body, cache, retry: false, signal });
    }

    // âœ… é 2xxï¼šç›´æ¥æŠ›é”™ï¼ˆä¿®å¤â€œå¤±è´¥å½“æˆåŠŸâ€çš„é€»è¾‘æ¼æ´ï¼‰
    if (!res.ok) {
      const msg = `HTTP_${res.status}`;
      throw new Error(msg);
    }

    const json = await res.json();

    // âœ… åªè¦è¿”å›åŒ…å« code ä¸”ä¸ä¸º 200ï¼Œå°±è§†ä¸ºå¤±è´¥
    // ï¼ˆä½ åŸæ¥çš„ user/ecard/schedule æ²¡åˆ¤å®šï¼Œç°åœ¨ç»Ÿä¸€ï¼‰
    if (json && typeof json === 'object' && 'code' in json && json.code !== 200) {
      throw new Error(json.msg || 'API_ERROR');
    }

    return json;
  }

  /*****************************************************************
   * 13) é¢æ¿åŠ è½½æ ‡è®°ï¼ˆä¿æŒåŸè¯­ä¹‰ï¼‰
   *****************************************************************/
  const panelLoaded = { schedule: false, grades: false, ecard: false, user: false };
  let autoLoginAttempted = false;

  /*****************************************************************
   * 14) æ¸²æŸ“å‡½æ•°ï¼ˆä¿æŒ DOM id ä¸æ ·å¼ä¸å˜ï¼‰
   *****************************************************************/
  function renderUser(data) {
    if (!data) return;
    $('uiName').innerText = data.name ?? '--';
    $('uiId').innerText = data.studentId ?? '--';
    $('uiClass').innerText = data.className ?? '--';
    const avatar = $('userAvatar');
    if (avatar) avatar.textContent = 'ğŸ‘¾';
  }

  function renderEcard(data) {
    if (!data) return;

    let statusText = data.status;
    if (!statusText || String(statusText).includes('æœªçŸ¥')) statusText = 'æ­£å¸¸';

    const balanceText = (data.balance === undefined || data.balance === null) ? '0.00' : data.balance;

    const elStatus = $('ecStatus');
    elStatus.innerText = statusText;

    if (statusText === 'æ­£å¸¸') {
      elStatus.className = "px-2 py-0.5 bg-green-500/10 border border-green-500/20 rounded text-[10px] font-bold text-green-600";
    } else {
      elStatus.className = "px-2 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-[10px] font-bold text-red-600";
    }
    $('ecBalance').innerText = balanceText;
  }

  // è¯¾è¡¨æ¸²æŸ“ï¼ˆä¿æŒä½ åŸå¸ƒå±€ï¼›ä»…ä¿ç•™é€»è¾‘ç»“æ„ï¼Œé¿å…æ— è°“æ”¹åŠ¨ï¼‰
  function renderSchedule(data) {
    if (!data) return;
    $('schWeek').innerText = data.week || 'Schedule';

    const container = $('scheduleContainer');
    const isMobile = window.innerWidth < 768;
    const leftColWidth = isMobile ? 50 : 60;
    const dayMinWidth = isMobile ? 90 : 110;
    container.style.minWidth = `${leftColWidth + 7 * dayMinWidth}px`;

    // å…¼å®¹ï¼šsection å¯èƒ½æ˜¯ "1-2" / "1-4" / "1-2,3-4" ç­‰
    // âœ… ä¼˜åŒ–ä½†ä¸æ”¹å˜ä½ åŸå±•ç¤ºè§„åˆ™ï¼šä»ç„¶ä»¥â€œèµ·å§‹èŠ‚æ¬¡â€è½æ ¼ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
    const courseMap = {};
    if (data.courses && Array.isArray(data.courses)) {
      data.courses.forEach(c => {
        const match = String(c.section || '').match(/(\d+)/);
        if (!match) return;
        const startNode = parseInt(match[1], 10);
        const sectionIdx = Math.floor((startNode - 1) / 2);
        const dayIdx = (c.day || 1) - 1;
        const key = `${dayIdx}_${sectionIdx}`;
        if (!courseMap[key]) courseMap[key] = [];
        courseMap[key].push(c);
      });
    }

    let html = `<div class="grid" style="grid-template-columns:${leftColWidth}px repeat(7, minmax(${dayMinWidth}px,1fr));">`;
    html += `<div class="sticky-col sticky-shadow bg-[#FFFFFF] border-b border-r border-gray-100 z-40" style="width:${leftColWidth}px"></div>`;

    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const todayColIdx = (new Date().getDay() + 6) % 7;

    days.forEach((d, i) => {
      const isToday = i === todayColIdx;
      const bgClass = isToday ? 'text-iosBlue bg-iosBlue/5 font-bold' : 'text-sub font-semibold';
      html += `<div class="text-center text-[11px] py-3 border-b border-gray-100 ${bgClass}" data-day="${i}">${d}</div>`;
    });

    const sections = ['1-2', '3-4', '5-6', '7-8', '9-10', '11-12'];
    for (let s = 0; s < 6; s++) {
      html += `
        <div class="sticky-col sticky-shadow flex items-center justify-center font-semibold text-sub bg-[#FFFFFF] border-r border-b border-gray-100 text-[10px] z-30" style="width:${leftColWidth}px">
          ${sections[s]}
        </div>
      `;

      for (let d = 0; d < 7; d++) {
        const courses = courseMap[`${d}_${s}`];
        const colBg = d === todayColIdx ? 'bg-iosBlue/5' : '';
        html += `<div class="p-1 border-b border-gray-100 border-r border-gray-100 ${colBg} h-[120px] relative" data-day="${d}">`;

        if (courses && courses.length > 0) {
          html += `<div class="flex flex-col gap-1 h-full">`;
          courses.forEach((course, idx) => {
            const colorIdx = (d + s + idx) % COURSE_COLORS.length;
            const bgClass = COURSE_COLORS[colorIdx];
            html += `
              <div class="course-card flex-1 ${bgClass} border border-transparent rounded-lg p-2 shadow-sm cursor-pointer flex flex-col justify-between relative overflow-hidden group hover:shadow-md transition-all duration-200" title="${course.name || ''}">
                <div class="font-bold text-[11px] text-ink leading-tight line-clamp-3 z-10 relative mb-1">
                  ${course.name || '--'}
                </div>
                ${course.location ? `
                  <div class="flex justify-start z-10 relative">
                    <div class="inline-flex items-start bg-white/60 px-1.5 py-0.5 rounded text-[9px] font-semibold text-ink/80 backdrop-blur-sm max-w-full leading-tight flex-col">
                      <span class="break-words">${String(course.location).replace('æ ¡æœ¬éƒ¨', '').replace(/(æ¥¼)[A-Za-z]?\d+.*/, '$1')}</span>
                      <span class="text-[10px] font-bold">${(String(course.location).match(/(æ¥¼)([A-Za-z]?\d+)/) || [,'',''])[2]}</span>
                    </div>
                  </div>
                ` : ''}
              </div>
            `;
          });
          html += `</div>`;
        }

        html += `</div>`;
      }
    }

    html += `</div>`;
    container.innerHTML = html;
  }

  function renderGrades(data) {
    if (!data) return;

    const summary = data.summary || {};
    $('gCredits').innerText = summary.totalCredits ?? '--';
    $('gGpa').innerText = summary.averageGpa ?? '--';

    const sourceEl = $('gradeSource');
    if (data._source) {
      sourceEl.innerText = String(data._source).toUpperCase();
      sourceEl.classList.remove('hidden');
    } else {
      sourceEl.innerText = '';
      sourceEl.classList.add('hidden');
    }

    const list = $('gradeList');
    list.innerHTML = '';

    const items = data.items || [];
    if (!items.length) {
      list.innerHTML = `
        <div class="flex flex-col items-center justify-center py-8 border border-dashed border-gray-200 rounded-xl bg-gray-50/50">
          <div class="text-3xl grayscale opacity-30 mb-2">ğŸ’¯</div>
          <div class="text-xs font-bold text-sub">æš‚æ— æˆç»©æ•°æ®</div>
          <div class="text-[10px] text-gray-400 mt-1">è¯·å°è¯•åˆ·æ–°æˆ–è¯„æ•™åå†è¯•</div>
        </div>`;
      return;
    }

    const groupMap = {};
    items.forEach(item => {
      const term = item.term || 'æœªçŸ¥å­¦æœŸ';
      if (!groupMap[term]) groupMap[term] = [];
      groupMap[term].push(item);
    });

    const parseTerm = (term) => {
      const m = String(term).match(/(\d{4}).*?(\d{4}).*?(\d+)/);
      if (m) return { y1: parseInt(m[1], 10), y2: parseInt(m[2], 10), sem: parseInt(m[3], 10) };
      return null;
    };

    const sortedTerms = Object.keys(groupMap).sort((a, b) => {
      const pa = parseTerm(a); const pb = parseTerm(b);
      if (pa && pb) {
        if (pa.y1 !== pb.y1) return pb.y1 - pa.y1;
        if (pa.y2 !== pb.y2) return pb.y2 - pa.y2;
        return (pb.sem || 0) - (pa.sem || 0);
      }
      return String(b).localeCompare(String(a));
    });

    sortedTerms.forEach(term => {
      list.innerHTML += `
        <div class="px-2 py-1 text-[11px] font-semibold text-sub uppercase tracking-wider mt-4">
          ${term}
        </div>
        <div class="bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm">
      `;

      const termItems = groupMap[term];
      termItems.forEach((item, index) => {
        const passTag = item.pass === null ? '' : item.pass ? 'text-iosGreen' : 'text-iosRed';
        const scoreText = item.score !== null ? item.score : item.scoreText || '--';
        const natureText = item.courseCategory || item.courseAttribute || '';
        const natureRow = natureText ? `
          <div class="flex items-center justify-between text-[11px] text-sub mt-1">
            <span class="bg-gray-100 px-1 rounded">${natureText}</span>
          </div>` : '';
        const borderClass = index === termItems.length - 1 ? '' : 'border-b border-gray-100';

        list.innerHTML += `
          <div class="p-3.5 ${borderClass} hover:bg-gray-50 transition-colors">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="text-[15px] font-bold text-ink leading-tight mt-0.5 line-clamp-2">${item.courseName || '--'}</div>
                <div class="text-[12px] text-sub font-mono mt-0.5">${item.courseCode || '--'}</div>
              </div>
              <div class="flex flex-col items-end text-right">
                <div class="text-[17px] font-bold ${passTag}">${scoreText}</div>
                <div class="text-[11px] text-sub mt-0.5">å­¦åˆ† ${item.credit ?? '--'} Â· ç»©ç‚¹ ${item.gpa ?? '--'}</div>
              </div>
            </div>
            ${natureRow}
          </div>
        `;
      });

      list.innerHTML += `</div>`;
    });
  }

  /*****************************************************************
   * 15) æ•°æ®åŠ è½½ï¼ˆä¸¥æ ¼ä¿ç•™ï¼šsessionVersion/authVersion ä¸¢å¼ƒæ—§å“åº”ï¼‰
   *****************************************************************/
  async function loadUser(refresh = false, withSpinner = true) {
    const { sessionVersion } = uiStore.get();
    const { authVersion } = authStore.get();
    if (withSpinner) setLoading(true);

    try {
      const json = await apiFetchJson(`/api/user${refresh ? '?refresh=true' : ''}`, { retry: true });
      // æ—§å“åº”ä¸¢å¼ƒ
      if (sessionVersion !== uiStore.get().sessionVersion || authVersion !== authStore.get().authVersion) {
        warn('loadUser: stale response ignored');
        return;
      }
      renderUser(json.data);
      panelLoaded.user = true;
    } catch (e) {
      await handleFetchError(e, () => loadUser(refresh, false), 'ä¸ªäººä¿¡æ¯è·å–å¤±è´¥', 'loadUser');
    } finally {
      if (withSpinner) setLoading(false);
    }
  }

  async function loadEcard(refresh = false, withSpinner = true) {
    const { sessionVersion } = uiStore.get();
    const { authVersion } = authStore.get();
    if (withSpinner) setLoading(true);

    try {
      const json = await apiFetchJson(`/api/ecard${refresh ? '?refresh=true' : ''}`, { retry: true });
      if (sessionVersion !== uiStore.get().sessionVersion || authVersion !== authStore.get().authVersion) {
        warn('loadEcard: stale response ignored');
        return;
      }
      renderEcard(json.data);
      panelLoaded.ecard = true;
    } catch (e) {
      await handleFetchError(e, () => loadEcard(refresh, false), 'ä¸€å¡é€šè·å–å¤±è´¥', 'loadEcard');
    } finally {
      if (withSpinner) setLoading(false);
    }
  }

  async function loadSchedule(refresh = false, withSpinner = true) {
    const { sessionVersion } = uiStore.get();
    const { authVersion } = authStore.get();
    if (withSpinner) setLoading(true);

    try {
      const json = await apiFetchJson(`/api/schedule${refresh ? '?refresh=true' : ''}`, { retry: true });
      if (sessionVersion !== uiStore.get().sessionVersion || authVersion !== authStore.get().authVersion) {
        warn('loadSchedule: stale response ignored');
        return;
      }
      renderSchedule(json.data);
      panelLoaded.schedule = true;
    } catch (e) {
      await handleFetchError(e, () => loadSchedule(refresh, false), 'è¯¾è¡¨è·å–å¤±è´¥', 'loadSchedule');
    } finally {
      if (withSpinner) setLoading(false);
    }
  }

  /**
   * âœ… æˆç»©åŠ è½½ï¼šé‡‡ç”¨ latestAbortable æ ¹æ²»ç«æ€è¦†ç›–
   * - æ‰“å¼€é¢æ¿é¦–åŠ è½½ / ç”¨æˆ·ç–¯ç‹‚åˆ·æ–°ï¼šåªå…è®¸æœ€åä¸€æ¬¡å†™å›
   * - è‡ªåŠ¨å–æ¶ˆæ—§è¯·æ±‚ï¼Œé¿å…æµªè´¹
   */
  async function loadGrades(refresh = false) {
    const sv = uiStore.get().sessionVersion;
    const av = authStore.get().authVersion;

    setLoading(true);
    try {
      const json = await requestGate.latestAbortable('grades', (signal) => {
        return apiFetchJson(`/api/grades${refresh ? '?refresh=true' : ''}`, { retry: true, signal });
      });

      if (sv !== uiStore.get().sessionVersion || av !== authStore.get().authVersion) {
        warn('loadGrades: stale response ignored');
        return;
      }

      renderGrades(json.data);
      panelLoaded.grades = true;
    } catch (e) {
      if (e && e.code === 'STALE_RESPONSE_DROPPED') {
        // æ—§è¯·æ±‚è¢«å–æ¶ˆ/ä¸¢å¼ƒï¼šæ­£å¸¸æƒ…å†µï¼Œä¸æç¤º
        return;
      }
      await handleFetchError(e, () => loadGrades(refresh), 'æˆç»©è·å–å¤±è´¥', 'loadGrades');
    } finally {
      setLoading(false);
    }
  }

  async function loadAllData(withSpinner = true) {
    const v = uiStore.get().sessionVersion;
    const av = authStore.get().authVersion;
    log('loadAllData start', { sessionVersion: v, authVersion: av, hasToken: hasToken() });

    if (withSpinner) setLoading(true);
    try {
      await Promise.all([
        loadUser(false, false),
        loadEcard(false, false),
        loadSchedule(false, false),
      ]);
    } finally {
      if (withSpinner) setLoading(false);
    }
  }

  /*****************************************************************
   * 16) Panel æ§åˆ¶ï¼ˆä¿®å¤ï¼šæˆç»©åˆ·æ–°åŒè¯·æ±‚ï¼‰
   *****************************************************************/
  window.togglePanel = function(name, forceOpen = null, options = {}) {
    const container = $(`panelContent-${name}`);
    const wrapper = document.querySelector(`[data-panel="${name}"]`);
    const arrow = $('gradeArrow');

    const isOpen = !container.classList.contains('hidden');
    const next = forceOpen !== null ? forceOpen : !isOpen;

    container.classList.toggle('hidden', !next);
    wrapper?.setAttribute('data-open', next ? 'true' : 'false');

    // ç›®å‰åªæœ‰æˆç»©ç®­å¤´ï¼Œä¿æŒåŸè¡Œä¸º
    if (arrow) arrow.style.transform = next ? 'rotate(180deg)' : 'rotate(0deg)';

    // âœ… é»˜è®¤ï¼šæ‰“å¼€æˆç»©é¢æ¿ä¸”æœªåŠ è½½ -> é¦–æ¬¡åŠ è½½
    // âœ… ä¿®å¤ï¼šæ”¯æŒ options.skipAutoLoadï¼Œé¿å…åˆ·æ–°æŒ‰é’®å¯¼è‡´â€œåŒè¯·æ±‚â€
    if (next && name === 'grades' && !panelLoaded.grades && !options.skipAutoLoad) {
      loadGrades(false);
    }
  };

  window.refreshGradesButton = function() {
    const container = $('panelContent-grades');
    const isHidden = container.classList.contains('hidden');

    // âœ… å…³é”®ä¿®å¤ï¼šæ‰“å¼€é¢æ¿æ—¶è·³è¿‡ autoLoadï¼ˆå¦åˆ™ä¼š loadGrades(false) + loadGrades(true) å¹¶å‘ï¼‰
    if (isHidden) window.togglePanel('grades', true, { skipAutoLoad: true });

    // âœ… åªå‘ä¸€æ¬¡ï¼šæ˜ç¡®åˆ·æ–°
    loadGrades(true);
  };

  /*****************************************************************
   * 17) ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆä¿ç•™ä½ åŸç­–ç•¥ï¼šç½‘ç»œé‡è¯•ä¸€æ¬¡ + NO_TOKEN/SESSION_EXPIREDï¼‰
   *****************************************************************/
  async function handleFetchError(error, retryFn, fallbackMsg = 'è¯·æ±‚å¤±è´¥', retryKey = '') {
    let msg = error?.message || String(error);
    const s = authStore.get();
    warn('handleFetchError', { msg, requireCaptcha: s.requireCaptcha, hasToken: hasToken(), retryKey });

    // âœ… è‡ªåŠ¨é‡ç™»éœ€è¦éªŒè¯ç ï¼šå¼•å¯¼ç”¨æˆ·å›ç™»å½•é¡µè¾“å…¥éªŒè¯ç 
    if (authStore.get().requireCaptcha) {
      alert('è‡ªåŠ¨ç™»å½•éœ€è¦éªŒè¯ç ï¼Œè¯·åœ¨ç™»å½•é¡µè¾“å…¥éªŒè¯ç åç™»å½•');
      await handleLogout(true, true);
      return;
    }

    // âœ… ç½‘ç»œé”™è¯¯ï¼šæŒ‰ key åœ¨çª—å£æœŸå†…åªé‡è¯•ä¸€æ¬¡
    if (retryFn && retryKey && isNetworkErrorMessage(msg)) {
      const key = `${retryKey}|sv:${uiStore.get().sessionVersion}|av:${authStore.get().authVersion}`;
      const now = Date.now();
      const last = retryOnceMap.get(key) || 0;

      if (now - last > authStore.get().RETRY_WINDOW_MS) {
        retryOnceMap.set(key, now);
        warn('network error -> retry once', { key });

        try {
          await new Promise(r => setTimeout(r, 250));
          await retryFn();
          return;
        } catch (e2) {
          msg = e2?.message || String(e2);
          warn('retry once failed', { key, msg, e2 });
        }
      }
    }

    if (msg === 'NO_TOKEN') {
      if (!authStore.get().noTokenNotified) {
        alert('è¯·å…ˆç™»å½•');
        authStore.set(st => ({ ...st, noTokenNotified: true }));
      }
      await handleLogout(true, false);
      return;
    }

    if (msg === 'SESSION_EXPIRED' || msg.startsWith('HTTP_')) {
      // HTTP_401 å·²åœ¨ apiFetchJson å†…å¤„ç†ï¼›è¿™é‡Œæ›´å¤šæ˜¯ 403/500 ç­‰
      if (!authStore.get().reauthFailedNotified && msg === 'SESSION_EXPIRED') {
        alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        authStore.set(st => ({ ...st, reauthFailedNotified: true }));
      } else if (msg.startsWith('HTTP_')) {
        alert(fallbackMsg);
      }
      if (msg === 'SESSION_EXPIRED') await handleLogout(true, false);
      return;
    }

    alert(fallbackMsg);
  }

  /*****************************************************************
   * 18) ç™»å‡ºï¼ˆä¸¥æ ¼ä¿ç•™ï¼šsessionVersion++ã€token æ¸…ç†ã€captcha çŠ¶æ€å¯ä¿ç•™ï¼‰
   *****************************************************************/
  window.handleLogout = async function(preserveCreds = true, keepCaptchaState = false) {
    group('handleLogout()', () => {
      log('logout params', { preserveCreds, keepCaptchaState, hasToken: hasToken() });
    });

    // sessionVersion++ï¼ˆä¸¥æ ¼ä¿ç•™è¯­ä¹‰ï¼‰
    uiStore.set(s => ({ ...s, sessionVersion: s.sessionVersion + 1 }));
    log('sessionVersion++ =>', uiStore.get().sessionVersion, '(reason: logout)');

    setToken('', 'logout');

    panelLoaded.schedule = panelLoaded.grades = panelLoaded.ecard = panelLoaded.user = false;

    if (!keepCaptchaState) {
      authStore.set(st => ({ ...st, requireCaptcha: false, sessionId: '' }));
      if ($('captcha')) $('captcha').value = '';
      toggleHidden($('captchaBlock'), true);
    } else {
      // ä¿ç•™/è¿›å…¥éªŒè¯ç æ€ï¼šåˆ·æ–°ä¸€å¼ æ–°çš„éªŒè¯ç å›¾
      authStore.set(st => ({ ...st, requireCaptcha: true, sessionId: '' }));
      if ($('captcha')) $('captcha').value = '';
      toggleHidden($('captchaBlock'), false);
      await fetchCaptchaSession({ forceShow: true, withSpinner: false });
    }

    showLogin();

    if (!preserveCreds) {
      clearCredentialsLocal();
      await clearCredentialsIndexedDB();
    }

    await loadSavedCredentialsToUI();
  };

  /*****************************************************************
   * 19) ç™»å½•å…¥å£ï¼ˆä¿æŒ HTML onclick=handleLoginï¼‰
   *****************************************************************/
  window.handleLogin = async function() {
    const u = $('username').value;
    const p = $('password').value;

    if (!u || !p) return alert('è¯·å¡«å†™å­¦å·å’Œå¯†ç ');

    // âœ… é¡ºåºè¦æ±‚ï¼šå…ˆç¡®ä¿ sessionId/éªŒè¯ç å›¾ï¼Œå†æ£€æŸ¥éªŒè¯ç è¾“å…¥
    await ensureCaptchaSession(authStore.get().requireCaptcha, false);

    const c = $('captcha')?.value;
    if (authStore.get().requireCaptcha && !c) return alert('è¯·è¾“å…¥éªŒè¯ç ');

    setLoginButtonDisabled(true);
    setLoading(true);

    try {
      // ç™»å½•äº’æ–¥é”ï¼ˆä¸¥æ ¼ä¿ç•™è¯­ä¹‰ï¼‰
      const s = authStore.get();
      if (!s.loginPromise) {
        const promise = (async () => performLogin(u, p, c, false, 0))()
          .finally(() => authStore.set(st => ({ ...st, loginPromise: null })));
        authStore.set(st => ({ ...st, loginPromise: promise }));
      } else {
        log('handleLogin: reuse loginPromise');
      }

      const ok = await authStore.get().loginPromise;
      if (!ok) return;

      showData();
      await loadAllData(false);
    } finally {
      setLoading(false);
      setLoginButtonDisabled(false);
    }
  };

  /*****************************************************************
   * 20) HTML onclick éœ€è¦æš´éœ²çš„åˆ·æ–°å…¥å£ï¼ˆä¿æŒä¸å˜ï¼‰
   *****************************************************************/
  window.initCaptcha = async function(forceShow = false, withSpinner = false) {
    await fetchCaptchaSession({ forceShow, withSpinner });
  };

  window.loadEcard = async function(refresh = false, withSpinner = true) {
    await loadEcard(!!refresh, withSpinner !== false);
  };

  window.loadSchedule = async function(refresh = false, withSpinner = true) {
    await loadSchedule(!!refresh, withSpinner !== false);
  };

  /*****************************************************************
   * 21) å¯åŠ¨ç­–ç•¥ï¼ˆä¸¥æ ¼ä¿ç•™ä½ åŸé€»è¾‘ï¼štoken æ¢æ´» -> autoLogin -> å¦åˆ™ç™»å½•é¡µï¼‰
   *****************************************************************/
  async function bootstrapWithToken() {
    group('bootstrapWithToken()', () => {});
    const sv = uiStore.get().sessionVersion;
    const av = authStore.get().authVersion;

    try {
      const json = await apiFetchJson('/api/user', { retry: true });
      if (sv !== uiStore.get().sessionVersion || av !== authStore.get().authVersion) {
        warn('bootstrapWithToken: stale response ignored');
        return false;
      }

      showData();
      renderUser(json.data);
      panelLoaded.user = true;

      await Promise.all([
        loadEcard(false, false),
        loadSchedule(false, false),
      ]);

      return true;
    } catch (e) {
      warn('bootstrapWithToken failed', e);

      if (authStore.get().requireCaptcha) {
        alert('è‡ªåŠ¨ç™»å½•éœ€è¦éªŒè¯ç ï¼Œè¯·åœ¨ç™»å½•é¡µè¾“å…¥éªŒè¯ç åç™»å½•');
        await window.handleLogout(true, true);
        return false;
      }

      alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      await window.handleLogout(true, false);
      return false;
    }
  }

  async function autoLoginOnLoad() {
    if (autoLoginAttempted) return false;
    autoLoginAttempted = true;

    const saved = await getSavedCredentials();
    if (!saved || !saved.username || !saved.password || saved.remember !== true) {
      log('autoLoginOnLoad skipped', { hasSaved: !!saved, remember: saved?.remember });
      return false;
    }

    log('autoLoginOnLoad start...');
    setLoading(true);
    try {
      const ok = await ensureRelogin('AUTO_ON_LOAD');
      if (!ok) {
        log('autoLoginOnLoad failed');
        return false;
      }

      showData();
      await loadAllData(false);
      log('autoLoginOnLoad success');
      return true;
    } finally {
      setLoading(false);
    }
  }

  async function appStart() {
    group('appStart()', () => {
      log('initial', { hasToken: hasToken(), authVersion: authStore.get().authVersion, sessionVersion: uiStore.get().sessionVersion });
    });

    setLoading(true);
    try {
      await loadSavedCredentialsToUI();

      if (hasToken()) {
        const ok = await bootstrapWithToken();
        if (ok) return;
      }

      const autoOk = await autoLoginOnLoad();
      if (autoOk) return;

      showLogin();
      log('appStart: stay on login');
    } finally {
      setLoading(false);
    }
  }

  /*****************************************************************
   * 22) å…¥å£ï¼šä¸å†ä¸»åŠ¨æ‹‰éªŒè¯ç ï¼ˆæŒ‰éœ€ï¼‰
   *****************************************************************/
  appStart();

})();
</script>

</body>
</html>
